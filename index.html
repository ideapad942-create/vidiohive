<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microstock</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: #1e1b4b; color: white; padding: 20px; font-weight: bold; }
        .controls { padding: 20px; border-bottom: 1px solid #e2e8f0; }
        .input-field { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        .btn { padding: 10px 20px; border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: 600; }
        .btn-primary { background: #6366f1; }
        .btn-success { background: #10b981; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f8fafc; padding: 10px; text-align: left; border-bottom: 2px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #e2e8f0; vertical-align: top; }
        
        .meta-input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; box-sizing: border-box; margin-bottom: 5px; font-family: inherit; }
        textarea.meta-input { height: 70px; resize: vertical; }
        
        .status-pill { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; display: inline-block; }
        .status-processing { background: #e0e7ff; color: #4338ca; }
        .status-success { background: #dcfce7; color: #15803d; }
        .status-error { background: #fee2e2; color: #b91c1c; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">Metadata Generator (SPOK Logic)</div>

    <div class="controls">
        <label style="font-size:12px; font-weight:bold;">API KEY GROQ:</label>
        <input type="password" id="apiKey" class="input-field" placeholder="gsk_...">
        <input type="file" id="fileInput" class="input-field" webkitdirectory directory multiple>
        <button class="btn btn-primary" id="btnProcess" onclick="startProcessing()">Mulai Proses</button>
        <button class="btn btn-success" id="btnExport" onclick="exportCSV()" style="display:none;">Download CSV</button>
    </div>
    
    <table id="resultTable">
        <thead>
            <tr>
                <th width="300">Preview</th>
                <th>Metadata</th>
            </tr>
        </thead>
        <tbody id="resultBody"></tbody>
    </table>
</div>

<video id="hiddenVideo" style="display:none;" muted playsinline></video>
<canvas id="hiddenCanvas" style="display:none;"></canvas>

<script>
    // --- DATABASE KATEGORI LENGKAP ---
    const CATEGORIES = [
        "backgrounds", "backgrounds/3d-object", "backgrounds/abstract", "backgrounds/cartoons", "backgrounds/corporate", "backgrounds/electric", "backgrounds/events", "backgrounds/fire", "backgrounds/grunge", "backgrounds/industrial", "backgrounds/kids", "backgrounds/light", "backgrounds/medical", "backgrounds/nature", "backgrounds/retro", "backgrounds/sky-clouds", "backgrounds/space", "backgrounds/sports", "backgrounds/technology", "backgrounds/water", "backgrounds/miscellaneous",
        "bugs", "bugs/3d-object", "bugs/abstract", "bugs/cartoons", "bugs/corporate", "bugs/electric", "bugs/events", "bugs/fire", "bugs/grunge", "bugs/industrial", "bugs/kids", "bugs/light", "bugs/medical", "bugs/nature", "bugs/retro", "bugs/sky-clouds", "bugs/space", "bugs/sports", "bugs/technology", "bugs/water", "bugs/miscellaneous",
        "distortions", "elements", "elements/3d-object", "elements/abstract", "elements/cartoons", "elements/corporate", "elements/electric", "elements/events", "elements/fire", "elements/grunge", "elements/industrial", "elements/kids", "elements/light", "elements/medical", "elements/nature", "elements/retro", "elements/sky-clouds", "elements/space", "elements/sports", "elements/technology", "elements/water", "elements/miscellaneous",
        "interface-effects", "interface-effects/3d-object", "interface-effects/abstract", "interface-effects/cartoons", "interface-effects/corporate", "interface-effects/electric", "interface-effects/events", "interface-effects/fire", "interface-effects/grunge", "interface-effects/industrial", "interface-effects/kids", "interface-effects/light", "interface-effects/medical", "interface-effects/nature", "interface-effects/retro", "interface-effects/sky-clouds", "interface-effects/space", "interface-effects/sports", "interface-effects/technology", "interface-effects/water", "interface-effects/miscellaneous",
        "lower-thirds", "lower-thirds/3d-object", "lower-thirds/abstract", "lower-thirds/cartoons", "lower-thirds/corporate", "lower-thirds/electric", "lower-thirds/events", "lower-thirds/fire", "lower-thirds/grunge", "lower-thirds/industrial", "lower-thirds/kids", "lower-thirds/light", "lower-thirds/medical", "lower-thirds/nature", "lower-thirds/retro", "lower-thirds/sky-clouds", "lower-thirds/space", "lower-thirds/sports", "lower-thirds/technology", "lower-thirds/water", "lower-thirds/miscellaneous",
        "overlays", "overlays/3d-object", "overlays/abstract", "overlays/cartoons", "overlays/corporate", "overlays/electric", "overlays/events", "overlays/fire", "overlays/grunge", "overlays/industrial", "overlays/kids", "overlays/light", "overlays/medical", "overlays/nature", "overlays/retro", "overlays/sky-clouds", "overlays/space", "overlays/sports", "overlays/technology", "overlays/water", "overlays/miscellaneous",
        "particles", "revealer", "revealer/3d-object", "revealer/abstract", "revealer/cartoons", "revealer/corporate", "revealer/electric", "revealer/events", "revealer/fire", "revealer/grunge", "revealer/industrial", "revealer/kids", "revealer/light", "revealer/medical", "revealer/nature", "revealer/retro", "revealer/sky-clouds", "revealer/space", "revealer/sports", "revealer/technology", "revealer/water", "revealer/miscellaneous",
        "transitions", "transitions/3d-object", "transitions/abstract", "transitions/cartoons", "transitions/corporate", "transitions/electric", "transitions/events", "transitions/fire", "transitions/grunge", "transitions/industrial", "transitions/kids", "transitions/light", "transitions/medical", "transitions/nature", "transitions/retro", "transitions/sky-clouds", "transitions/space", "transitions/sports", "transitions/technology", "transitions/water", "transitions/miscellaneous",
        "water-and-fluid", "miscellaneous", "miscellaneous/3d-object", "miscellaneous/abstract", "miscellaneous/cartoons", "miscellaneous/corporate", "miscellaneous/electric", "miscellaneous/events", "miscellaneous/fire", "miscellaneous/grunge", "miscellaneous/industrial", "miscellaneous/kids", "miscellaneous/light", "miscellaneous/medical", "miscellaneous/nature", "miscellaneous/retro", "miscellaneous/sky-clouds", "miscellaneous/space", "miscellaneous/sports", "miscellaneous/technology", "miscellaneous/water", "miscellaneous/miscellaneous", "infographics"
    ];

    const BACKUP_KEYWORDS = ["motion", "graphic", "abstract", "visual", "loop", "seamless", "animation", "digital", "design", "creative", "concept", "modern", "technology", "futuristic", "background", "overlay", "element", "dynamic", "glow", "energy", "clean", "smooth", "cinematic", "presentation", "display", "style", "artistic", "colorful", "bright", "soft", "sharp", "pattern", "texture", "geometry", "shapes", "line", "curve", "flow", "liquid", "tech", "data", "network", "cyber", "space", "science", "business", "corporate"];

    let fileQueue = [];
    if(localStorage.getItem('GROQ_KEY')) document.getElementById('apiKey').value = localStorage.getItem('GROQ_KEY');

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const files = Array.from(e.target.files).filter(f => f.type.startsWith('video/'));
        const tbody = document.getElementById('resultBody');
        tbody.innerHTML = '';
        fileQueue = [];
        
        files.forEach((file, index) => {
            fileQueue.push({ file, id: index });
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <div style="width:240px; height:135px; background:#eee; border-radius:8px; overflow:hidden; margin-bottom:5px;" id="preview-${index}"></div>
                    <div style="font-weight:bold; font-size:11px;">${file.name}</div>
                    <div id="status-${index}" class="status-pill">Pending</div>
                    <div id="cat-disp-${index}" style="font-size:10px; margin-top:5px; color:#666;">Category: -</div>
                    <input type="hidden" id="cat-${index}">
                </td>
                <td>
                    <div style="font-size:10px; font-weight:bold; margin-bottom:2px;">TITLE (50-70) <span id="len-title-${index}"></span></div>
                    <input type="text" class="meta-input" id="title-${index}" oninput="checkLen(${index})">
                    
                    <div style="font-size:10px; font-weight:bold; margin-bottom:2px;">DESCRIPTION (100-150) <span id="len-desc-${index}"></span></div>
                    <textarea class="meta-input" id="desc-${index}" oninput="checkLen(${index})"></textarea>
                    
                    <div style="font-size:10px; font-weight:bold; margin-bottom:2px;">KEYWORDS (45-48) <span id="len-kw-${index}"></span></div>
                    <textarea class="meta-input" id="kw-${index}" oninput="checkLen(${index})"></textarea>
                </td>
            `;
            tbody.appendChild(tr);
        });
    });

    function checkLen(idx) {
        const t = document.getElementById(`title-${idx}`).value.length;
        const d = document.getElementById(`desc-${idx}`).value.length;
        const k = document.getElementById(`kw-${idx}`).value.split(',').filter(x=>x.trim()).length;
        
        const tSpan = document.getElementById(`len-title-${idx}`);
        tSpan.innerText = t;
        tSpan.style.color = (t>=50 && t<=70) ? 'green' : 'red';
        
        const dSpan = document.getElementById(`len-desc-${idx}`);
        dSpan.innerText = d;
        dSpan.style.color = (d>=100 && d<=150) ? 'green' : 'red';

        const kSpan = document.getElementById(`len-kw-${idx}`);
        kSpan.innerText = k;
        kSpan.style.color = (k>=45 && k<=48) ? 'green' : 'red';
    }

    async function startProcessing() {
        const key = document.getElementById('apiKey').value;
        if(!key) return alert("API Key Kosong!");
        localStorage.setItem('GROQ_KEY', key);
        document.getElementById('btnProcess').disabled = true;

        for(let item of fileQueue) {
            const idx = item.id;
            updateStatus(idx, 'status-processing', 'Analyzing...');
            
            try {
                const base64 = await getFrame(item.file);
                document.getElementById(`preview-${idx}`).innerHTML = `<img src="${base64}" style="width:100%;">`;
                
                // --- PANGGILAN API NORMAL (TANPA JSON MODE AGAR TIDAK ERROR) ---
                const rawJson = await callApi(key, base64);
                
                // --- LOGIKA UTAMA (SPOK & RULES) ---
                
                // 1. TITLE Logic
                let title = (rawJson.title || "").trim();
                // Hapus kata sampah
                title = title.replace(/thanks for watching|video background|loop|seamless/gi, "").trim();
                // Pastikan huruf besar awal
                title = title.charAt(0).toUpperCase() + title.slice(1);
                // Potong rapi max 70
                if(title.length > 70) title = title.substring(0, 70).split(' ').slice(0, -1).join(' ');
                // Tambal jika kependekan (<50)
                if(title.length < 50) title = (title + " features abstract motion design elements for video").substring(0, 70);
                
                // 2. DESCRIPTION Logic
                let desc = (rawJson.description || "").trim();
                // Potong rapi max 150
                if(desc.length > 150) desc = desc.substring(0, 150).split(' ').slice(0, -1).join(' ');
                // Tambal jika kependekan (<100)
                if(desc.length < 100) desc = (desc + " This high quality visual asset is designed for professional video production and digital signage applications.").substring(0, 150);

                // 3. KEYWORDS Logic
                let kws = (rawJson.keywords || "").split(',').map(w => w.trim().toLowerCase()).filter(w => w.length > 2);
                kws = [...new Set(kws)]; // Hapus duplikat
                // Isi jika kurang dari 45
                let b = 0;
                while(kws.length < 45 && b < BACKUP_KEYWORDS.length) {
                    if(!kws.includes(BACKUP_KEYWORDS[b])) kws.push(BACKUP_KEYWORDS[b]);
                    b++;
                }
                
                // 4. CATEGORY Logic
                let cat = CATEGORIES.includes(rawJson.category) ? rawJson.category : "backgrounds";

                // --- MASUKKAN KE INPUT ---
                document.getElementById(`title-${idx}`).value = title;
                document.getElementById(`desc-${idx}`).value = desc;
                document.getElementById(`kw-${idx}`).value = kws.slice(0, 48).join(', '); // Ambil max 48
                document.getElementById(`cat-${idx}`).value = cat;
                document.getElementById(`cat-disp-${idx}`).innerText = "Cat: " + cat;

                updateStatus(idx, 'status-success', 'Done');
                checkLen(idx);

            } catch(e) {
                console.error(e);
                updateStatus(idx, 'status-error', 'Fail: ' + e.message);
            }
        }
        document.getElementById('btnProcess').disabled = false;
        document.getElementById('btnExport').style.display = 'inline-block';
    }

    async function callApi(key, base64) {
        // PROMPT DI SINI DIATUR AGAR HASILNYA SUDAH MENDEKATI SPOK
        const prompt = `Analyze this image. Return a raw JSON object (no markdown).
        {
            "category": "choose one from list: [${CATEGORIES.join(', ')}]",
            "title": "SPOK sentence (Subject Verb Object). Max 70 chars. Example: Abstract blue particles float in dark space.",
            "description": "SPOK sentence. Max 150 chars. Professional tone.",
            "keywords": "48 comma separated words"
        }`;

        const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
            body: JSON.stringify({
                model: "llama-3.2-11b-vision-preview", // Model Vision Standar
                messages: [
                    { role: "user", content: [
                        { type: "text", text: prompt },
                        { type: "image_url", image_url: { url: base64 } }
                    ]}
                ],
                temperature: 0.1,
                max_tokens: 300
            })
        });

        if(!resp.ok) throw new Error("API Error " + resp.status);
        const data = await resp.json();
        let txt = data.choices[0].message.content;
        
        // PEMBERSIH MANUAL (Agar tidak Bad Request karena format)
        txt = txt.replace(/```json/g, '').replace(/```/g, '').trim();
        const start = txt.indexOf('{');
        const end = txt.lastIndexOf('}');
        if(start === -1 || end === -1) throw new Error("Invalid JSON");
        
        return JSON.parse(txt.substring(start, end+1));
    }

    function updateStatus(idx, cls, txt) {
        const el = document.getElementById(`status-${idx}`);
        el.className = `status-pill ${cls}`;
        el.innerText = txt;
    }

    function getFrame(file) {
        return new Promise((resolve, reject) => {
            const v = document.getElementById('hiddenVideo');
            const c = document.getElementById('hiddenCanvas');
            const ctx = c.getContext('2d');
            
            v.src = URL.createObjectURL(file);
            v.onloadedmetadata = () => {
                v.currentTime = 1.0; // Ambil detik ke-1
            };
            v.onseeked = () => {
                c.width = 480; c.height = 270; // Resize agar ringan
                ctx.drawImage(v, 0, 0, c.width, c.height);
                resolve(c.toDataURL('image/jpeg', 0.6));
            };
            v.onerror = reject;
        });
    }

    function exportCSV() {
        let csv = "Filename,Title,Description,Keywords,Category\n";
        fileQueue.forEach(item => {
            const idx = item.id;
            const t = document.getElementById(`title-${idx}`).value.replace(/"/g, '""');
            const d = document.getElementById(`desc-${idx}`).value.replace(/"/g, '""');
            const k = document.getElementById(`kw-${idx}`).value.replace(/"/g, '""');
            const c = document.getElementById(`cat-${idx}`).value;
            csv += `"${item.file.name}","${t}","${d}","${k}","${c}"\n`;
        });
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "metadata_spok.csv";
        a.click();
    }
</script>

</body>
</html>
