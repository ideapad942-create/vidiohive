<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MICROSTOCK AI GENERATOR - LLAMA 4 UPDATED</title>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #1e293b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        h1 { margin-top: 0; color: var(--primary); font-size: 24px; display: flex; align-items: center; gap: 10px; }
        .tag-new { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; border: 1px solid #bbf7d0; }

        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        input[type="text"], input[type="password"] { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        
        .btn { background: var(--primary); color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.2s; }
        .btn:hover { background: #1d4ed8; }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }
        .btn-success { background: #16a34a; }
        .btn-success:hover { background: #15803d; }

        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 20px; font-size: 13px; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        th, td { padding: 12px; text-align: left; vertical-align: top; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; font-weight: 700; color: #475569; }
        tr:last-child td { border-bottom: none; }
        
        .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; display: inline-block; }
        .st-pending { background: #f1f5f9; color: #64748b; }
        .st-proc { background: #dbeafe; color: #1e40af; }
        .st-done { background: #dcfce7; color: #166534; }
        .st-error { background: #fee2e2; color: #991b1b; }

        .meta-input { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px; font-family: inherit; font-size: 13px; margin-bottom: 5px; transition: border 0.2s; }
        .meta-input:focus { border-color: var(--primary); outline: none; }
        textarea.meta-input { min-height: 70px; resize: vertical; }
        
        .char-count { font-size: 11px; color: #64748b; text-align: right; margin-bottom: 4px; font-weight: 500; }
        .preview-img { width: 100%; max-width: 200px; border-radius: 6px; border: 1px solid #e2e8f0; display: block; }
        .error-log { color: #dc2626; font-size: 11px; margin-top: 5px; display: none; background: #fef2f2; padding: 5px; border-radius: 4px; }
        
        /* Helper class for category dropdown suggestion if needed, currently text input */
    </style>
</head>
<body>

<div class="container">
    <h1>
        üéûÔ∏è MICROSTOCK METADATA AI 
        <span class="tag-new">Llama 4 Vision</span>
    </h1>
    
    <div class="input-group">
        <label>1. Masukkan API Key Groq</label>
        <input type="password" id="apiKey" placeholder="gsk_xxxxxxxxxxxxxxxxxxxxx">
        <small style="color: #64748b;">Menggunakan model baru: <b>meta-llama/llama-4-scout-17b-16e-instruct</b></small>
    </div>

    <div class="input-group">
        <label>2. Pilih Folder Video (Mp4/Mov)</label>
        <div style="display: flex; gap: 10px;">
            <input type="file" id="fileInput" webkitdirectory directory multiple style="flex:1;">
        </div>
    </div>

    <div class="input-group" style="display: flex; gap: 10px; align-items: center;">
        <button id="btnProcess" class="btn" onclick="startProcessing()">üöÄ Mulai Proses AI</button>
        <button id="btnExport" class="btn btn-success" onclick="exportCSV()" style="display:none;">üì• Download CSV</button>
        <div id="statusArea" style="font-weight:bold; color: var(--primary);"></div>
    </div>

    <table id="resultTable">
        <thead>
            <tr>
                <th style="width: 200px;">Preview (3 Frame)</th>
                <th style="width: 250px;">File & Category</th>
                <th>Metadata (Title, Desc, Keywords)</th>
                <th style="width: 100px;">Status</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<video id="hiddenVideo" style="display:none;" muted playsinline></video>
<canvas id="hiddenCanvas" style="display:none;"></canvas>

<script>
    // --- DATABASE CATEGORIES ---
    const CATEGORIES_LIST = `
backgrounds/3d-object, backgrounds/abstract, backgrounds/cartoons, backgrounds/corporate, backgrounds/electric, backgrounds/events, backgrounds/fire, backgrounds/grunge, backgrounds/industrial, backgrounds/kids, backgrounds/light, backgrounds/medical, backgrounds/nature, backgrounds/retro, backgrounds/sky-clouds, backgrounds/space, backgrounds/sports, backgrounds/technology, backgrounds/water, backgrounds/miscellaneous
bugs, bugs/3d-object, bugs/abstract, bugs/cartoons, bugs/corporate, bugs/electric, bugs/events, bugs/fire, bugs/grunge, bugs/industrial, bugs/kids, bugs/light, bugs/medical, bugs/nature, bugs/retro, bugs/sky-clouds, bugs/space, bugs/sports, bugs/technology, bugs/water, bugs/miscellaneous
distortions
elements, elements/3d-object, elements/abstract, elements/cartoons, elements/corporate, elements/electric, elements/events, elements/fire, elements/grunge, elements/industrial, elements/kids, elements/light, elements/medical, elements/nature, elements/retro, elements/sky-clouds, elements/space, elements/sports, elements/technology, elements/water, elements/miscellaneous
interface-effects, interface-effects/3d-object, interface-effects/abstract, interface-effects/cartoons, interface-effects/corporate, interface-effects/electric, interface-effects/events, interface-effects/fire, interface-effects/grunge, interface-effects/industrial, interface-effects/kids, interface-effects/light, interface-effects/medical, interface-effects/nature, interface-effects/retro, interface-effects/sky-clouds, interface-effects/space, interface-effects/sports, interface-effects/technology, interface-effects/water, interface-effects/miscellaneous
lower-thirds, lower-thirds/3d-object, lower-thirds/abstract, lower-thirds/cartoons, lower-thirds/corporate, lower-thirds/electric, lower-thirds/events, lower-thirds/fire, lower-thirds/grunge, lower-thirds/industrial, lower-thirds/kids, lower-thirds/light, lower-thirds/medical, lower-thirds/nature, lower-thirds/retro, lower-thirds/sky-clouds, lower-thirds/space, lower-thirds/sports, lower-thirds/technology, lower-thirds/water, lower-thirds/miscellaneous
overlays, overlays/3d-object, overlays/abstract, overlays/cartoons, overlays/corporate, overlays/electric, overlays/events, overlays/fire, overlays/grunge, overlays/industrial, overlays/kids, overlays/light, overlays/medical, overlays/nature, overlays/retro, overlays/sky-clouds, overlays/space, overlays/sports, overlays/technology, overlays/water, overlays/miscellaneous
particles
revealer, revealer/3d-object, revealer/abstract, revealer/cartoons, revealer/corporate, revealer/electric, revealer/events, revealer/fire, revealer/grunge, revealer/industrial, revealer/kids, revealer/light, revealer/medical, revealer/nature, revealer/retro, revealer/sky-clouds, revealer/space, revealer/sports, revealer/technology, revealer/water, revealer/miscellaneous
transitions, transitions/3d-object, transitions/abstract, transitions/cartoons, transitions/corporate, transitions/electric, transitions/events, transitions/fire, transitions/grunge, transitions/industrial, transitions/kids, transitions/light, transitions/medical, transitions/nature, transitions/retro, transitions/sky-clouds, transitions/space, transitions/sports, transitions/technology, transitions/water, transitions/miscellaneous
water-and-fluid
miscellaneous, miscellaneous/3d-object, miscellaneous/abstract, miscellaneous/cartoons, miscellaneous/corporate, miscellaneous/electric, miscellaneous/events, miscellaneous/fire, miscellaneous/grunge, miscellaneous/industrial, miscellaneous/kids, miscellaneous/light, miscellaneous/medical, miscellaneous/nature, miscellaneous/retro, miscellaneous/sky-clouds, miscellaneous/space, miscellaneous/sports, miscellaneous/technology, miscellaneous/water, miscellaneous/miscellaneous
infographics
    `;

    // --- MODEL BARU (UPDATED 2026) ---
    // Menggunakan Llama 4 Scout karena 3.2-90b sudah decommissioned
    const GROQ_MODEL = "meta-llama/llama-4-scout-17b-16e-instruct";

    let fileQueue = [];
    let isProcessing = false;

    // Load API Key
    if(localStorage.getItem('GROQ_KEY')) document.getElementById('apiKey').value = localStorage.getItem('GROQ_KEY');

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const files = Array.from(e.target.files).filter(f => f.type.startsWith('video/'));
        const tbody = document.querySelector('#resultTable tbody');
        tbody.innerHTML = '';
        fileQueue = [];

        if(files.length === 0) return alert("Tidak ada file video ditemukan.");

        files.forEach((file, index) => {
            fileQueue.push({ file, id: index, status: 'pending' });
            
            const tr = document.createElement('tr');
            tr.id = `row-${index}`;
            tr.innerHTML = `
                <td>
                    <div class="preview-placeholder" style="height:100px; background:#f1f5f9; display:flex; align-items:center; justify-content:center; color:#94a3b8; border-radius:6px; border:1px solid #e2e8f0;">
                        Waiting...
                    </div>
                </td>
                <td>
                    <div style="font-weight:bold; margin-bottom:5px; word-break:break-all;">${file.name}</div>
                    <label style="font-size:11px; color:#64748b; margin-bottom:2px;">CATEGORY</label>
                    <input type="text" class="meta-input cat-input" placeholder="Category..." readonly style="background:#f8fafc;">
                </td>
                <td>
                    <div class="char-count" id="cnt-title-${index}">Title: 0/70</div>
                    <input type="text" class="meta-input title-input" placeholder="Generating Title..." oninput="updateLen(${index}, 'title', 70)">
                    
                    <div class="char-count" id="cnt-desc-${index}">Desc: 0/150</div>
                    <textarea class="meta-input desc-input" placeholder="Generating Description..." oninput="updateLen(${index}, 'desc', 150)"></textarea>
                    
                    <div class="char-count" id="cnt-kw-${index}">Keywords: 0 (Min 45)</div>
                    <textarea class="meta-input kw-input" placeholder="Generating Keywords..." oninput="updateLen(${index}, 'kw', 0)"></textarea>
                    
                    <div class="error-log"></div>
                </td>
                <td style="vertical-align:middle;">
                    <span class="status-badge st-pending">PENDING</span>
                </td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('statusArea').innerText = `‚úÖ ${files.length} Video siap diproses.`;
    });

    function updateLen(idx, type, max) {
        const row = document.getElementById(`row-${idx}`);
        const el = row.querySelector(`.${type}-input`);
        const disp = document.getElementById(`cnt-${type}-${idx}`);
        
        if (type === 'kw') {
            const count = el.value.split(',').filter(w => w.trim().length > 0).length;
            disp.innerText = `Keywords: ${count} (Min 45)`;
        } else {
            disp.innerText = `${type === 'title' ? 'Title' : 'Desc'}: ${el.value.length}/${max}`;
            if (el.value.length > max) disp.style.color = "red";
            else disp.style.color = "#64748b";
        }
    }

    async function startProcessing() {
        const apiKey = document.getElementById('apiKey').value.trim();
        if(!apiKey) return alert("Masukkan API Key Groq dulu!");
        localStorage.setItem('GROQ_KEY', apiKey);

        if(isProcessing) return;
        isProcessing = true;
        document.getElementById('btnProcess').disabled = true;
        document.getElementById('statusArea').innerText = "‚è≥ Sedang Memproses...";

        for (const item of fileQueue) {
            const row = document.getElementById(`row-${item.id}`);
            const statusBadge = row.querySelector('.status-badge');
            const previewCell = row.cells[0];
            const errorLog = row.querySelector('.error-log');

            statusBadge.className = 'status-badge st-proc';
            statusBadge.innerText = 'SNAPSHOT';

            try {
                // 1. Ambil Snapshot 3 Frame
                const base64Img = await getFilmstrip(item.file);
                previewCell.innerHTML = `<img src="${base64Img}" class="preview-img">`;

                statusBadge.innerText = 'AI THINKING';
                
                // 2. Kirim ke Groq AI (Model Baru)
                const metadata = await analyzeWithAI(apiKey, base64Img);

                // 3. Isi Form dengan Validasi Character
                row.querySelector('.cat-input').value = metadata.category;
                
                // Title trim (Max 70)
                let finalTitle = metadata.title || "";
                if(finalTitle.length > 70) finalTitle = finalTitle.substring(0, 67) + "...";
                row.querySelector('.title-input').value = finalTitle;
                updateLen(item.id, 'title', 70);

                // Desc trim (Max 150)
                let finalDesc = metadata.description || "";
                if(finalDesc.length > 150) finalDesc = finalDesc.substring(0, 147) + "...";
                row.querySelector('.desc-input').value = finalDesc;
                updateLen(item.id, 'desc', 150);

                // Keywords Logic (Split single words & Deduplicate)
                let rawKw = (metadata.keywords || "").replace(/,\s*/g, ',').split(',');
                let cleanKw = [];
                rawKw.forEach(k => {
                    k = k.trim().toLowerCase();
                    if(k.includes(' ')) {
                        cleanKw.push(...k.split(' ')); // Pecah frase
                    } else {
                        cleanKw.push(k);
                    }
                });
                // Remove duplicates & empty strings & short words (optional)
                cleanKw = [...new Set(cleanKw)].filter(k => k.length > 1);
                row.querySelector('.kw-input').value = cleanKw.join(', ');
                updateLen(item.id, 'kw', 0);

                statusBadge.className = 'status-badge st-done';
                statusBadge.innerText = 'SUCCESS';

            } catch (err) {
                console.error(err);
                statusBadge.className = 'status-badge st-error';
                statusBadge.innerText = 'ERROR';
                errorLog.style.display = 'block';
                errorLog.innerText = err.message;
            }

            // Jeda sedikit agar tidak kena limit rate API (penting untuk akun free)
            await new Promise(resolve => setTimeout(resolve, 2000));
        }

        isProcessing = false;
        document.getElementById('btnProcess').disabled = false;
        document.getElementById('statusArea').innerText = "‚úÖ Proses Selesai!";
        document.getElementById('btnExport').style.display = 'inline-block';
        alert("Semua video selesai diproses!");
    }

    // --- FUNGSI SNAPSHOT (3 Frame) ---
    function getFilmstrip(file) {
        return new Promise((resolve, reject) => {
            const video = document.getElementById('hiddenVideo');
            const canvas = document.getElementById('hiddenCanvas');
            const ctx = canvas.getContext('2d');
            const url = URL.createObjectURL(file);

            video.src = url;
            video.muted = true;
            
            // Ukuran diperkecil agar tidak berat kirim ke API (Total 960x180)
            const w = 320, h = 180;
            canvas.width = w * 3;
            canvas.height = h;

            const snap = (time) => {
                return new Promise(res => {
                    video.currentTime = time;
                    video.onseeked = () => res();
                });
            };

            video.onloadedmetadata = async () => {
                try {
                    await snap(video.duration * 0.1);
                    ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, 0, 0, w, h);
                    
                    await snap(video.duration * 0.5);
                    ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, w, 0, w, h);
                    
                    await snap(video.duration * 0.9);
                    ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, w*2, 0, w, h);

                    const data = canvas.toDataURL('image/jpeg', 0.8);
                    URL.revokeObjectURL(url);
                    resolve(data);
                } catch(e) { reject(e); }
            };
            video.onerror = () => reject(new Error("Gagal load video (File corrupt/Codec tidak support)"));
        });
    }

    // --- FUNGSI AI (Robust JSON Parser) ---
    async function analyzeWithAI(key, base64) {
        const systemPrompt = `
        You are a Stock Footage Metadata Expert.
        
        TASK:
        1. Classify the video into ONE category from this list:
           [${CATEGORIES_LIST}]
        
        2. Create a TITLE (Max 70 chars). Concise, literal.
        
        3. Create a DESCRIPTION (Max 150 chars). Visual description.
        
        4. Create KEYWORDS (Min 45 words).
           - RULE: ONE WORD PER KEYWORD. No phrases. 
           - Example: "blue sky" -> "blue, sky".
           - Include colors, objects, style (bokeh, macro), concepts.

        OUTPUT FORMAT:
        Reply ONLY with valid JSON. Do NOT include markdown code blocks like \`\`\`json.
        {
            "category": "string",
            "title": "string",
            "description": "string",
            "keywords": "string"
        }
        `;

        try {
            const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: GROQ_MODEL, // Menggunakan Llama 4 Scout
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: [
                            { type: "text", text: "Generate strict JSON metadata." },
                            { type: "image_url", image_url: { url: base64 } }
                        ]}
                    ],
                    temperature: 0.1,
                    max_tokens: 1024,
                    response_format: { type: "json_object" } // Memaksa output JSON
                })
            });

            if (!resp.ok) {
                const errData = await resp.json();
                throw new Error(errData.error?.message || "API Error");
            }

            const data = await resp.json();
            let text = data.choices[0].message.content;

            // --- PEMBERSIH JSON (ANTI ERROR / HALLUCINATION) ---
            const firstBrace = text.indexOf('{');
            const lastBrace = text.lastIndexOf('}');

            if (firstBrace !== -1 && lastBrace !== -1) {
                const cleanJson = text.substring(firstBrace, lastBrace + 1);
                return JSON.parse(cleanJson);
            } else {
                throw new Error("AI tidak memberikan JSON valid.");
            }
        } catch (e) {
            console.error("AI/Network Error:", e);
            throw e;
        }
    }

    function exportCSV() {
        let csv = "Filename,Category,Title,Description,Keywords\n";
        
        const rows = document.querySelectorAll('#resultTable tbody tr');
        let hasData = false;

        rows.forEach((tr, index) => {
            if(!fileQueue[index]) return;
            const status = tr.querySelector('.status-badge').innerText;
            if(status !== 'SUCCESS') return; // Skip yang gagal/pending

            hasData = true;
            const filename = `"${fileQueue[index].file.name.replace(/"/g, '""')}"`;
            const cat = `"${tr.querySelector('.cat-input').value.replace(/"/g, '""')}"`;
            const title = `"${tr.querySelector('.title-input').value.replace(/"/g, '""')}"`;
            const desc = `"${tr.querySelector('.desc-input').value.replace(/"/g, '""')}"`;
            const kw = `"${tr.querySelector('.kw-input').value.replace(/"/g, '""')}"`;

            csv += `${filename},${cat},${title},${desc},${kw}\n`;
        });

        if (!hasData) return alert("Belum ada data sukses untuk diexport!");

        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `metadata_microstock_${Date.now()}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>

</body>
</html>
