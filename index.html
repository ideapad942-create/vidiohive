<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MICROSTOCK AI GENERATOR - FIXED</title>
    <style>
        :root { --primary: #2563eb; --bg: #f1f5f9; --text: #1e293b; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        
        h1 { margin-top: 0; color: var(--primary); }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input[type="text"], input[type="password"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        
        .btn { background: var(--primary); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }
        .btn-success { background: #16a34a; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; vertical-align: top; }
        th { background: #f8fafc; }
        
        .status-badge { padding: 3px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .st-pending { background: #e2e8f0; color: #64748b; }
        .st-proc { background: #dbeafe; color: #1e40af; }
        .st-done { background: #dcfce7; color: #166534; }
        .st-error { background: #fee2e2; color: #991b1b; }

        .meta-input { width: 100%; box-sizing: border-box; padding: 5px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 12px; }
        textarea.meta-input { height: 60px; resize: vertical; }
        
        .char-count { font-size: 10px; color: #64748b; text-align: right; margin-bottom: 2px; }
        .preview-img { width: 150px; border-radius: 4px; border: 1px solid #ddd; }
        .error-log { color: red; font-size: 11px; margin-top: 5px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>üéûÔ∏è MICROSTOCK METADATA FIX</h1>
    
    <div class="input-group">
        <label>1. Masukkan API Key Groq (Llama Vision)</label>
        <input type="password" id="apiKey" placeholder="gsk_xxxxxxxxxxxxxxxxxxxxx">
    </div>

    <div class="input-group">
        <label>2. Pilih Folder Video (Mp4/Mov)</label>
        <input type="file" id="fileInput" webkitdirectory directory multiple>
    </div>

    <div class="input-group">
        <button id="btnProcess" class="btn" onclick="startProcessing()">üöÄ Mulai Proses AI</button>
        <button id="btnExport" class="btn btn-success" onclick="exportCSV()" style="display:none; margin-left: 10px;">üì• Download CSV</button>
    </div>

    <div id="statusArea" style="margin-bottom:10px; font-weight:bold;"></div>

    <table id="resultTable">
        <thead>
            <tr>
                <th style="width: 160px;">Preview (3 Frame)</th>
                <th style="width: 150px;">File & Category</th>
                <th>Metadata (Title, Desc, Keywords)</th>
                <th style="width: 80px;">Status</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<video id="hiddenVideo" style="display:none;" muted playsinline></video>
<canvas id="hiddenCanvas" style="display:none;"></canvas>

<script>
    // --- DATABASE CATEGORIES ---
    const CATEGORIES_LIST = `
backgrounds/3d-object, backgrounds/abstract, backgrounds/cartoons, backgrounds/corporate, backgrounds/electric, backgrounds/events, backgrounds/fire, backgrounds/grunge, backgrounds/industrial, backgrounds/kids, backgrounds/light, backgrounds/medical, backgrounds/nature, backgrounds/retro, backgrounds/sky-clouds, backgrounds/space, backgrounds/sports, backgrounds/technology, backgrounds/water, backgrounds/miscellaneous
bugs, bugs/3d-object, bugs/abstract, bugs/cartoons, bugs/corporate, bugs/electric, bugs/events, bugs/fire, bugs/grunge, bugs/industrial, bugs/kids, bugs/light, bugs/medical, bugs/nature, bugs/retro, bugs/sky-clouds, bugs/space, bugs/sports, bugs/technology, bugs/water, bugs/miscellaneous
distortions
elements, elements/3d-object, elements/abstract, elements/cartoons, elements/corporate, elements/electric, elements/events, elements/fire, elements/grunge, elements/industrial, elements/kids, elements/light, elements/medical, elements/nature, elements/retro, elements/sky-clouds, elements/space, elements/sports, elements/technology, elements/water, elements/miscellaneous
interface-effects, interface-effects/3d-object, interface-effects/abstract, interface-effects/cartoons, interface-effects/corporate, interface-effects/electric, interface-effects/events, interface-effects/fire, interface-effects/grunge, interface-effects/industrial, interface-effects/kids, interface-effects/light, interface-effects/medical, interface-effects/nature, interface-effects/retro, interface-effects/sky-clouds, interface-effects/space, interface-effects/sports, interface-effects/technology, interface-effects/water, interface-effects/miscellaneous
lower-thirds, lower-thirds/3d-object, lower-thirds/abstract, lower-thirds/cartoons, lower-thirds/corporate, lower-thirds/electric, lower-thirds/events, lower-thirds/fire, lower-thirds/grunge, lower-thirds/industrial, lower-thirds/kids, lower-thirds/light, lower-thirds/medical, lower-thirds/nature, lower-thirds/retro, lower-thirds/sky-clouds, lower-thirds/space, lower-thirds/sports, lower-thirds/technology, lower-thirds/water, lower-thirds/miscellaneous
overlays, overlays/3d-object, overlays/abstract, overlays/cartoons, overlays/corporate, overlays/electric, overlays/events, overlays/fire, overlays/grunge, overlays/industrial, overlays/kids, overlays/light, overlays/medical, overlays/nature, overlays/retro, overlays/sky-clouds, overlays/space, overlays/sports, overlays/technology, overlays/water, overlays/miscellaneous
particles
revealer, revealer/3d-object, revealer/abstract, revealer/cartoons, revealer/corporate, revealer/electric, revealer/events, revealer/fire, revealer/grunge, revealer/industrial, revealer/kids, revealer/light, revealer/medical, revealer/nature, revealer/retro, revealer/sky-clouds, revealer/space, revealer/sports, revealer/technology, revealer/water, revealer/miscellaneous
transitions, transitions/3d-object, transitions/abstract, transitions/cartoons, transitions/corporate, transitions/electric, transitions/events, transitions/fire, transitions/grunge, transitions/industrial, transitions/kids, transitions/light, transitions/medical, transitions/nature, transitions/retro, transitions/sky-clouds, transitions/space, transitions/sports, transitions/technology, transitions/water, transitions/miscellaneous
water-and-fluid
miscellaneous, miscellaneous/3d-object, miscellaneous/abstract, miscellaneous/cartoons, miscellaneous/corporate, miscellaneous/electric, miscellaneous/events, miscellaneous/fire, miscellaneous/grunge, miscellaneous/industrial, miscellaneous/kids, miscellaneous/light, miscellaneous/medical, miscellaneous/nature, miscellaneous/retro, miscellaneous/sky-clouds, miscellaneous/space, miscellaneous/sports, miscellaneous/technology, miscellaneous/water, miscellaneous/miscellaneous
infographics
    `;

    let fileQueue = [];
    let isProcessing = false;

    // Load API Key
    if(localStorage.getItem('GROQ_KEY')) document.getElementById('apiKey').value = localStorage.getItem('GROQ_KEY');

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const files = Array.from(e.target.files).filter(f => f.type.startsWith('video/'));
        const tbody = document.querySelector('#resultTable tbody');
        tbody.innerHTML = '';
        fileQueue = [];

        files.forEach((file, index) => {
            fileQueue.push({ file, id: index, status: 'pending' });
            
            const tr = document.createElement('tr');
            tr.id = `row-${index}`;
            tr.innerHTML = `
                <td><div style="height:50px; background:#f1f5f9; text-align:center; padding-top:20px;">Waiting...</div></td>
                <td>
                    <b>${file.name}</b><br>
                    <input type="text" class="meta-input cat-input" placeholder="Category..." readonly>
                </td>
                <td>
                    <div class="char-count">Title: 0/70</div>
                    <input type="text" class="meta-input title-input" placeholder="Generating Title...">
                    
                    <div class="char-count">Desc: 0/150</div>
                    <textarea class="meta-input desc-input" placeholder="Generating Description..."></textarea>
                    
                    <div class="char-count">Keywords: 0 (Min 45)</div>
                    <textarea class="meta-input kw-input" placeholder="Generating Keywords..."></textarea>
                    <div class="error-log"></div>
                </td>
                <td><span class="status-badge st-pending">PENDING</span></td>
            `;
            tbody.appendChild(tr);
        });

        document.getElementById('statusArea').innerText = `‚úÖ ${files.length} Video siap diproses.`;
    });

    async function startProcessing() {
        const apiKey = document.getElementById('apiKey').value;
        if(!apiKey) return alert("Masukkan API Key dulu!");
        localStorage.setItem('GROQ_KEY', apiKey);

        if(isProcessing) return;
        isProcessing = true;
        document.getElementById('btnProcess').disabled = true;

        for (const item of fileQueue) {
            const row = document.getElementById(`row-${item.id}`);
            const statusBadge = row.querySelector('.status-badge');
            const previewCell = row.cells[0];
            const errorLog = row.querySelector('.error-log');

            statusBadge.className = 'status-badge st-proc';
            statusBadge.innerText = 'SNAPSHOT';

            try {
                // 1. Ambil Snapshot 3 Frame
                const base64Img = await getFilmstrip(item.file);
                previewCell.innerHTML = `<img src="${base64Img}" class="preview-img">`;

                statusBadge.innerText = 'AI THINKING';
                
                // 2. Kirim ke Groq AI
                const metadata = await analyzeWithAI(apiKey, base64Img);

                // 3. Isi Form dengan Validasi Character
                row.querySelector('.cat-input').value = metadata.category;
                
                // Title trim
                const finalTitle = metadata.title.length > 70 ? metadata.title.substring(0, 67) + "..." : metadata.title;
                row.querySelector('.title-input').value = finalTitle;

                // Desc trim
                const finalDesc = metadata.description.length > 150 ? metadata.description.substring(0, 147) + "..." : metadata.description;
                row.querySelector('.desc-input').value = finalDesc;

                // Keywords Logic (Split single words)
                let rawKw = metadata.keywords.replace(/,\s*/g, ',').split(',');
                let cleanKw = [];
                rawKw.forEach(k => {
                    // Pecah jika ada spasi (film burn -> film, burn)
                    if(k.includes(' ')) {
                        cleanKw.push(...k.split(' '));
                    } else {
                        cleanKw.push(k);
                    }
                });
                // Remove duplicates & empty
                cleanKw = [...new Set(cleanKw)].filter(k => k.length > 1);
                row.querySelector('.kw-input').value = cleanKw.join(', ');

                statusBadge.className = 'status-badge st-done';
                statusBadge.innerText = 'SUCCESS';

            } catch (err) {
                console.error(err);
                statusBadge.className = 'status-badge st-error';
                statusBadge.innerText = 'ERROR';
                errorLog.style.display = 'block';
                errorLog.innerText = err.message;
            }

            // Jeda 2 detik agar tidak kena limit rate API
            await new Promise(resolve => setTimeout(resolve, 2000));
        }

        isProcessing = false;
        document.getElementById('btnProcess').disabled = false;
        document.getElementById('btnExport').style.display = 'inline-block';
        alert("Proses Selesai!");
    }

    // --- FUNGSI SNAPSHOT (3 Frame) ---
    function getFilmstrip(file) {
        return new Promise((resolve, reject) => {
            const video = document.getElementById('hiddenVideo');
            const canvas = document.getElementById('hiddenCanvas');
            const ctx = canvas.getContext('2d');
            const url = URL.createObjectURL(file);

            video.src = url;
            video.muted = true;
            
            // Ukuran diperkecil agar tidak berat kirim ke API (Total 960x180)
            const w = 320, h = 180;
            canvas.width = w * 3;
            canvas.height = h;

            const snap = (time) => {
                return new Promise(res => {
                    video.currentTime = time;
                    video.onseeked = () => res();
                });
            };

            video.onloadedmetadata = async () => {
                try {
                    await snap(video.duration * 0.1);
                    ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, 0, 0, w, h);
                    
                    await snap(video.duration * 0.5);
                    ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, w, 0, w, h);
                    
                    await snap(video.duration * 0.9);
                    ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, w*2, 0, w, h);

                    const data = canvas.toDataURL('image/jpeg', 0.8);
                    URL.revokeObjectURL(url);
                    resolve(data);
                } catch(e) { reject(e); }
            };
            video.onerror = () => reject(new Error("Gagal load video"));
        });
    }

    // --- FUNGSI AI (Robust JSON Parser) ---
    async function analyzeWithAI(key, base64) {
        const systemPrompt = `
        You are a Stock Footage Metadata Expert.
        
        TASK:
        1. Classify the video into ONE category from this list:
           [${CATEGORIES_LIST}]
        
        2. Create a TITLE (Max 70 chars). Concise, literal.
        
        3. Create a DESCRIPTION (Max 150 chars). Visual description.
        
        4. Create KEYWORDS (Min 45 words).
           - RULE: ONE WORD PER KEYWORD. No phrases. 
           - Example: "blue sky" -> "blue, sky".
           - Include colors, objects, style (bokeh, macro), concepts.

        OUTPUT FORMAT:
        Reply ONLY with valid JSON. No markdown, no "Here is the json".
        {
            "category": "string",
            "title": "string",
            "description": "string",
            "keywords": "string"
        }
        `;

        const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
            body: JSON.stringify({
                model: "llama-3.2-90b-vision-preview",
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: [
                        { type: "text", text: "Generate strict JSON metadata." },
                        { type: "image_url", image_url: { url: base64 } }
                    ]}
                ],
                temperature: 0.1,
                max_tokens: 1024
            })
        });

        const data = await resp.json();
        if(data.error) throw new Error(data.error.message);

        let text = data.choices[0].message.content;

        // --- PEMBERSIH JSON (ANTI ERROR) ---
        // Mencari kurung kurawal pertama { dan terakhir }
        const firstBrace = text.indexOf('{');
        const lastBrace = text.lastIndexOf('}');

        if (firstBrace !== -1 && lastBrace !== -1) {
            const cleanJson = text.substring(firstBrace, lastBrace + 1);
            try {
                return JSON.parse(cleanJson);
            } catch (e) {
                console.log("Raw Text AI:", text);
                throw new Error("AI membalas tapi format JSON rusak.");
            }
        } else {
            throw new Error("AI tidak memberikan JSON valid.");
        }
    }

    function exportCSV() {
        let csv = "Filename,Category,Title,Description,Keywords\n";
        
        const rows = document.querySelectorAll('#resultTable tbody tr');
        rows.forEach((tr, index) => {
            if(!fileQueue[index]) return;
            
            const filename = `"${fileQueue[index].file.name.replace(/"/g, '""')}"`;
            const cat = `"${tr.querySelector('.cat-input').value.replace(/"/g, '""')}"`;
            const title = `"${tr.querySelector('.title-input').value.replace(/"/g, '""')}"`;
            const desc = `"${tr.querySelector('.desc-input').value.replace(/"/g, '""')}"`;
            const kw = `"${tr.querySelector('.kw-input').value.replace(/"/g, '""')}"`;

            csv += `${filename},${cat},${title},${desc},${kw}\n`;
        });

        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `metadata_stock_${Date.now()}.csv`;
        a.click();
    }
</script>

</body>
</html>
