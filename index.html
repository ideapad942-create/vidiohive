<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microstock Metadata</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #0ea5e9; --bg: #f1f5f9; --surface: #ffffff; --border: #e2e8f0; --text: #0f172a; --success: #10b981; --error: #ef4444; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .container { max-width: 1400px; margin: 0 auto; background: var(--surface); border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border: 1px solid var(--border); overflow: hidden; }
        
        .header { 
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); 
            color: white; 
            padding: 25px 30px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 4px solid var(--secondary); 
        }

        .header h1 { margin: 0; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .badge-pro { background: var(--secondary); font-size: 10px; padding: 3px 8px; border-radius: 20px; text-transform: uppercase; font-weight: 800; }
        
        .animated-subtitle {
            font-size: 13px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: linear-gradient(90deg, #fbbf24, #f59e0b, #fff, #fbbf24);
            background-size: 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 3s infinite linear;
        }

        @keyframes shine { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }

        .controls { padding: 25px; border-bottom: 1px solid var(--border); background: #f8fafc; }
        .api-box { display: grid; grid-template-columns: 1fr 1fr auto; gap: 20px; margin-bottom: 20px; align-items: end; background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .input-group label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 8px; color: #64748b; text-transform: uppercase; }
        .input-field { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 13px; box-sizing: border-box; }
        .action-area { display: flex; gap: 15px; align-items: center; margin-top: 15px; }
        
        .btn { padding: 0 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; transition: 0.2s; height: 48px; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); } 
        .btn-success { background: var(--success); } 
        .btn-save { background: #334155; height: 45px; }
        .btn-reset { background: #f59e0b; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        thead { display: none; }
        
        td { padding: 25px 20px; border-bottom: 1px solid var(--border); vertical-align: top; }
        .meta-wrapper { position: relative; margin-bottom: 20px; }
        .meta-label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 6px; font-weight: 700; color: #475569; }
        .meta-input { width: 100%; box-sizing: border-box; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; background: #fff; line-height: 1.6; }
        textarea.meta-input { min-height: 80px; resize: vertical; }
        .count-ok { color: #15803d; background: #dcfce7; padding: 2px 8px; border-radius: 4px; }
        .count-err { color: #b91c1c; background: #fee2e2; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .preview-box { width: 280px; border-radius: 10px; overflow: hidden; border: 1px solid var(--border); background: #000; }
        .preview-box img { width: 100%; display: block; }
        .cat-badge { display: inline-block; background: #e0f2fe; color: #0369a1; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; margin-top: 10px; width: 100%; box-sizing: border-box; text-align: center; }
        .status-pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; margin-top: 10px; }
        .status-pill.processing { background: #e0e7ff; color: #4338ca; } 
        .status-pill.success { background: #dcfce7; color: #15803d; } 
        .status-pill.error { background: #fee2e2; color: #b91c1c; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>üéûÔ∏è Metadata Generator <span class="badge-pro">V6 Motion Pro</span></h1>
            <div class="animated-subtitle">‚ú® VIDEOHIVE PROJECT ‚ú®</div>
        </div>

        <div class="controls">
            <div class="api-box">
                <div class="input-group">
                    <label>üîë API Key 1</label>
                    <input type="password" id="apiKey1" class="input-field" placeholder="gsk_...">
                </div>
                <div class="input-group">
                    <label>üîë API Key 2</label>
                    <input type="password" id="apiKey2" class="input-field" placeholder="gsk_...">
                </div>
                <button class="btn btn-save" onclick="manualSaveKeys()">üíæ Simpan</button>
            </div>
            <div class="input-group">
                <label>üìÇ Pilih Folder Video</label>
                <input type="file" id="fileInput" class="input-field" webkitdirectory directory multiple accept="video/*, .mkv, .flv, .avi, .mov, .wmv, .webm, .m4v, .3gp, .mpeg, .mpg" style="background: white;">
            </div>
            <div class="action-area">
                <button class="btn btn-primary" id="btnProcess" onclick="startProcessing()">üöÄ Mulai Proses</button>
                <button class="btn btn-success" id="btnExport" onclick="exportCSV()" style="display:none;">üì• Download CSV</button>
                <button class="btn btn-reset" id="btnReset" onclick="resetApp()" style="display:none;">üîÑ Upload Lagi</button>
            </div>
        </div>

        <table>
            <tbody id="resultBody"></tbody>
        </table>
    </div>

    <video id="hiddenVideo" style="display:none;" muted playsinline preload="auto"></video>
    <canvas id="hiddenCanvas" style="display:none;"></canvas>

    <script>
        const ALL_CATEGORIES = [
            "backgrounds", "backgrounds/3d-object", "backgrounds/abstract", "backgrounds/cartoons", "backgrounds/corporate", "backgrounds/electric", "backgrounds/events", "backgrounds/fire", "backgrounds/grunge", "backgrounds/industrial", "backgrounds/kids", "backgrounds/light", "backgrounds/medical", "backgrounds/nature", "backgrounds/retro", "backgrounds/sky-clouds", "backgrounds/space", "backgrounds/sports", "backgrounds/technology", "backgrounds/water", "backgrounds/miscellaneous",
            "bugs", "bugs/3d-object", "bugs/abstract", "bugs/cartoons", "bugs/corporate", "bugs/electric", "bugs/events", "bugs/fire", "bugs/grunge", "bugs/industrial", "bugs/kids", "bugs/light", "bugs/medical", "bugs/nature", "bugs/retro", "bugs/sky-clouds", "bugs/space", "bugs/sports", "bugs/technology", "bugs/water", "bugs/miscellaneous",
            "distortions", "elements", "elements/3d-object", "elements/abstract", "elements/cartoons", "elements/corporate", "elements/electric", "elements/events", "elements/fire", "elements/grunge", "elements/industrial", "elements/kids", "elements/light", "elements/medical", "elements/nature", "elements/retro", "elements/sky-clouds", "elements/space", "elements/sports", "elements/technology", "elements/water", "elements/miscellaneous",
            "interface-effects", "interface-effects/3d-object", "interface-effects/abstract", "interface-effects/cartoons", "interface-effects/corporate", "interface-effects/electric", "interface-effects/events", "interface-effects/fire", "interface-effects/grunge", "interface-effects/industrial", "interface-effects/kids", "interface-effects/light", "interface-effects/medical", "interface-effects/nature", "interface-effects/retro", "interface-effects/sky-clouds", "interface-effects/space", "interface-effects/sports", "interface-effects/technology", "interface-effects/water", "interface-effects/miscellaneous",
            "lower-thirds", "lower-thirds/3d-object", "lower-thirds/abstract", "lower-thirds/cartoons", "lower-thirds/corporate", "lower-thirds/electric", "lower-thirds/events", "lower-thirds/fire", "lower-thirds/grunge", "lower-thirds/industrial", "lower-thirds/kids", "lower-thirds/light", "lower-thirds/medical", "lower-thirds/nature", "lower-thirds/retro", "lower-thirds/sky-clouds", "lower-thirds/space", "lower-thirds/sports", "lower-thirds/technology", "lower-thirds/water", "lower-thirds/miscellaneous",
            "overlays", "overlays/3d-object", "overlays/abstract", "overlays/cartoons", "overlays/corporate", "overlays/electric", "overlays/events", "overlays/fire", "overlays/grunge", "overlays/industrial", "overlays/kids", "overlays/light", "overlays/medical", "overlays/nature", "overlays/retro", "overlays/sky-clouds", "overlays/space", "overlays/sports", "overlays/technology", "overlays/water", "overlays/miscellaneous",
            "particles", "revealer", "revealer/3d-object", "revealer/abstract", "revealer/cartoons", "revealer/corporate", "revealer/electric", "revealer/events", "revealer/fire", "revealer/grunge", "revealer/industrial", "revealer/kids", "revealer/light", "revealer/medical", "revealer/nature", "revealer/retro", "revealer/sky-clouds", "revealer/space", "revealer/sports", "revealer/technology", "revealer/water", "revealer/miscellaneous",
            "transitions", "transitions/3d-object", "transitions/abstract", "transitions/cartoons", "transitions/corporate", "transitions/electric", "transitions/events", "transitions/fire", "transitions/grunge", "transitions/industrial", "transitions/kids", "transitions/light", "transitions/medical", "transitions/nature", "transitions/retro", "transitions/sky-clouds", "transitions/space", "transitions/sports", "transitions/technology", "transitions/water", "transitions/miscellaneous",
            "water-and-fluid", "miscellaneous", "miscellaneous/3d-object", "miscellaneous/abstract", "miscellaneous/cartoons", "miscellaneous/corporate", "miscellaneous/electric", "miscellaneous/events", "miscellaneous/fire", "miscellaneous/grunge", "miscellaneous/industrial", "miscellaneous/kids", "miscellaneous/light", "miscellaneous/medical", "miscellaneous/nature", "miscellaneous/retro", "miscellaneous/sky-clouds", "miscellaneous/space", "miscellaneous/sports", "miscellaneous/technology", "miscellaneous/water", "miscellaneous/miscellaneous", "infographics"
        ];

        const BACKUP_KEYWORDS = ["video", "clip", "footage", "animation", "motion", "graphic", "render", "digital", "art", "design", "background", "loop", "seamless", "abstract", "creative", "concept", "modern", "futuristic", "style", "effect", "visual", "display", "presentation", "backdrop", "wallpaper", "texture", "pattern", "shape", "color", "light", "bright", "dark", "glow", "shine", "energy", "power", "tech", "technology", "cyber", "space", "business", "corporate", "event", "show", "broadcast"];

        const STOP_WORDS = ["for", "and", "the", "with", "in", "on", "at", "to", "a", "an", "is", "of", "it", "this", "that", "image", "photo", "picture", "video", "clip", "saying", "reads", "showing"];

        const GROQ_MODEL = "meta-llama/llama-4-scout-17b-16e-instruct";

        let fileQueue = [];
        let apiKeys = [];
        let currentKeyIndex = 0;

        if (localStorage.getItem('API_KEY_1')) document.getElementById('apiKey1').value = localStorage.getItem('API_KEY_1');
        if (localStorage.getItem('API_KEY_2')) document.getElementById('apiKey2').value = localStorage.getItem('API_KEY_2');

        function manualSaveKeys() {
            localStorage.setItem('API_KEY_1', document.getElementById('apiKey1').value.trim());
            localStorage.setItem('API_KEY_2', document.getElementById('apiKey2').value.trim());
            alert("Simpan Berhasil!");
        }

        function resetApp() {
            fileQueue = [];
            document.getElementById('resultBody').innerHTML = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('btnExport').style.display = 'none';
            document.getElementById('btnReset').style.display = 'none';
            document.getElementById('btnProcess').disabled = false;
        }

        document.getElementById('fileInput').addEventListener('change', function (e) {
            const videoExts = ['.mp4', '.mov', '.avi', '.mkv', '.flv', '.wmv', '.webm', '.m4v', '.3gp', '.mpeg', '.mpg'];
            const files = Array.from(e.target.files).filter(f => {
                const ext = f.name.substring(f.name.lastIndexOf('.')).toLowerCase();
                return f.type.startsWith('video/') || videoExts.includes(ext);
            });
            const tbody = document.getElementById('resultBody');
            tbody.innerHTML = '';
            fileQueue = [];
            files.forEach((file, index) => {
                fileQueue.push({ file, id: index });
                const tr = document.createElement('tr');
                tr.innerHTML = `<td><div class="preview-box" id="preview-${index}"><div style="height:140px; background:#eee;"></div></div><div style="font-weight:600; font-size:12px; margin-top:10px;">${file.name}</div><div class="cat-badge" id="cat-disp-${index}">Category: -</div><div class="status-pill" id="status-pill-${index}">‚ö´ <span id="status-text-${index}">Pending</span></div><input type="hidden" id="cat-${index}"></td><td><div class="meta-wrapper"><div class="meta-label"><span>TITLE (70-90 Chars)</span><span id="cnt-title-${index}">0</span></div><input type="text" class="meta-input" id="title-${index}" oninput="validate(${index})"></div><div class="meta-wrapper"><div class="meta-label"><span>DESC (100-150)</span><span id="cnt-desc-${index}">0/150</span></div><textarea class="meta-input" id="desc-${index}" oninput="validate(${index})"></textarea></div><div class="meta-wrapper"><div class="meta-label"><span>KEYWORDS (Min 45 Words)</span><span id="cnt-kw-${index}">0 words</span></div><textarea class="meta-input" id="kw-${index}" oninput="validate(${index})"></textarea></div></td>`;
                tbody.appendChild(tr);
            });
        });

        function validate(idx) {
            const t = document.getElementById(`title-${idx}`).value.length;
            const d = document.getElementById(`desc-${idx}`).value.length;
            const kVal = document.getElementById(`kw-${idx}`).value;
            const k = kVal ? kVal.split(',').filter(x => x.trim()).length : 0;
            document.getElementById(`cnt-title-${idx}`).innerText = `${t} chars`;
            document.getElementById(`cnt-title-${idx}`).className = (t < 70 || t > 90) ? 'count-err' : 'count-ok';
            document.getElementById(`cnt-desc-${idx}`).innerText = `${d}/150`;
            document.getElementById(`cnt-desc-${idx}`).className = (d < 100 || d > 150) ? 'count-err' : 'count-ok';
            document.getElementById(`cnt-kw-${idx}`).innerText = `${k} words`;
            document.getElementById(`cnt-kw-${idx}`).className = (k < 45) ? 'count-err' : 'count-ok';
        }

        function smartTrim(str, min, max) {
            str = str.replace(/['":;,.!?-]/g, '').trim(); 
            if (str.length >= min && str.length <= max) return str;
            if (str.length > max) {
                let trimmed = str.substring(0, max);
                return trimmed.substring(0, trimmed.lastIndexOf(" ")).trim();
            }
            return str;
        }

        function cleanTrailing(str) {
            return str.trim().replace(/[\s,]+(and|or|with|the|a|an|is|at|of|in|to|for)[\s,.]*$/i, "").replace(/[,\s]+$/, "");
        }

        // FUNGSI SNAPSHOT MAKSIMAL UNTUK SEMUA FORMAT (TERMASUK .MOV)
        function getFilmstrip(file) {
            return new Promise((resolve) => {
                const v = document.getElementById('hiddenVideo');
                const c = document.getElementById('hiddenCanvas');
                const ctx = c.getContext('2d');
                
                const createInfoCard = () => {
                    c.width = 960;
                    c.height = 180;
                    ctx.fillStyle = "#ffffff";
                    ctx.fillRect(0, 0, 960, 180);
                    ctx.fillStyle = "#000000";
                    ctx.font = "bold 24px Inter";
                    ctx.textAlign = "center";
                    ctx.fillText("VIDEO FILE: " + file.name, 480, 90);
                    ctx.font = "16px Inter";
                    ctx.fillStyle = "#555555";
                    ctx.fillText("(Visual Not Supported - Analyze Filename)", 480, 120);
                    resolve(c.toDataURL('image/jpeg'));
                };

                const timeout = setTimeout(createInfoCard, 5000); // 5 Detik timeout untuk .mov berat

                v.oncanplay = async () => {
                    clearTimeout(timeout);
                    try {
                        c.width = 960;
                        c.height = 180;
                        
                        // Nudge Video: Putar sebentar agar decoder aktif (Penting untuk .mov)
                        v.play();
                        await new Promise(r => setTimeout(r, 100));
                        v.pause();

                        for (let i = 0; i < 3; i++) {
                            v.currentTime = v.duration * (0.1 + i * 0.4); 
                            await new Promise(r => v.onseeked = r); 
                            ctx.drawImage(v, 0, 0, v.videoWidth, v.videoHeight, i * 320, 0, 320, 180);
                        }
                        resolve(c.toDataURL('image/jpeg'));
                    } catch (e) {
                        createInfoCard();
                    }
                };

                v.onerror = () => {
                    clearTimeout(timeout);
                    createInfoCard();
                };

                v.src = URL.createObjectURL(file);
                v.load();
            });
        }

        async function startProcessing() {
            apiKeys = [document.getElementById('apiKey1').value, document.getElementById('apiKey2').value].filter(k => k);
            if (!apiKeys.length) return alert("Isi API Key!");
            document.getElementById('btnProcess').disabled = true;

            for (let item of fileQueue) {
                const idx = item.id;
                updateStatus(idx, 'processing', 'Analyzing...');
                try {
                    const base64 = await getFilmstrip(item.file);
                    document.getElementById(`preview-${idx}`).innerHTML = `<img src="${base64}">`;
                    let data = await makeRequest(apiKeys[currentKeyIndex], base64);

                    let finalCat = "backgrounds";
                    if (data.category) {
                       const match = ALL_CATEGORIES.find(c => c === data.category.toLowerCase() || c.endsWith('/' + data.category.toLowerCase()));
                       if (match) finalCat = match;
                    }
                    document.getElementById(`cat-${idx}`).value = finalCat;
                    document.getElementById(`cat-disp-${idx}`).innerText = finalCat;

                    let rawKw = data.keywords;
                    let kws = Array.isArray(rawKw) ? rawKw : (typeof rawKw === 'string' ? rawKw.split(',') : []);
                    let splitKws = [];
                    kws.forEach(word => {
                        let parts = word.toString().toLowerCase().split(/[\s_-]+/);
                        parts.forEach(p => {
                            let clean = p.replace(/[^a-z]/g, '');
                            if (clean.length > 2 && !STOP_WORDS.includes(clean)) splitKws.push(clean);
                        });
                    });
                    splitKws = [...new Set(splitKws)];
                    let bIdx = 0;
                    while (splitKws.length < 45 && bIdx < BACKUP_KEYWORDS.length) {
                        if (!splitKws.includes(BACKUP_KEYWORDS[bIdx])) splitKws.push(BACKUP_KEYWORDS[bIdx]);
                        bIdx++;
                    }
                    document.getElementById(`kw-${idx}`).value = splitKws.join(', ');

                    let title = (data.title || "").trim();
                    title = title.replace(/['":;,.!?-]/g, '');
                    title = title.replace(/\b(saying|reads|written|that says|showing)\b/gi, ""); 
                    title = title.replace(/\s+/g, ' '); 
                    title = title.replace(/^(the|this|a|an)\s+(video|clip|animation)\s+/i, "");
                    title = title.charAt(0).toUpperCase() + title.slice(1).toLowerCase();

                    const hasBackgroundInTitle = /\b(on|with)\s+.*background\b/i.test(title);
                    if (title.length < 70) {
                        if (title.toLowerCase().includes("thanks") || title.toLowerCase().includes("subscribe")) {
                             title += " for youtube end screen channel closing";
                        } else if (finalCat.includes("abstract") && !title.includes("loop")) {
                             title += " motion background in seamless loop";
                        } else if (!hasBackgroundInTitle && (finalCat.includes("element") || finalCat.includes("overlay"))) {
                             title += " animation isolated on transparent background";
                        } else {
                             title += " with professional cinematic lighting effect";
                        }
                    }
                    title = smartTrim(title, 70, 90);
                    title = cleanTrailing(title);
                    document.getElementById(`title-${idx}`).value = title;

                    let desc = (data.description || "Video clip.").trim();
                    desc = desc.replace(/\b(static image|still photo|picture)\b/gi, "motion graphic video");
                    desc = desc.replace(/^High quality video clip\.?/i, "This video features");
                    if (!desc.toLowerCase().startsWith("this video")) desc = "This video features " + desc.charAt(0).toLowerCase() + desc.slice(1);
                    if (desc.length < 100) desc += " ideal for event displays, backgrounds, and multimedia projects.";
                    let finalDesc = desc.substring(0, 150);
                    if (finalDesc.length < desc.length) finalDesc = finalDesc.replace(/\s\w*$/, ""); 
                    finalDesc = cleanTrailing(finalDesc);
                    if (!finalDesc.endsWith('.')) finalDesc += ".";
                    document.getElementById(`desc-${idx}`).value = finalDesc;

                    updateStatus(idx, 'success', 'Done');
                    validate(idx);
                } catch (e) {
                    console.error(e);
                    updateStatus(idx, 'error', 'Fail');
                }
            }
            document.getElementById('btnProcess').disabled = false;
            document.getElementById('btnExport').style.display = 'inline-flex';
            document.getElementById('btnReset').style.display = 'inline-flex';
        }

        async function makeRequest(key, base64) {
            const prompt = `You are a Stock Video Metadata Expert. 
            Input: Filmstrip of a VIDEO clip. 
            IMPORTANT: If you see a WHITE CARD with TEXT (Filename), analyze the text to guess the visual content!
            STRICT RULES:
            1. Title: Create an ORGANIC formula: [Adjective] + [Color] + [Subject] + [Action] + [Context]. NO "saying". Target 80 chars.
            2. Keywords: Return 50 relevant SINGLE words. NO STOP WORDS.
            3. Category: Select most relevant.
            4. Description: Start with "This video features...". NEVER say "static image".`;
            
            const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: GROQ_MODEL,
                    messages: [
                        { role: "system", content: prompt },
                        { role: "user", content: [
                            { type: "text", text: "Analyze visuals or filename card. Organic title. JSON only." },
                            { type: "image_url", image_url: { url: base64 } }
                        ]}
                    ],
                    response_format: { type: "json_object" }
                })
            });
            const d = await resp.json();
            return JSON.parse(d.choices[0].message.content);
        }

        function updateStatus(idx, type, text) {
            const p = document.getElementById(`status-pill-${idx}`);
            p.className = `status-pill ${type}`;
            document.getElementById(`status-text-${idx}`).innerText = text;
        }

        function exportCSV() {
            let csv = "Filename,Title,Description,Keywords,Category\n";
            fileQueue.forEach((item, idx) => {
                const row = [item.file.name, document.getElementById(`title-${idx}`).value, document.getElementById(`desc-${idx}`).value, document.getElementById(`kw-${idx}`).value, document.getElementById(`cat-${idx}`).value];
                csv += row.map(v => `"${v.replace(/"/g, '""')}"`).join(',') + "\n";
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `microstock_video_metadata.csv`;
            a.click();
        }
    </script>
</body>
</html>
