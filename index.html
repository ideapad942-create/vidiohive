<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microstock Metadata Pro - Motion Graphic Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --primary-dark: #4f46e5; --secondary: #0ea5e9; --bg: #f1f5f9; --surface: #ffffff; --border: #e2e8f0; --text: #0f172a; --success: #10b981; --error: #ef4444; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .container { max-width: 1400px; margin: 0 auto; background: var(--surface); border-radius: 16px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); border: 1px solid var(--border); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); color: white; padding: 25px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--secondary); }
        .header h1 { margin: 0; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .badge-pro { background: var(--secondary); font-size: 10px; padding: 3px 8px; border-radius: 20px; text-transform: uppercase; font-weight: 800; }
        .controls { padding: 25px; border-bottom: 1px solid var(--border); background: #f8fafc; }
        .api-box { display: grid; grid-template-columns: 1fr 1fr auto; gap: 20px; margin-bottom: 20px; align-items: end; background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .input-group label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 8px; color: #64748b; text-transform: uppercase; }
        .input-field { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 13px; box-sizing: border-box; }
        .action-area { display: flex; gap: 15px; align-items: center; margin-top: 15px; }
        .btn { padding: 0 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; transition: 0.2s; height: 48px; font-size: 14px; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); } .btn-success { background: var(--success); } .btn-save { background: #334155; height: 45px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f1f5f9; padding: 15px 20px; text-align: left; font-weight: 700; color: #475569; border-bottom: 2px solid var(--border); text-transform: uppercase; font-size: 11px; }
        td { padding: 25px 20px; border-bottom: 1px solid var(--border); vertical-align: top; }
        .meta-wrapper { position: relative; margin-bottom: 20px; }
        .meta-label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 6px; font-weight: 700; color: #475569; }
        .meta-input { width: 100%; box-sizing: border-box; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; background: #fff; line-height: 1.6; }
        textarea.meta-input { min-height: 80px; resize: vertical; }
        .count-ok { color: #15803d; background: #dcfce7; padding: 2px 8px; border-radius: 4px; }
        .count-err { color: #b91c1c; background: #fee2e2; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .preview-box { width: 280px; border-radius: 10px; overflow: hidden; border: 1px solid var(--border); background: #000; }
        .preview-box img { width: 100%; display: block; }
        .cat-badge { display: inline-block; background: #e0f2fe; color: #0369a1; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700; margin-top: 10px; width: 100%; box-sizing: border-box; text-align: center; }
        .status-pill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; margin-top: 10px; }
        .status-pill.processing { background: #e0e7ff; color: #4338ca; } .status-pill.success { background: #dcfce7; color: #15803d; } .status-pill.error { background: #fee2e2; color: #b91c1c; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>üéûÔ∏è Metadata Generator <span class="badge-pro">V6 Motion Pro</span></h1>
            <div style="font-size: 12px; opacity: 0.8;">Strict Video Logic & Direct Titles</div>
        </div>

        <div class="controls">
            <div class="api-box">
                <div class="input-group">
                    <label>üîë API Key 1</label>
                    <input type="password" id="apiKey1" class="input-field" placeholder="gsk_...">
                </div>
                <div class="input-group">
                    <label>üîë API Key 2</label>
                    <input type="password" id="apiKey2" class="input-field" placeholder="gsk_...">
                </div>
                <button class="btn btn-save" onclick="manualSaveKeys()">üíæ Simpan</button>
            </div>
            <div class="input-group">
                <label>üìÇ Pilih Folder Video</label>
                <input type="file" id="fileInput" class="input-field" webkitdirectory directory multiple style="background: white;">
            </div>
            <div class="action-area">
                <button class="btn btn-primary" id="btnProcess" onclick="startProcessing()">üöÄ Mulai Proses</button>
                <button class="btn btn-success" id="btnExport" onclick="exportCSV()" style="display:none;">üì• Download CSV</button>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 300px;">Media Asset</th>
                    <th>Metadata (No "The Image" - Pure Video Description)</th>
                </tr>
            </thead>
            <tbody id="resultBody"></tbody>
        </table>
    </div>

    <video id="hiddenVideo" style="display:none;" muted playsinline></video>
    <canvas id="hiddenCanvas" style="display:none;"></canvas>

    <script>
        const ALL_CATEGORIES = [
            "backgrounds", "backgrounds/3d-object", "backgrounds/abstract", "backgrounds/cartoons", "backgrounds/corporate", 
            "backgrounds/electric", "backgrounds/events", "backgrounds/fire", "backgrounds/grunge", "backgrounds/industrial", 
            "backgrounds/kids", "backgrounds/light", "backgrounds/medical", "backgrounds/nature", "backgrounds/retro", 
            "backgrounds/sky-clouds", "backgrounds/space", "backgrounds/sports", "backgrounds/technology", "backgrounds/water", 
            "backgrounds/miscellaneous",
            "bugs", "bugs/3d-object", "bugs/abstract", "bugs/cartoons", "bugs/corporate", "bugs/electric", "bugs/events", 
            "bugs/fire", "bugs/grunge", "bugs/industrial", "bugs/kids", "bugs/light", "bugs/medical", "bugs/nature", 
            "bugs/retro", "bugs/sky-clouds", "bugs/space", "bugs/sports", "bugs/technology", "bugs/water", "bugs/miscellaneous",
            "distortions",
            "elements", "elements/3d-object", "elements/abstract", "elements/cartoons", "elements/corporate", "elements/electric", 
            "elements/events", "elements/fire", "elements/grunge", "elements/industrial", "elements/kids", "elements/light", 
            "elements/medical", "elements/nature", "elements/retro", "elements/sky-clouds", "elements/space", "elements/sports", 
            "elements/technology", "elements/water", "elements/miscellaneous",
            "interface-effects", "interface-effects/3d-object", "interface-effects/abstract", "interface-effects/cartoons", 
            "interface-effects/corporate", "interface-effects/electric", "interface-effects/events", "interface-effects/fire", 
            "interface-effects/grunge", "interface-effects/industrial", "interface-effects/kids", "interface-effects/light", 
            "interface-effects/medical", "interface-effects/nature", "interface-effects/retro", "interface-effects/sky-clouds", 
            "interface-effects/space", "interface-effects/sports", "interface-effects/technology", "interface-effects/water", 
            "interface-effects/miscellaneous",
            "lower-thirds", "lower-thirds/3d-object", "lower-thirds/abstract", "lower-thirds/cartoons", "lower-thirds/corporate", 
            "lower-thirds/electric", "lower-thirds/events", "lower-thirds/fire", "lower-thirds/grunge", "lower-thirds/industrial", 
            "lower-thirds/kids", "lower-thirds/light", "lower-thirds/medical", "lower-thirds/nature", "lower-thirds/retro", 
            "lower-thirds/sky-clouds", "lower-thirds/space", "lower-thirds/sports", "lower-thirds/technology", "lower-thirds/water", 
            "lower-thirds/miscellaneous",
            "overlays", "overlays/3d-object", "overlays/abstract", "overlays/cartoons", "overlays/corporate", "overlays/electric", 
            "overlays/events", "overlays/fire", "overlays/grunge", "overlays/industrial", "overlays/kids", "overlays/light", 
            "overlays/medical", "overlays/nature", "overlays/retro", "overlays/sky-clouds", "overlays/space", "overlays/sports", 
            "overlays/technology", "overlays/water", "overlays/miscellaneous",
            "particles",
            "revealer", "revealer/3d-object", "revealer/abstract", "revealer/cartoons", "revealer/corporate", "revealer/electric", 
            "revealer/events", "revealer/fire", "revealer/grunge", "revealer/industrial", "revealer/kids", "revealer/light", 
            "revealer/medical", "revealer/nature", "revealer/retro", "revealer/sky-clouds", "revealer/space", "revealer/sports", 
            "revealer/technology", "revealer/water", "revealer/miscellaneous",
            "transitions", "transitions/3d-object", "transitions/abstract", "transitions/cartoons", "transitions/corporate", 
            "transitions/electric", "transitions/events", "transitions/fire", "transitions/grunge", "transitions/industrial", 
            "transitions/kids", "transitions/light", "transitions/medical", "transitions/nature", "transitions/retro", 
            "transitions/sky-clouds", "transitions/space", "transitions/sports", "transitions/technology", "transitions/water", 
            "transitions/miscellaneous",
            "water-and-fluid",
            "miscellaneous", "miscellaneous/3d-object", "miscellaneous/abstract", "miscellaneous/cartoons", "miscellaneous/corporate", 
            "miscellaneous/electric", "miscellaneous/events", "miscellaneous/fire", "miscellaneous/grunge", "miscellaneous/industrial", 
            "miscellaneous/kids", "miscellaneous/light", "miscellaneous/medical", "miscellaneous/nature", "miscellaneous/retro", 
            "miscellaneous/sky-clouds", "miscellaneous/space", "miscellaneous/sports", "miscellaneous/technology", "miscellaneous/water", 
            "miscellaneous/miscellaneous",
            "infographics"
        ];

        const BACKUP_KEYWORDS = ["motion graphic", "seamless loop", "3d render", "animation", "digital art", "futuristic", "abstract", "kinetic", "visual effect", "cgi", "modern", "dynamic", "flow", "energy", "technology", "geometric", "pattern", "glowing", "vibrant", "cinematic", "background", "overlay", "alpha channel", "transparent", "video production", "broadcast", "design element"];

        const GROQ_MODEL = "meta-llama/llama-4-scout-17b-16e-instruct";

        let fileQueue = [];
        let apiKeys = [];
        let currentKeyIndex = 0;

        if (localStorage.getItem('API_KEY_1')) document.getElementById('apiKey1').value = localStorage.getItem('API_KEY_1');
        if (localStorage.getItem('API_KEY_2')) document.getElementById('apiKey2').value = localStorage.getItem('API_KEY_2');

        function manualSaveKeys() {
            localStorage.setItem('API_KEY_1', document.getElementById('apiKey1').value.trim());
            localStorage.setItem('API_KEY_2', document.getElementById('apiKey2').value.trim());
            alert("Simpan Berhasil!");
        }

        document.getElementById('fileInput').addEventListener('change', function (e) {
            const files = Array.from(e.target.files).filter(f => f.type.startsWith('video/'));
            const tbody = document.getElementById('resultBody');
            tbody.innerHTML = '';
            fileQueue = [];
            files.forEach((file, index) => {
                fileQueue.push({ file, id: index });
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="preview-box" id="preview-${index}"><div style="height:140px; background:#eee;"></div></div>
                        <div style="font-weight:600; font-size:12px; margin-top:10px;">${file.name}</div>
                        <div class="cat-badge" id="cat-disp-${index}">Category: -</div>
                        <div class="status-pill" id="status-pill-${index}">‚ö´ <span id="status-text-${index}">Pending</span></div>
                        <input type="hidden" id="cat-${index}">
                    </td>
                    <td>
                        <div class="meta-wrapper">
                            <div class="meta-label"><span>TITLE (50-70)</span><span id="cnt-title-${index}">0/70</span></div>
                            <input type="text" class="meta-input" id="title-${index}" oninput="validate(${index})">
                        </div>
                        <div class="meta-wrapper">
                            <div class="meta-label"><span>DESC (100-150)</span><span id="cnt-desc-${index}">0/150</span></div>
                            <textarea class="meta-input" id="desc-${index}" oninput="validate(${index})"></textarea>
                        </div>
                        <div class="meta-wrapper">
                            <div class="meta-label"><span>KEYWORDS (45-48)</span><span id="cnt-kw-${index}">0 words</span></div>
                            <textarea class="meta-input" id="kw-${index}" oninput="validate(${index})"></textarea>
                        </div>
                    </td>`;
                tbody.appendChild(tr);
            });
        });

        function validate(idx) {
            const t = document.getElementById(`title-${idx}`).value.length;
            const d = document.getElementById(`desc-${idx}`).value.length;
            const k = document.getElementById(`kw-${idx}`).value.split(',').filter(x => x.trim()).length;
            
            document.getElementById(`cnt-title-${idx}`).innerText = `${t}/70`;
            document.getElementById(`cnt-title-${idx}`).className = (t < 50 || t > 70) ? 'count-err' : 'count-ok';
            
            document.getElementById(`cnt-desc-${idx}`).innerText = `${d}/150`;
            document.getElementById(`cnt-desc-${idx}`).className = (d < 100 || d > 150) ? 'count-err' : 'count-ok';
            
            document.getElementById(`cnt-kw-${idx}`).innerText = `${k} words`;
            document.getElementById(`cnt-kw-${idx}`).className = (k < 45 || k > 48) ? 'count-err' : 'count-ok';
        }

        // Fungsi membersihkan kata sambung yang menggantung
        function cleanTrailing(str) {
            return str.trim().replace(/[\s,]+(and|or|with|the|a|an|is|at|of|in|to|for)[\s,.]*$/i, "").replace(/[,\s]+$/, "");
        }

        // Fungsi membersihkan awalan "The image shows" atau "A video of"
        function cleanStart(str) {
            // Hapus: "The image", "This video", "A 3d render of", "Seamless loop of" (biar tidak duplikat)
            return str.replace(/^(the|this|a|an)\s+(image|video|clip|footage|picture|shot|view|rendering|illustration|animation)\s+(shows|features|depicts|of|is|displaying)?\s*/i, "")
                      .replace(/^shows\s+/i, ""); 
        }

        async function startProcessing() {
            apiKeys = [document.getElementById('apiKey1').value, document.getElementById('apiKey2').value].filter(k => k);
            if (!apiKeys.length) return alert("Isi API Key!");
            document.getElementById('btnProcess').disabled = true;

            for (let item of fileQueue) {
                const idx = item.id;
                updateStatus(idx, 'processing', 'Analyzing...');
                try {
                    const base64 = await getFilmstrip(item.file);
                    document.getElementById(`preview-${idx}`).innerHTML = `<img src="${base64}">`;
                    let data = await makeRequest(apiKeys[currentKeyIndex], base64);

                    // ------------------------------------------
                    // CATEGORY LOGIC
                    // ------------------------------------------
                    let finalCat = "backgrounds";
                    if (data.category && ALL_CATEGORIES.includes(data.category)) {
                        finalCat = data.category;
                    } else if (data.category) {
                        const match = ALL_CATEGORIES.find(c => c === data.category.toLowerCase() || c.endsWith('/' + data.category.toLowerCase()));
                        if (match) finalCat = match;
                    }
                    document.getElementById(`cat-${idx}`).value = finalCat;
                    document.getElementById(`cat-disp-${idx}`).innerText = finalCat;

                    // ------------------------------------------
                    // TITLE LOGIC (SPOK & VIDEO CENTRIC)
                    // ------------------------------------------
                    let title = (data.title || "").replace(/-/g, ' ').replace(/\s+/g, ' ').trim();
                    
                    // 1. Bersihkan awalan "The image..."
                    title = cleanStart(title);
                    
                    // 2. Bersihkan akhiran
                    title = cleanTrailing(title);

                    // 3. Kapitalisasi awal
                    title = title.charAt(0).toUpperCase() + title.slice(1);

                    // 4. LOGIKA SUFFIX PENGGANTI "FOR CREATIVE..."
                    // Jika judul kependekan, tambahkan teknis videonya, bukan kalimat marketing.
                    if (title.length < 50) {
                        if (finalCat.includes("background") || finalCat.includes("abstract")) {
                            if (!title.toLowerCase().includes("loop")) title += " - Seamless Motion Loop";
                        } else if (finalCat.includes("overlays") || finalCat.includes("element")) {
                            title += " with Alpha Channel";
                        } else if (finalCat.includes("3d")) {
                            title += " - 3D Render Animation";
                        } else {
                            title += " - Motion Graphic Video";
                        }
                    }

                    // 5. Potong rapi max 70 char
                    if (title.length > 70) title = title.substring(0, 70).replace(/\s\w*$/, "");
                    title = cleanTrailing(title);

                    document.getElementById(`title-${idx}`).value = title;


                    // ------------------------------------------
                    // DESC LOGIC (VIDEO FOCUS)
                    // ------------------------------------------
                    let desc = (data.description || "High quality motion graphic.").trim();
                    
                    // Bersihkan "The image shows" dari deskripsi juga
                    if (desc.toLowerCase().startsWith("the image") || desc.toLowerCase().startsWith("this image")) {
                        desc = desc.replace(/^(the|this)\s+image\s+(shows|features|depicts|is)?\s*/i, "This video features ");
                    }

                    desc = cleanTrailing(desc);
                    if (!desc.endsWith('.')) desc += ".";

                    // Tambahan kalimat teknis (bukan marketing kosong)
                    if (desc.length < 100) {
                        if (finalCat.includes("loop") || finalCat.includes("background")) {
                            desc += " Ideally designed for backgrounds, presentations, and digital signage displays.";
                        } else {
                            desc += " Perfect for video editing, compositing, and professional broadcast projects.";
                        }
                    }
                    
                    let finalDesc = desc.substring(0, 150);
                    if (finalDesc.length < desc.length) finalDesc = finalDesc.replace(/\s\w*$/, ""); 
                    finalDesc = cleanTrailing(finalDesc);
                    if (!finalDesc.endsWith('.')) finalDesc += ".";

                    document.getElementById(`desc-${idx}`).value = finalDesc;

                    // ------------------------------------------
                    // KEYWORDS LOGIC
                    // ------------------------------------------
                    let kws = (data.keywords || "").split(',').map(w => w.trim().toLowerCase()).filter(w => w && !/\d/.test(w) && w.length > 2);
                    // Hapus kata "image", "photo" dari keywords
                    kws = kws.filter(w => w !== "image" && w !== "photo" && w !== "picture");
                    
                    kws = [...new Set(kws)];
                    let bIdx = 0;
                    while (kws.length < 45 && bIdx < BACKUP_KEYWORDS.length) {
                        if (!kws.includes(BACKUP_KEYWORDS[bIdx])) kws.push(BACKUP_KEYWORDS[bIdx]);
                        bIdx++;
                    }
                    document.getElementById(`kw-${idx}`).value = kws.slice(0, 48).join(', ');

                    updateStatus(idx, 'success', 'Done');
                    validate(idx);
                } catch (e) {
                    console.error(e);
                    updateStatus(idx, 'error', 'Fail');
                }
            }
            document.getElementById('btnProcess').disabled = false;
            document.getElementById('btnExport').style.display = 'inline-flex';
        }

        async function makeRequest(key, base64) {
            const categoriesStr = ALL_CATEGORIES.join(", ");
            // PROMPT DIPERBARUI AGAR FOCUS KE VIDEO/ANIMASI
            const prompt = `You are a Microstock Metadata Expert for VIDEO CONTENT (Motion Graphics, 3D Animations, Footage).
            Input: A filmstrip summarizing a VIDEO clip.
            
            STRICT RULES:
            1. NEVER use words like "The image", "This photo", "The picture". Use "3D Animation", "Motion Graphic", "Abstract Loop", or "Video Footage" instead.
            2. Category: Must be EXACTLY from this list: [${categoriesStr}].
            3. Title: Start directly with the subject (e.g., "Blue Neon Tunnel Loop", "Golden Particles Falling"). Do not start with "A video of".
            4. Description: Describe the MOVEMENT and VISUALS. Use complete sentences.
            5. Keywords: Focus on visual style, movement, and concept.`;
            
            const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: GROQ_MODEL,
                    messages: [
                        { role: "system", content: prompt },
                        { role: "user", content: [
                            { type: "text", text: "Analyze this video filmstrip. Return Strict JSON." },
                            { type: "image_url", image_url: { url: base64 } }
                        ]}
                    ],
                    response_format: { type: "json_object" }
                })
            });
            const d = await resp.json();
            return JSON.parse(d.choices[0].message.content);
        }

        function updateStatus(idx, type, text) {
            const p = document.getElementById(`status-pill-${idx}`);
            p.className = `status-pill ${type}`;
            document.getElementById(`status-text-${idx}`).innerText = text;
        }

        function getFilmstrip(file) {
            return new Promise(res => {
                const v = document.getElementById('hiddenVideo');
                const c = document.getElementById('hiddenCanvas');
                const ctx = c.getContext('2d');
                v.src = URL.createObjectURL(file);
                v.onloadedmetadata = async () => {
                    c.width = 960;
                    c.height = 180;
                    for (let i = 0; i < 3; i++) {
                        v.currentTime = v.duration * (0.2 + i * 0.3);
                        await new Promise(r => v.onseeked = r);
                        ctx.drawImage(v, 0, 0, v.videoWidth, v.videoHeight, i * 320, 0, 320, 180);
                    }
                    res(c.toDataURL('image/jpeg'));
                };
            });
        }

        function exportCSV() {
            let csv = "Filename,Title,Description,Keywords,Category\n";
            fileQueue.forEach((item, idx) => {
                const row = [
                    item.file.name,
                    document.getElementById(`title-${idx}`).value,
                    document.getElementById(`desc-${idx}`).value,
                    document.getElementById(`kw-${idx}`).value,
                    document.getElementById(`cat-${idx}`).value
                ];
                csv += row.map(v => `"${v.replace(/"/g, '""')}"`).join(',') + "\n";
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `microstock_video_v6.csv`;
            a.click();
        }
    </script>
</body>
</html>
