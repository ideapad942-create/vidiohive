<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microstock Metadata AI - Professional Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --bg-page: #f9fafb;
            --bg-card: #ffffff;
            --border: #e5e7eb;
            --text-main: #111827;
            --text-sub: #6b7280;
            --success: #059669;
            --error: #dc2626;
            --warning: #d97706;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-page); color: var(--text-main); margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column; }

        /* HEADER */
        header { background: var(--bg-card); border-bottom: 1px solid var(--border); padding: 16px 32px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
        .brand { font-size: 18px; font-weight: 700; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .brand span { background: #e0e7ff; color: var(--primary); font-size: 11px; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }

        /* CONTAINER */
        .container { max-width: 1400px; margin: 24px auto; padding: 0 24px; display: flex; gap: 24px; flex: 1; }

        /* SIDEBAR */
        .sidebar { width: 300px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; height: fit-content; position: sticky; top: 24px; }
        .sidebar-title { font-size: 13px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; margin-bottom: 16px; letter-spacing: 0.5px; }
        
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 12px; font-weight: 500; margin-bottom: 6px; color: var(--text-main); }
        .input-std { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; transition: all 0.2s; box-sizing: border-box; }
        .input-std:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: 600; font-size: 13px; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; margin-top: 10px; }
        .btn-success:hover { background: #047857; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .rules-box { background: #f3f4f6; border-radius: 8px; padding: 12px; font-size: 11px; color: var(--text-sub); line-height: 1.5; margin-top: 20px; border: 1px solid var(--border); }
        .rules-box strong { color: var(--text-main); }

        /* MAIN CONTENT */
        .main-content { flex: 1; display: flex; flex-direction: column; gap: 16px; }

        /* VIDEO CARD */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; transition: 0.2s; position: relative; }
        .card:hover { border-color: #c7d2fe; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        .card-status { width: 5px; background: var(--border); flex-shrink: 0; }
        .status-processing .card-status { background: var(--warning); }
        .status-success .card-status { background: var(--success); }
        .status-error .card-status { background: var(--error); }

        .card-preview { width: 220px; background: #f9fafb; border-right: 1px solid var(--border); padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .preview-img { width: 100%; aspect-ratio: 16/9; background: #e5e7eb; border-radius: 6px; object-fit: cover; border: 1px solid var(--border); }
        .filename { font-size: 12px; font-weight: 600; color: var(--text-main); word-break: break-all; }
        .cat-tag { font-size: 10px; background: #e0e7ff; color: var(--primary); padding: 4px 8px; border-radius: 4px; font-weight: 600; text-align: center; border: 1px solid #c7d2fe; }

        .card-body { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 16px; }

        /* METADATA FIELDS */
        .meta-group { position: relative; }
        .meta-header { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 11px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; }
        .char-counter { font-variant-numeric: tabular-nums; }
        .char-ok { color: var(--success); }
        .char-bad { color: var(--error); }

        .meta-input { width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 13px; line-height: 1.5; color: var(--text-main); background: #fff; transition: 0.2s; }
        .meta-input:focus { outline: none; border-color: var(--primary); }
        textarea.meta-input { resize: vertical; min-height: 70px; }

        /* UTILS */
        .hidden { display: none; }
        .empty-state { text-align: center; color: var(--text-sub); padding: 60px; font-size: 14px; border: 2px dashed var(--border); border-radius: 12px; background: #fff; }
    </style>
</head>
<body>

<header>
    <div class="brand">Microstock AI <span>Professional</span></div>
    <div style="font-size: 12px; color: var(--text-sub);">Auto-Lock Constraints System</div>
</header>

<div class="container">
    <aside class="sidebar">
        <div class="sidebar-title">Configuration</div>
        
        <div class="form-group">
            <label class="form-label">Groq API Key</label>
            <input type="password" id="apiKey" class="input-std" placeholder="gsk_xxxxxxxx...">
        </div>

        <div class="form-group">
            <label class="form-label">Select Video Folder</label>
            <input type="file" id="fileInput" class="input-std" webkitdirectory directory multiple>
        </div>

        <div id="statusIndicator" style="font-size:12px; font-weight:600; color:var(--primary); margin: 10px 0; text-align:center;"></div>

        <button id="btnProcess" class="btn btn-primary" onclick="startProcessing()">
            ðŸš€ Start AI Processing
        </button>

        <button id="btnExport" class="btn btn-success hidden" onclick="exportCSV()">
            ðŸ“¥ Download Final CSV
        </button>

        <div class="rules-box">
            <strong>Active Constraints:</strong><br>
            â€¢ Title: 50-70 Chars (Smart Trim)<br>
            â€¢ Desc: 100-150 Chars (Smart Trim)<br>
            â€¢ Keyword: <strong>LOCKED 45-48 Words</strong><br>
            (Auto-fill if &lt;45, Auto-cut if &gt;48)
        </div>
    </aside>

    <main class="main-content" id="resultsContainer">
        <div class="empty-state">
            Start by selecting a folder containing video files.<br>
            Supported formats: .mp4, .mov, .avi
        </div>
    </main>
</div>

<video id="hiddenVideo" class="hidden" muted playsinline></video>
<canvas id="hiddenCanvas" class="hidden"></canvas>

<script>
    // --- KONFIGURASI KETAT ---
    const CONFIG = {
        minTitle: 50, maxTitle: 70,
        minDesc: 100, maxDesc: 150,
        minKw: 45, maxKw: 48,
        model: "meta-llama/llama-4-scout-17b-16e-instruct"
    };

    // Database Kategori (Lengkap)
    const CATEGORIES_DB = `backgrounds, backgrounds/3d-object, backgrounds/abstract, backgrounds/cartoons, backgrounds/corporate, backgrounds/electric, backgrounds/events, backgrounds/fire, backgrounds/grunge, backgrounds/industrial, backgrounds/kids, backgrounds/light, backgrounds/medical, backgrounds/nature, backgrounds/retro, backgrounds/sky-clouds, backgrounds/space, backgrounds/sports, backgrounds/technology, backgrounds/water, backgrounds/miscellaneous, bugs, bugs/3d-object, bugs/abstract, bugs/cartoons, bugs/corporate, bugs/electric, bugs/events, bugs/fire, bugs/grunge, bugs/industrial, bugs/kids, bugs/light, bugs/medical, bugs/nature, bugs/retro, bugs/sky-clouds, bugs/space, bugs/sports, bugs/technology, bugs/water, bugs/miscellaneous, distortions, elements, elements/3d-object, elements/abstract, elements/cartoons, elements/corporate, elements/electric, elements/events, elements/fire, elements/grunge, elements/industrial, elements/kids, elements/light, elements/medical, elements/nature, elements/retro, elements/sky-clouds, elements/space, elements/sports, elements/technology, elements/water, elements/miscellaneous, interface-effects, interface-effects/3d-object, interface-effects/abstract, interface-effects/cartoons, interface-effects/corporate, interface-effects/electric, interface-effects/events, interface-effects/fire, interface-effects/grunge, interface-effects/industrial, interface-effects/kids, interface-effects/light, interface-effects/medical, interface-effects/nature, interface-effects/retro, interface-effects/sky-clouds, interface-effects/space, interface-effects/sports, interface-effects/technology, interface-effects/water, interface-effects/miscellaneous, lower-thirds, lower-thirds/3d-object, lower-thirds/abstract, lower-thirds/cartoons, lower-thirds/corporate, lower-thirds/electric, lower-thirds/events, lower-thirds/fire, lower-thirds/grunge, lower-thirds/industrial, lower-thirds/kids, lower-thirds/light, lower-thirds/medical, lower-thirds/nature, lower-thirds/retro, lower-thirds/sky-clouds, lower-thirds/space, lower-thirds/sports, lower-thirds/technology, lower-thirds/water, lower-thirds/miscellaneous, overlays, overlays/3d-object, overlays/abstract, overlays/cartoons, overlays/corporate, overlays/electric, overlays/events, overlays/fire, overlays/grunge, overlays/industrial, overlays/kids, overlays/light, overlays/medical, overlays/nature, overlays/retro, overlays/sky-clouds, overlays/space, overlays/sports, overlays/technology, overlays/water, overlays/miscellaneous, particles, revealer, revealer/3d-object, revealer/abstract, revealer/cartoons, revealer/corporate, revealer/electric, revealer/events, revealer/fire, revealer/grunge, revealer/industrial, revealer/kids, revealer/light, revealer/medical, revealer/nature, revealer/retro, revealer/sky-clouds, revealer/space, revealer/sports, revealer/technology, revealer/water, revealer/miscellaneous, transitions, transitions/3d-object, transitions/abstract, transitions/cartoons, transitions/corporate, transitions/electric, transitions/events, transitions/fire, transitions/grunge, transitions/industrial, transitions/kids, transitions/light, transitions/medical, transitions/nature, transitions/retro, transitions/sky-clouds, transitions/space, transitions/sports, transitions/technology, transitions/water, transitions/miscellaneous, water-and-fluid, miscellaneous, miscellaneous/3d-object, miscellaneous/abstract, miscellaneous/cartoons, miscellaneous/corporate, miscellaneous/electric, miscellaneous/events, miscellaneous/fire, miscellaneous/grunge, miscellaneous/industrial, miscellaneous/kids, miscellaneous/light, miscellaneous/medical, miscellaneous/nature, miscellaneous/retro, miscellaneous/sky-clouds, miscellaneous/space, miscellaneous/sports, miscellaneous/technology, miscellaneous/water, miscellaneous/miscellaneous, infographics`;

    // Keyword Cadangan (Jika AI malas, sistem akan inject ini sampai 45)
    const SAFE_KEYWORDS = [
        "video", "footage", "clip", "background", "motion", "graphic", "abstract", 
        "digital", "hd", "4k", "stock", "creative", "art", "style", "concept", 
        "view", "scene", "shot", "media", "element", "design", "backdrop", 
        "texture", "pattern", "visual", "effect", "animation", "dynamic", "modern", 
        "presentation", "project", "movie", "cinema", "film", "production"
    ];

    let fileQueue = [];
    let isProcessing = false;

    if(localStorage.getItem('GROQ_KEY')) document.getElementById('apiKey').value = localStorage.getItem('GROQ_KEY');

    // --- FILE LISTENER ---
    document.getElementById('fileInput').addEventListener('change', (e) => {
        const files = Array.from(e.target.files).filter(f => f.type.startsWith('video/'));
        const container = document.getElementById('resultsContainer');
        container.innerHTML = '';
        fileQueue = [];

        if(files.length === 0) {
            container.innerHTML = `<div class="empty-state">No valid video files found.</div>`;
            return;
        }

        files.forEach((file, idx) => {
            fileQueue.push({ file, id: idx });
            createCard(idx, file.name);
        });

        document.getElementById('statusIndicator').innerText = `Ready to process ${files.length} videos`;
    });

    // --- UI CARD CREATION ---
    function createCard(id, filename) {
        const html = `
        <div class="card" id="card-${id}">
            <div class="card-status"></div>
            <div class="card-preview">
                <div class="preview-img" id="thumb-${id}" style="display:flex;align-items:center;justify-content:center;color:#9ca3af;font-size:11px;">Waiting...</div>
                <div class="filename">${filename}</div>
                <div class="cat-tag" id="cat-disp-${id}">Category: -</div>
                <input type="hidden" id="cat-${id}">
            </div>
            <div class="card-body">
                <div class="meta-group">
                    <div class="meta-header">
                        <span>Title (${CONFIG.minTitle}-${CONFIG.maxTitle})</span>
                        <span class="char-counter" id="cnt-title-${id}">0</span>
                    </div>
                    <input type="text" class="meta-input" id="title-${id}" oninput="validate(${id})">
                </div>
                <div class="meta-group">
                    <div class="meta-header">
                        <span>Description (${CONFIG.minDesc}-${CONFIG.maxDesc})</span>
                        <span class="char-counter" id="cnt-desc-${id}">0</span>
                    </div>
                    <textarea class="meta-input" id="desc-${id}" oninput="validate(${id})"></textarea>
                </div>
                <div class="meta-group">
                    <div class="meta-header">
                        <span>Keywords (LOCKED: ${CONFIG.minKw}-${CONFIG.maxKw})</span>
                        <span class="char-counter" id="cnt-kw-${id}">0</span>
                    </div>
                    <textarea class="meta-input" id="kw-${id}" style="min-height:100px;" oninput="validate(${id})"></textarea>
                </div>
            </div>
        </div>
        `;
        document.getElementById('resultsContainer').insertAdjacentHTML('beforeend', html);
    }

    // --- PROCESSING ENGINE ---
    async function startProcessing() {
        const apiKey = document.getElementById('apiKey').value.trim();
        if(!apiKey) return alert("Please enter Groq API Key");
        localStorage.setItem('GROQ_KEY', apiKey);

        isProcessing = true;
        document.getElementById('btnProcess').disabled = true;
        
        for(const item of fileQueue) {
            const card = document.getElementById(`card-${item.id}`);
            card.classList.add('status-processing');
            document.getElementById('statusIndicator').innerText = `Processing: ${item.file.name}...`;

            try {
                // 1. Snapshot
                const base64 = await captureFrame(item.file);
                document.getElementById(`thumb-${item.id}`).innerHTML = `<img src="${base64}" class="preview-img">`;

                // 2. AI Request
                const data = await callAI(apiKey, base64);

                // 3. FILL & FIX DATA
                
                // > Category
                document.getElementById(`cat-${item.id}`).value = data.category;
                document.getElementById(`cat-disp-${item.id}`).innerText = data.category;

                // > Title (Smart Truncate)
                let tit = data.title || "";
                if(tit.length > CONFIG.maxTitle) {
                    let sub = tit.substring(0, CONFIG.maxTitle);
                    let lastSp = sub.lastIndexOf(" ");
                    tit = (lastSp > 50) ? sub.substring(0, lastSp) : sub;
                }
                document.getElementById(`title-${item.id}`).value = tit;

                // > Description (Smart Truncate)
                let desc = data.description || "";
                if(desc.length > CONFIG.maxDesc) {
                    let sub = desc.substring(0, CONFIG.maxDesc);
                    let lastSp = sub.lastIndexOf(" ");
                    desc = (lastSp > 100) ? sub.substring(0, lastSp) : sub;
                }
                document.getElementById(`desc-${item.id}`).value = desc;

                // > KEYWORD ENGINE (THE FIX)
                let rawKw = (data.keywords || "").replace(/\./g, '').split(',');
                let cleanKw = [];
                
                // Phase 1: Cleaning & Splitting
                rawKw.forEach(k => {
                    let w = k.trim().toLowerCase();
                    if(w.includes(' ')) cleanKw.push(...w.split(' ')); // Pecah frase
                    else if(w.length > 2) cleanKw.push(w);
                });
                
                // Phase 2: Deduplicate
                cleanKw = [...new Set(cleanKw)];

                // Phase 3: AUTO-FILL (Jika kurang dari 45)
                if(cleanKw.length < CONFIG.minKw) {
                    let needed = CONFIG.minKw - cleanKw.length;
                    let added = 0;
                    for(let safe of SAFE_KEYWORDS) {
                        if(!cleanKw.includes(safe) && added < needed) {
                            cleanKw.push(safe);
                            added++;
                        }
                    }
                }

                // Phase 4: AUTO-CUT (Jika lebih dari 48)
                if(cleanKw.length > CONFIG.maxKw) {
                    cleanKw = cleanKw.slice(0, CONFIG.maxKw);
                }

                document.getElementById(`kw-${item.id}`).value = cleanKw.join(', ');

                // 4. Update UI
                card.classList.remove('status-processing');
                card.classList.add('status-success');
                validate(item.id);

            } catch (e) {
                console.error(e);
                card.classList.remove('status-processing');
                card.classList.add('status-error');
                document.getElementById(`thumb-${item.id}`).innerHTML = `<span style="color:red;font-size:10px;">${e.message}</span>`;
            }

            await new Promise(r => setTimeout(r, 1500)); // Delay
        }

        isProcessing = false;
        document.getElementById('btnProcess').disabled = false;
        document.getElementById('btnExport').classList.remove('hidden');
        document.getElementById('statusIndicator').innerText = "All Processed! Check metadata.";
        alert("Processing Complete!");
    }

    // --- VALIDATOR UI ---
    function validate(id) {
        // Title
        const tVal = document.getElementById(`title-${id}`).value;
        const tCnt = document.getElementById(`cnt-title-${id}`);
        tCnt.innerText = `${tVal.length}`;
        tCnt.className = (tVal.length >= CONFIG.minTitle && tVal.length <= CONFIG.maxTitle) ? 'char-counter char-ok' : 'char-counter char-bad';

        // Desc
        const dVal = document.getElementById(`desc-${id}`).value;
        const dCnt = document.getElementById(`cnt-desc-${id}`);
        dCnt.innerText = `${dVal.length}`;
        dCnt.className = (dVal.length >= CONFIG.minDesc && dVal.length <= CONFIG.maxDesc) ? 'char-counter char-ok' : 'char-counter char-bad';

        // Keywords
        const kVal = document.getElementById(`kw-${id}`).value;
        const kCnt = document.getElementById(`cnt-kw-${id}`);
        const count = kVal.split(',').filter(x => x.trim().length > 0).length;
        kCnt.innerText = `${count}`;
        kCnt.className = (count >= CONFIG.minKw && count <= CONFIG.maxKw) ? 'char-counter char-ok' : 'char-counter char-bad';
    }

    // --- AI PROMPT ---
    async function callAI(key, base64) {
        const prompt = `
        Role: Microstock Metadata Specialist.
        Input: 3 Video Frames.
        
        TASK:
        1. CATEGORY: Pick ONE from: [${CATEGORIES_DB}]
        
        2. TITLE (50-70 chars): Descriptive sentence. Focus on subject + action.
        
        3. DESCRIPTION (100-150 chars): Detailed visual description.
        
        4. KEYWORDS (CRITICAL):
           - GENERATE 70 (SEVENTY) KEYWORDS.
           - I will cut them down later, but I need MANY to start with.
           - SINGLE WORDS ONLY. No phrases.
           - Include: visual, color, style, concept, technical terms.

        OUTPUT JSON ONLY:
        {"category": "...", "title": "...", "description": "...", "keywords": "..."}
        `;

        const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
            body: JSON.stringify({
                model: CONFIG.model,
                messages: [
                    { role: "system", content: prompt },
                    { role: "user", content: [
                        { type: "text", text: "Analyze frames. Generate JSON." },
                        { type: "image_url", image_url: { url: base64 } }
                    ]}
                ],
                temperature: 0.1,
                response_format: { type: "json_object" }
            })
        });

        const data = await resp.json();
        const content = data.choices[0].message.content;
        return JSON.parse(content.substring(content.indexOf('{'), content.lastIndexOf('}')+1));
    }

    // --- SNAPSHOT ---
    function captureFrame(file) {
        return new Promise((resolve, reject) => {
            const vid = document.getElementById('hiddenVideo');
            const cvs = document.getElementById('hiddenCanvas');
            const ctx = cvs.getContext('2d');
            const url = URL.createObjectURL(file);
            
            vid.src = url; vid.muted = true;
            const w=320, h=180;
            cvs.width = w*3; cvs.height = h;

            const seek = (t) => new Promise(r => { vid.currentTime=t; vid.onseeked=()=>r(); });

            vid.onloadedmetadata = async () => {
                try {
                    await seek(vid.duration * 0.2);
                    ctx.drawImage(vid,0,0,vid.videoWidth,vid.videoHeight,0,0,w,h);
                    await seek(vid.duration * 0.5);
                    ctx.drawImage(vid,0,0,vid.videoWidth,vid.videoHeight,w,0,w,h);
                    await seek(vid.duration * 0.8);
                    ctx.drawImage(vid,0,0,vid.videoWidth,vid.videoHeight,w*2,0,w,h);
                    resolve(cvs.toDataURL('image/jpeg', 0.8));
                    URL.revokeObjectURL(url);
                } catch(e) { reject(e); }
            };
            vid.onerror = () => reject(new Error("Video Error"));
        });
    }

    // --- EXPORT CSV ---
    function exportCSV() {
        let csv = "Filename,Title,Description,Keywords,Category\n";
        fileQueue.forEach((item) => {
            const id = item.id;
            const el = (id) => document.getElementById(id).value.replace(/"/g, '""');
            if(!document.getElementById(`title-${id}`).value) return; 

            csv += `"${item.file.name.replace(/"/g, '""')}","${el(`title-${id}`)}","${el(`desc-${id}`)}","${el(`kw-${id}`)}","${el(`cat-${id}`)}"\n`;
        });

        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `microstock_final_${Date.now()}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>
</body>
</html>
