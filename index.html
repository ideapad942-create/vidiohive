<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MALES MIKIR - VIDEO AUTO METADATA</title>
    <style>
        :root { --primary: #db2777; --bg: #f8fafc; --dark: #1e293b; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--dark); }
        .container { max-width: 1100px; margin: auto; background: white; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow: hidden; }
        
        .tabs { display: flex; background: #f1f5f9; padding: 10px; gap: 10px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; color: #64748b; cursor: pointer; font-weight: 600; border-radius: 8px; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }

        .content { padding: 30px; display: none; }
        .content.active { display: block; }

        .drop-zone { border: 2px dashed #cbd5e1; padding: 50px; text-align: center; border-radius: 12px; cursor: pointer; background: #fff; transition: 0.3s; }
        .drop-zone:hover { border-color: var(--primary); background: #fff1f2; }

        .text-input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; margin-bottom: 20px; box-sizing: border-box; }
        
        .result-card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 20px; display: flex; gap: 20px; border-left: 6px solid var(--primary); }
        .frame-preview { width: 220px; flex-shrink: 0; }
        .main-img { width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 8px; background: #eee; }
        .mini-frames { display: flex; gap: 4px; margin-top: 6px; }
        .mini-img { width: 32%; aspect-ratio: 16/9; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }

        .meta-info { flex-grow: 1; }
        .label { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; display: block; margin-top: 10px; }
        .value { font-size: 13px; color: #334155; background: #f8fafc; padding: 8px; border-radius: 6px; border: 1px solid #f1f5f9; margin-top: 4px; }

        .btn { padding: 14px 24px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 14px; width: 100%; transition: 0.2s; }
        .btn-pink { background: var(--primary); color: white; }
        .btn-green { background: #10b981; color: white; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .s-wait { background: #f1f5f9; color: #64748b; }
        .s-run { background: #dbeafe; color: #2563eb; }
        .s-done { background: #d1fae5; color: #065f46; }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="goToTab(0)">1. API SETUP</button>
        <button class="tab-btn" onclick="goToTab(1)">2. PILIH FOLDER</button>
        <button class="tab-btn" onclick="goToTab(2)">3. PROSES AI</button>
        <button class="tab-btn" onclick="goToTab(3)">4. DOWNLOAD CSV</button>
    </div>

    <div id="c0" class="content active">
        <h2>üîë API Key Groq</h2>
        <input type="password" id="apiKey" class="text-input" placeholder="gsk_xxxxxxxxxxxxxxxx">
        <button class="btn btn-pink" onclick="saveKey()">Simpan & Lanjut</button>
    </div>

    <div id="c1" class="content">
        <h2>üìÅ Pilih Folder Video</h2>
        <div id="dropArea" class="drop-zone">
            <span style="font-size:40px;">üé¨</span><br>
            <strong>Klik untuk Pilih Folder</strong>
            <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none" onchange="handleFiles(this.files)">
        </div>
        <div id="fileSummary" style="margin: 20px 0; text-align:center; font-weight:bold;"></div>
        <button class="btn btn-pink" id="btnNext" style="display:none" onclick="goToTab(2)">Lanjut ke Analisis ‚û°Ô∏è</button>
    </div>

    <div id="c2" class="content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>‚ö° AI Processing</h2>
            <button class="btn btn-pink" id="btnStart" style="width:auto; padding:10px 30px;" onclick="startAI()">Mulai Analisis</button>
        </div>
        <table>
            <thead><tr><th>Preview</th><th>Nama File</th><th>Status</th></tr></thead>
            <tbody id="queueList"></tbody>
        </table>
    </div>

    <div id="c3" class="content">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
            <button class="btn btn-green" onclick="exportCSV()">üì• Download CSV (Rapi)</button>
            <button class="btn" style="background:#64748b; color:white;" onclick="location.reload()">üîÑ Reset Semua</button>
        </div>
        <div id="resultContainer"></div>
    </div>
</div>

<video id="videoProc" style="display:none;" muted></video>
<canvas id="canvasProc" style="display:none;"></canvas>

<script>
    let queue = [];
    let results = [];
    const MODEL = "llama-3.2-11b-vision-preview";

    const SYSTEM_PROMPT = `Role: Adobe Stock Specialist.
Analyze 3 frames (Start, Mid, End) of a video. 
Detect: Subject, Color, Style (3D/Animation/Real), Motion (Loop/Smooth).
Rules:
1. TITLE: Sentence, max 70 chars. No commas.
2. DESCRIPTION: Detailed story, max 160 chars. No commas.
3. KEYWORDS: Exactly 45-50 single words, comma separated.
Return JSON ONLY: {"title": "...", "description": "...", "keywords": "..."}`;

    function goToTab(i) {
        document.querySelectorAll('.content').forEach((c, idx) => c.classList.toggle('active', idx === i));
        document.querySelectorAll('.tab-btn').forEach((b, idx) => b.classList.toggle('active', idx === i));
    }

    function saveKey() {
        const k = document.getElementById('apiKey').value.trim();
        if(k.startsWith('gsk_')) { localStorage.setItem('GROQ_KEY', k); goToTab(1); } else alert("Key salah!");
    }
    if(localStorage.getItem('GROQ_KEY')) document.getElementById('apiKey').value = localStorage.getItem('GROQ_KEY');

    function handleFiles(files) {
        queue = [];
        const list = document.getElementById('queueList');
        list.innerHTML = "";
        let count = 0;
        for (let f of files) {
            if (['mp4','mov','avi'].includes(f.name.split('.').pop().toLowerCase())) {
                queue.push({ id: count, file: f, name: f.name, done: false });
                list.innerHTML += `<tr id="tr-${count}">
                    <td id="prev-${count}"><div style="width:50px; height:30px; background:#eee;"></div></td>
                    <td><strong>${f.name}</strong></td>
                    <td id="st-${count}"><span class="status-badge s-wait">Ready</span></td>
                </tr>`;
                count++;
            }
        }
        if(count > 0) {
            document.getElementById('fileSummary').innerText = count + " Video siap diproses.";
            document.getElementById('btnNext').style.display = 'block';
        }
    }

    async function captureFrames(file) {
        return new Promise((resolve) => {
            const v = document.getElementById('videoProc');
            const c = document.getElementById('canvasProc');
            const ctx = c.getContext('2d');
            const url = URL.createObjectURL(file);
            v.src = url;
            v.onloadedmetadata = async () => {
                const times = [v.duration * 0.1, v.duration * 0.5, v.duration * 0.9];
                let imgs = [];
                for (let t of times) {
                    v.currentTime = t;
                    await new Promise(r => v.onseeked = r);
                    const scale = 320 / Math.max(v.videoWidth, v.videoHeight);
                    c.width = v.videoWidth * scale;
                    c.height = v.videoHeight * scale;
                    ctx.drawImage(v, 0, 0, c.width, c.height);
                    imgs.push(c.toDataURL('image/jpeg', 0.6));
                }
                URL.revokeObjectURL(url);
                resolve(imgs);
            };
        });
    }

    async function startAI() {
        const k = localStorage.getItem('GROQ_KEY');
        if(!k) return alert("API Key kosong!");
        document.getElementById('btnStart').disabled = true;

        for (let item of queue) {
            if (item.done) continue;
            const st = document.getElementById(`st-${item.id}`);
            st.innerHTML = `<span class="status-badge s-run">Menganalisis...</span>`;

            try {
                const frames = await captureFrames(item.file);
                document.getElementById(`prev-${item.id}`).innerHTML = `<img src="${frames[1]}" style="width:50px; height:30px; object-fit:cover; border-radius:4px;">`;

                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST", headers: { "Authorization": `Bearer ${k}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: MODEL,
                        messages: [{
                            role: "user",
                            content: [
                                { type: "text", text: SYSTEM_PROMPT },
                                { type: "image_url", image_url: { url: frames[0] } },
                                { type: "image_url", image_url: { url: frames[1] } },
                                { type: "image_url", image_url: { url: frames[2] } }
                            ]
                        }],
                        temperature: 0.1, response_format: { type: "json_object" }
                    })
                });

                const json = await res.json();
                if (json.error) throw new Error(json.error.message);
                
                const meta = JSON.parse(json.choices[0].message.content);
                results.push({ filename: item.name, ...meta, frames: frames });
                renderCard(item.name, meta, frames);
                
                st.innerHTML = `<span class="status-badge s-done">Selesai</span>`;
                item.done = true;
            } catch (e) {
                console.error(e);
                st.innerHTML = `<span style="color:red; font-size:10px;">Error (Cek Console)</span>`;
            }
            await new Promise(r => setTimeout(r, 1000));
        }
        document.getElementById('btnStart').innerText = "Semua Selesai!";
        goToTab(3);
    }

    function renderCard(name, data, imgs) {
        const div = document.createElement('div');
        div.className = 'result-card';
        div.innerHTML = `
            <div class="frame-preview">
                <img src="${imgs[1]}" class="main-img">
                <div class="mini-frames">
                    <img src="${imgs[0]}" class="mini-img">
                    <img src="${imgs[1]}" class="mini-img">
                    <img src="${imgs[2]}" class="mini-img">
                </div>
                <div style="font-size:11px; margin-top:8px; font-weight:bold; color:var(--primary);">${name}</div>
            </div>
            <div class="meta-info">
                <span class="label">Title</span><div class="value">${data.title}</div>
                <span class="label">Description</span><div class="value">${data.description}</div>
                <span class="label">Keywords</span><div class="value" style="font-size:11px;">${data.keywords}</div>
            </div>`;
        document.getElementById('resultContainer').prepend(div);
    }

    function exportCSV() {
        if(results.length === 0) return alert("Tidak ada data!");
        let csv = "Filename,Title,Description,Keywords\n";
        results.forEach(r => {
            // Hilangkan koma di title & desc agar kolom tidak berantakan
            const t = r.title.replace(/,/g, '');
            const d = r.description.replace(/,/g, '');
            csv += `"${r.filename}","${t}","${d}","${r.keywords}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `Metadata_Video_${Date.now()}.csv`;
        link.click();
    }
</script>
</body>
</html>
