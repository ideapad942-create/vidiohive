<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MALES MIKIR - VIDEO PRO EDITION</title>
    <style>
        :root { --primary: #db2777; --success: #10b981; --dark: #0f172a; --bg: #f8fafc; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1e293b; }
        .container { max-width: 1000px; margin: auto; background: white; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); overflow: hidden; border: 1px solid #e2e8f0; }
        
        /* Navigation */
        .tabs { display: flex; background: #f1f5f9; padding: 8px; gap: 8px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; color: #64748b; cursor: pointer; font-weight: 600; border-radius: 12px; transition: 0.2s; font-size: 14px; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }

        .content { padding: 40px; display: none; }
        .content.active { display: block; }

        /* Upload Area */
        .drop-zone { border: 2px dashed #cbd5e1; padding: 60px 20px; text-align: center; border-radius: 16px; cursor: pointer; transition: 0.3s; background: #f8fafc; }
        .drop-zone:hover { border-color: var(--primary); background: #fff1f2; }

        /* Inputs */
        .input-group { margin-bottom: 24px; }
        .input-label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 13px; text-transform: uppercase; letter-spacing: 0.05em; color: #475569; }
        .text-input { width: 100%; padding: 14px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: 0.2s; }
        .text-input:focus { outline: none; border-color: var(--primary); ring: 2px rgba(219, 39, 119, 0.1); }

        /* Results Card */
        .result-card { background: white; border: 1px solid #e2e8f0; border-radius: 14px; padding: 20px; margin-bottom: 20px; display: grid; grid-template-columns: 200px 1fr; gap: 24px; transition: 0.2s; }
        .result-card:hover { border-color: var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
        .frame-grid { display: grid; grid-template-columns: 1fr; gap: 4px; }
        .main-frame { width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 8px; background: #eee; }
        .sub-frames { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 4px; }
        .sub-frame { width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 4px; }

        .meta-content { display: flex; flex-direction: column; gap: 12px; }
        .tag-box { font-size: 11px; font-weight: 800; color: var(--primary); text-transform: uppercase; }
        .val-text { font-size: 14px; line-height: 1.6; color: #334155; background: #f1f5f9; padding: 10px; border-radius: 8px; }

        /* Buttons */
        .btn { padding: 16px 24px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 15px; width: 100%; }
        .btn-pink { background: var(--primary); color: white; }
        .btn-pink:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-green { background: var(--success); color: white; }

        /* Progress Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th { text-align: left; padding: 12px; color: #64748b; border-bottom: 2px solid #f1f5f9; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; }

        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
        .s-wait { background: #f1f5f9; color: #64748b; }
        .s-run { background: #dbeafe; color: #2563eb; animation: pulse 1.5s infinite; }
        @keyframes pulse { 50% { opacity: 0.6; } }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="goToTab(0)">1. API KEY</button>
        <button class="tab-btn" onclick="goToTab(1)">2. FOLDER SETUP</button>
        <button class="tab-btn" onclick="goToTab(2)">3. PROCESSING</button>
        <button class="tab-btn" onclick="goToTab(3)">4. DOWNLOAD CSV</button>
    </div>

    <div id="c0" class="content active">
        <h2 style="margin-top:0">üîë Groq Configuration</h2>
        <div class="input-group">
            <label class="input-label">Groq API Key</label>
            <input type="password" id="apiKey" class="text-input" placeholder="gsk_xxxxxxxxxxxxxxxx">
        </div>
        <button class="btn btn-pink" onclick="saveKey()">Connect & Continue</button>
    </div>

    <div id="c1" class="content">
        <h2>üìÅ Source Folder</h2>
        <div class="input-group">
            <label class="input-label">Absolute Folder Path (Untuk CSV)</label>
            <input type="text" id="basePath" class="text-input" placeholder="D:\Footage\Bali_Collection">
        </div>
        <div id="dropArea" class="drop-zone">
            <div style="font-size:48px; margin-bottom:10px;">üé•</div>
            <strong>Select Video Folder</strong>
            <p style="color:#64748b; font-size:13px;">Klik untuk memilih seluruh isi folder video Anda</p>
            <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none" onchange="handleFolderSelect(this.files)">
        </div>
        <div id="fileSummary" style="margin-top:20px; text-align:center; font-weight:bold;"></div>
        <button class="btn btn-pink" id="btnNext" style="display:none; margin-top:20px;" onclick="goToTab(2)">Go to Processing ‚û°Ô∏è</button>
    </div>

    <div id="c2" class="content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0">‚ö° AI Analysis</h2>
            <button class="btn btn-pink" id="btnStart" style="width:auto; padding:12px 30px;" onclick="startProcessing()">üöÄ Start Engine</button>
        </div>
        <div style="max-height: 450px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 12px; background: white;">
            <table>
                <thead><tr><th>Preview</th><th>Filename</th><th>Status</th></tr></thead>
                <tbody id="queueList"></tbody>
            </table>
        </div>
    </div>

    <div id="c3" class="content">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-bottom:30px;">
            <button class="btn btn-green" onclick="exportCSV()">üì• Download CSV (Filenames, Title, Desc, Keywords)</button>
            <button class="btn" style="background:#e2e8f0; color:#475569;" onclick="location.reload()">üîÑ Start New Session</button>
        </div>
        <div id="resultContainer"></div>
    </div>
</div>

<video id="videoProcessor" style="display:none;" muted></video>
<canvas id="canvasProcessor" style="display:none;"></canvas>

<script>
    let queue = [];
    let results = [];
    
    const SYSTEM_PROMPT = `
    Role: Expert Stock Footage Cataloger.
    Analyze 3 frames from a video (start, mid, end) to determine subject, color, motion, and style.
    
    OUTPUT REQUIREMENTS:
    1. TITLE: Descriptive sentence, max 70 chars. No commas.
    2. DESCRIPTION: High-quality storytelling, exactly 150-160 chars. No commas.
    3. KEYWORDS: 45-47 single words, comma-separated. Include mood, colors, movement (loop, 3d, slow motion), and object details.
    
    FORMAT: Strictly JSON {"title": "...", "description": "...", "keywords": "..."}
    `;

    function goToTab(idx) {
        document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === idx));
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
    }

    function saveKey() {
        const k = document.getElementById('apiKey').value.trim();
        if(k.startsWith('gsk_')) { localStorage.setItem('GROQ_KEY_V9', k); goToTab(1); } else alert("Invalid Key");
    }
    if(localStorage.getItem('GROQ_KEY_V9')) document.getElementById('apiKey').value = localStorage.getItem('GROQ_KEY_V9');

    document.getElementById('dropArea').addEventListener('click', () => document.getElementById('folderInput').click());

    function handleFolderSelect(files) {
        queue = [];
        const list = document.getElementById('queueList');
        list.innerHTML = "";
        const videoExts = ['.mp4', '.mov', '.avi', '.m4v'];
        let count = 0;

        for (let file of files) {
            const ext = file.name.slice(file.name.lastIndexOf('.')).toLowerCase();
            if (videoExts.includes(ext)) {
                queue.push({ id: count, file: file, name: file.name, processed: false });
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td id="prev-${count}"><div style="width:50px; height:30px; background:#f1f5f9; border-radius:4px;"></div></td>
                    <td><strong>${file.name}</strong></td>
                    <td id="status-${count}"><span class="status-badge s-wait">Pending</span></td>
                `;
                list.appendChild(tr);
                count++;
            }
        }
        if(count > 0) {
            document.getElementById('fileSummary').innerText = `${count} videos ready.`;
            document.getElementById('btnNext').style.display = 'block';
        }
    }

    async function captureFrames(file) {
        return new Promise((resolve) => {
            const video = document.getElementById('videoProcessor');
            const canvas = document.getElementById('canvasProcessor');
            const ctx = canvas.getContext('2d');
            const url = URL.createObjectURL(file);
            video.src = url;

            video.onloadedmetadata = async () => {
                const times = [video.duration * 0.2, video.duration * 0.5, video.duration * 0.8];
                let frames = [];
                for(let t of times) {
                    video.currentTime = t;
                    await new Promise(r => video.onseeked = r);
                    const scale = 400 / Math.max(video.videoWidth, video.videoHeight);
                    canvas.width = video.videoWidth * scale;
                    canvas.height = video.videoHeight * scale;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    frames.push(canvas.toDataURL('image/jpeg', 0.5));
                }
                URL.revokeObjectURL(url);
                resolve(frames);
            };
        });
    }

    async function startProcessing() {
        const k = localStorage.getItem('GROQ_KEY_V9');
        const btn = document.getElementById('btnStart');
        btn.disabled = true;

        for (let item of queue) {
            if (item.processed) continue;
            const statusEl = document.getElementById(`status-${item.id}`);
            statusEl.innerHTML = `<span class="status-badge s-run">Analyzing...</span>`;

            try {
                const frames = await captureFrames(item.file);
                document.getElementById(`prev-${item.id}`).innerHTML = `<img src="${frames[1]}" style="width:50px; height:30px; object-fit:cover; border-radius:4px;">`;

                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST", headers: { "Authorization": `Bearer ${k}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.2-11b-vision-preview",
                        messages: [{
                            role: "user",
                            content: [
                                { type: "text", text: SYSTEM_PROMPT },
                                { type: "image_url", image_url: { url: frames[0] } },
                                { type: "image_url", image_url: { url: frames[1] } },
                                { type: "image_url", image_url: { url: frames[2] } }
                            ]
                        }],
                        temperature: 0.1, response_format: { type: "json_object" }
                    })
                });

                const json = await res.json();
                if(json.error) throw new Error(json.error.message);
                
                const data = JSON.parse(json.choices[0].message.content);
                const cleaned = sanitize(data);
                
                results.push({ filename: item.name, ...cleaned });
                addResultCard(item.name, cleaned, frames);
                
                statusEl.innerHTML = `<span class="status-badge" style="background:#d1fae5; color:#065f46;">Success</span>`;
                item.processed = true;
            } catch (e) {
                console.error(e);
                statusEl.innerHTML = `<span style="color:red; font-size:10px;">Error (Console)</span>`;
            }
            await new Promise(r => setTimeout(r, 1000));
        }
        btn.disabled = false;
        btn.innerText = "Done!";
        goToTab(3);
    }

    function sanitize(data) {
        // Hapus koma dalam title dan description agar CSV tidak pecah
        return {
            title: (data.title || "").replace(/,/g, '').substring(0, 70),
            description: (data.description || "").replace(/,/g, '').substring(0, 160),
            keywords: (data.keywords || "").replace(/[^a-zA-Z, ]/g, '').toLowerCase()
        };
    }

    function addResultCard(name, data, frames) {
        const div = document.createElement('div');
        div.className = 'result-card';
        div.innerHTML = `
            <div class="frame-grid">
                <img src="${frames[1]}" class="main-frame">
                <div class="sub-frames">
                    <img src="${frames[0]}" class="sub-frame">
                    <img src="${frames[2]}" class="sub-frame">
                </div>
            </div>
            <div class="meta-content">
                <div style="font-weight:bold; color:var(--dark); font-size:16px;">${name}</div>
                <div><span class="tag-box">Title</span><div class="val-text">${data.title}</div></div>
                <div><span class="tag-box">Description</span><div class="val-text">${data.description}</div></div>
                <div><span class="tag-box">Keywords</span><div class="val-text" style="font-size:12px;">${data.keywords}</div></div>
            </div>
        `;
        document.getElementById('resultContainer').prepend(div);
    }

    function exportCSV() {
        if(results.length === 0) return;
        const base = document.getElementById('basePath').value.trim().replace(/\\$/, '');
        
        // Buat Header: Filename,Title,Description,Keywords
        let csv = "Filename,Title,Description,Keywords\n";
        
        results.forEach(r => {
            // Gunakan nama file saja untuk kolom Filename
            // Jika butuh path lengkap, ganti ${r.filename} jadi ${base}\\${r.filename}
            csv += `"${r.filename}","${r.title}","${r.description}","${r.keywords}"\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Stock_Metadata_${Date.now()}.csv`;
        link.click();
    }
</script>

</body>
</html>
