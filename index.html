<script>
    let queue = [];
    let results = [];
    const SYSTEM_PROMPT = `
    Role: Adobe Stock Metadata Specialist.
    Task: Analyze 3 frames from a video footage (start, middle, end) to provide accurate metadata.

    STRICT GUIDELINES:
    1. TITLE: Natural sentence. Max 70 characters. Structure: [Subject] [Action] [Context].
    2. DESCRIPTION: Detailed story, around 150-160 characters.
    3. KEYWORDS: 
       - Exactly 45-47 SINGLE WORDS.
       - Include colors, lighting, mood, demographics, and technical style (e.g., loop, animation, 3d, realistic).
       - EXCLUDE: "video", "footage", "clip".

    Return ONLY JSON: {"title": "...", "description": "...", "keywords": "..."}
    `;

    function goToTab(idx) {
        document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === idx));
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
    }

    function saveKey() {
        const k = document.getElementById('apiKey').value.trim();
        if(k.startsWith('gsk_')) { localStorage.setItem('GROQ_V8_KEY', k); goToTab(1); } else alert("API Key Salah!");
    }
    if(localStorage.getItem('GROQ_V8_KEY')) document.getElementById('apiKey').value = localStorage.getItem('GROQ_V8_KEY');

    document.getElementById('dropArea').addEventListener('click', () => document.getElementById('folderInput').click());

    function handleFolderSelect(files) {
        queue = [];
        document.getElementById('queueList').innerHTML = "";
        const videoExts = ['.mp4', '.mov', '.avi', '.m4v'];
        let count = 0;

        for (let file of files) {
            const ext = file.name.slice(file.name.lastIndexOf('.')).toLowerCase();
            if (videoExts.includes(ext)) {
                queue.push({ id: count, file: file, name: file.name, processed: false });
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td id="thumb-container-${count}"><div style="width:60px; height:35px; background:#ddd; border-radius:4px;"></div></td>
                    <td><strong>${file.name}</strong></td>
                    <td id="status-${count}"><span class="status-badge s-wait">Ready</span></td>
                `;
                document.getElementById('queueList').appendChild(tr);
                count++;
            }
        }
        if(count > 0) {
            document.getElementById('fileSummary').innerText = `${count} Video siap diproses.`;
            document.getElementById('btnNext').style.display = 'block';
        }
    }

    async function captureMultiFrames(file) {
        return new Promise((resolve) => {
            const video = document.getElementById('videoProcessor');
            const canvas = document.getElementById('canvasProcessor');
            const ctx = canvas.getContext('2d');
            const url = URL.createObjectURL(file);
            video.src = url;

            video.onloadedmetadata = async () => {
                const duration = video.duration;
                const timestamps = [duration * 0.2, duration * 0.5, duration * 0.8];
                let frames = [];

                for (let ts of timestamps) {
                    video.currentTime = ts;
                    await new Promise(r => video.onseeked = r);
                    const scale = 400 / Math.max(video.videoWidth, video.videoHeight);
                    canvas.width = video.videoWidth * scale;
                    canvas.height = video.videoHeight * scale;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    frames.push(canvas.toDataURL('image/jpeg', 0.6));
                }
                URL.revokeObjectURL(url);
                resolve(frames);
            };
        });
    }

    async function startProcessing() {
        const k = localStorage.getItem('GROQ_V8_KEY');
        const btn = document.getElementById('btnStart');
        btn.disabled = true; btn.innerText = "Processing...";

        for (let item of queue) {
            if (item.processed) continue;
            const statusEl = document.getElementById(`status-${item.id}`);
            statusEl.innerHTML = `<span class="status-badge s-run">Capturing Frames...</span>`;

            try {
                const frames = await captureMultiFrames(item.file);
                document.getElementById(`thumb-container-${item.id}`).innerHTML = `<img src="${frames[1]}" style="width:60px; height:35px; object-fit:cover; border-radius:4px;">`;
                
                statusEl.innerHTML = `<span class="status-badge s-run">AI Analyzing...</span>`;

                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST", headers: { "Authorization": `Bearer ${k}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "meta-llama/llama-3.2-11b-vision-preview",
                        messages: [
                            { role: "system", content: SYSTEM_PROMPT },
                            { role: "user", content: [
                                { type: "text", text: "Analyze these 3 frames from the same video (Start, Middle, End):" },
                                { type: "image_url", image_url: { url: frames[0] } },
                                { type: "image_url", image_url: { url: frames[1] } },
                                { type: "image_url", image_url: { url: frames[2] } }
                            ]}
                        ], temperature: 0.1, response_format: { type: "json_object" }
                    })
                });

                const json = await res.json();
                const content = JSON.parse(json.choices[0].message.content);
                const finalData = cleanSEO(content);

                results.push({ filename: item.name, ...finalData });
                renderResult(item, finalData, frames[1]);
                statusEl.innerHTML = `<span class="status-badge s-done">Success</span>`;
                item.processed = true;
            } catch (e) {
                statusEl.innerHTML = `<span style="color:red; font-size:10px;">Error</span>`;
            }
            await new Promise(r => setTimeout(r, 1500));
        }
        btn.disabled = false; btn.innerText = "ðŸš€ Mulai Generate"; goToTab(3);
    }

    function cleanSEO(data) {
        let kw = Array.isArray(data.keywords) ? data.keywords.join(', ') : String(data.keywords || "");
        let clean = [...new Set(kw.toLowerCase().split(/[\s,]+/).filter(w => w.length > 2))].slice(0, 47);
        while (clean.length < 45) clean.push("stock", "footage", "cinematic", "visual", "concept", "art")[clean.length % 6];
        
        return { 
            title: (data.title || "").substring(0, 70).replace(/,/g, ''), 
            description: (data.description || "").substring(0, 160).replace(/,/g, ''), 
            keywords: clean.join(', ') 
        };
    }

    function renderResult(item, data, thumb) {
        const div = document.createElement('div');
        div.className = 'result-card';
        div.innerHTML = `
            <div style="display:flex; gap:15px;">
                <img src="${thumb}" style="width:120px; height:70px; object-fit:cover; border-radius:8px; border:1px solid #eee;">
                <div style="flex:1;">
                    <div style="font-size:14px; font-weight:bold; color:var(--primary); margin-bottom:5px;">${item.name}</div>
                    <span class="field-label">Title</span><div class="field-val">${data.title}</div>
                    <span class="field-label">Description</span><div class="field-val">${data.description}</div>
                    <span class="field-label">Keywords (${data.keywords.split(',').length})</span><div class="field-val">${data.keywords}</div>
                </div>
            </div>
        `;
        document.getElementById('resultContainer').appendChild(div);
    }

    function exportCSV() {
        if (results.length === 0) return;
        // Header CSV: Pisahkan Filename, Title, Description, Keywords
        let csvContent = "Filename,Title,Description,Keywords\n";
        results.forEach(r => {
            // Gunakan quotes "" untuk menjaga agar koma di dalam teks tidak merusak kolom
            csvContent += `"${r.filename}","${r.title}","${r.description}","${r.keywords}"\n`;
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Metadata_Export_${Date.now()}.csv`;
        link.click();
    }
</script>
