<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MALES MIKIR - VIDEO EDITION</title>
    <style>
        :root { --primary: #db2777; /* Pink for Video */ --success: #10b981; --dark: #0f172a; --bg: #fdf2f8; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #334155; }
        .container { max-width: 950px; margin: auto; background: white; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); overflow: hidden; }
        
        .tabs { display: flex; background: var(--dark); }
        .tab-btn { flex: 1; padding: 18px; border: none; background: none; color: #94a3b8; cursor: pointer; font-weight: 600; transition: 0.3s; font-size: 13px; }
        .tab-btn:hover { background: #1e293b; color: white; }
        .tab-btn.active { color: white; background: var(--primary); cursor: default; border-bottom: 4px solid #f472b6; }

        .content { padding: 30px; display: none; }
        .content.active { display: block; }

        .drop-zone { border: 2px dashed #fbcfe8; padding: 40px 20px; text-align: center; border-radius: 12px; cursor: pointer; transition: 0.2s; background: #fff1f2; }
        .drop-zone:hover { border-color: var(--primary); background: #fff; }

        .input-group { margin-bottom: 20px; }
        .input-label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 13px; color: var(--dark); }
        .text-input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        .note { font-size: 11px; color: #64748b; margin-top: 5px; }

        .result-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 15px; border-left: 5px solid var(--primary); display: flex; gap: 15px; }
        .thumb-box { width: 120px; flex-shrink: 0; }
        .thumb-img { width: 100%; height: 80px; object-fit: cover; border-radius: 6px; border: 1px solid #eee; }
        .meta-box { flex-grow: 1; }

        .field-label { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-top: 10px; display: block; }
        .field-val { font-size: 12px; color: #1e293b; background: #f8fafc; padding: 8px; border-radius: 4px; border: 1px solid #f1f5f9; margin-top: 4px; }

        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; font-size: 14px; }
        .btn-pink { background: var(--primary); color: white; }
        .btn-green { background: var(--success); color: white; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; font-size: 12px; }
        
        .status-badge { padding: 3px 8px; border-radius: 12px; font-size: 9px; font-weight: bold; text-transform: uppercase; }
        .s-wait { background: #f1f5f9; color: #64748b; }
        .s-run { background: #e0e7ff; color: #4338ca; animation: blink 1s infinite; }
        .s-done { background: #d1fae5; color: #065f46; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="goToTab(0)">1. API KEY</button>
        <button class="tab-btn" onclick="goToTab(1)">2. PILIH FOLDER</button>
        <button class="tab-btn" onclick="goToTab(2)">3. PROSES VIDEO</button>
        <button class="tab-btn" onclick="goToTab(3)">4. HASIL & CSV</button>
    </div>

    <div id="c0" class="content active">
        <h2>üîë API Setup</h2>
        <div class="input-group">
            <label class="input-label">Groq API Key</label>
            <input type="password" id="apiKey" class="text-input" placeholder="gsk_xxxxxxxxxxxxxxxx">
            <p class="note">Key tersimpan di browser anda (Local Storage).</p>
        </div>
        <button class="btn btn-pink" onclick="saveKey()">Simpan & Lanjut</button>
    </div>

    <div id="c1" class="content">
        <h2>üìÅ Pilih Folder Video</h2>
        
        <div class="input-group" style="background: #fffbeeb0; padding:15px; border:1px solid #fcd34d; border-radius:8px;">
            <label class="input-label">üìç Base Absolute Path (Wajib untuk CSV)</label>
            <input type="text" id="basePath" class="text-input" placeholder="Contoh: C:\Users\Budi\Stock\Footage_Bali">
            <p class="note">
                <strong>PENTING:</strong> Browser tidak bisa membaca full path otomatis. <br>
                Silakan buka folder video anda di file explorer, copy address bar-nya, dan paste disini. <br>
                Ini agar di CSV nanti tertulis: <em>C:\Users\...\Video.mp4</em> (siap upload).
            </p>
        </div>

        <div id="dropArea" class="drop-zone">
            <span style="font-size:40px;">üé•</span><br>
            <strong>Klik untuk Pilih Folder</strong>
            <p style="font-size:12px; color:#94a3b8;">Mendukung .mp4, .mov, .avi</p>
            <input type="file" id="folderInput" webkitdirectory directory multiple style="display:none" onchange="handleFolderSelect(this.files)">
        </div>

        <div id="fileSummary" style="margin-top:20px; font-weight:bold; color:var(--primary);"></div>
        <button class="btn btn-pink" id="btnNext" style="display:none;" onclick="goToTab(2)">Generate Metadata ‚û°Ô∏è</button>
    </div>

    <div id="c2" class="content">
        <h2>‚ö° Frame Extraction & AI Processing</h2>
        <p class="note">Sistem akan mengambil screenshot otomatis dari video untuk dibaca AI.</p>
        <button class="btn btn-pink" id="btnStart" onclick="startProcessing()">üöÄ Mulai Proses</button>
        
        <div style="max-height: 400px; overflow-y: auto; margin-top:20px; border:1px solid #eee;">
            <table>
                <thead style="position:sticky; top:0; background:white;"><tr><th>Snapshot</th><th>Filename</th><th>Status</th></tr></thead>
                <tbody id="queueList"></tbody>
            </table>
        </div>
    </div>

    <div id="c3" class="content">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:20px;">
            <button class="btn btn-green" onclick="exportCSV()">üì• Download CSV (Final)</button>
            <button class="btn" style="background:#64748b; color:white;" onclick="location.reload()">üîÑ Reset Semua</button>
        </div>
        <p class="note" style="text-align:center; margin-bottom:15px;">Simpan file CSV ini di dalam folder: <strong id="displayPath">-</strong></p>
        <div id="resultContainer"></div>
    </div>

</div>

<video id="videoProcessor" style="display:none;" muted></video>
<canvas id="canvasProcessor" style="display:none;"></canvas>

<script>
    let queue = [];
    let results = [];
    const SYSTEM_PROMPT = `
    Role: Adobe Stock Metadata Specialist.
    Task: Analyze the image (frame from a video footage) for STOCK FOOTAGE metadata.

    STRICT GUIDELINES:
    1. TITLE: Natural sentence. Max 70 characters. Structure: [Subject] [Action] [Context].
    2. DESCRIPTION: Write a detailed description, exactly around 150-160 characters length.
    3. KEYWORDS: 
       - Generate 65 keywords (to be filtered down).
       - RULE: 100% MUST BE SINGLE WORDS.
       - SPLIT PHRASES: "blue and white" -> "blue", "white".
       - INCLUDE: Objects, emotions, colors, demographics, style, lighting, motion type (slow motion, timelapse if evident).
       - EXCLUDE: "video", "footage", "clip", "4k", "hd", "movie".

    Return ONLY JSON: {"title": "...", "description": "...", "keywords": "..."}
    `;

    // --- NAVIGATION ---
    function goToTab(idx) {
        document.querySelectorAll('.content').forEach((c, i) => c.classList.toggle('active', i === idx));
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
    }

    // --- API KEY ---
    function saveKey() {
        const k = document.getElementById('apiKey').value.trim();
        if(k.startsWith('gsk_')) { localStorage.setItem('GROQ_V8_KEY', k); goToTab(1); } else alert("API Key tidak valid");
    }
    if(localStorage.getItem('GROQ_V8_KEY')) document.getElementById('apiKey').value = localStorage.getItem('GROQ_V8_KEY');

    // --- FOLDER HANDLING ---
    document.getElementById('dropArea').addEventListener('click', () => document.getElementById('folderInput').click());

    function handleFolderSelect(files) {
        queue = [];
        const videoExts = ['.mp4', '.mov', '.avi', '.m4v'];
        let count = 0;

        // Validasi Base Path
        const basePath = document.getElementById('basePath').value.trim();
        if(!basePath) {
            alert("Harap isi Base Absolute Path terlebih dahulu!");
            return;
        }
        document.getElementById('displayPath').innerText = basePath;

        for (let file of files) {
            const ext = file.name.slice(file.name.lastIndexOf('.')).toLowerCase();
            if (videoExts.includes(ext)) {
                queue.push({ 
                    id: count, 
                    file: file, 
                    name: file.name, 
                    fullPath: basePath.replace(/\\$/, '') + '\\' + file.name, // Gabungkan Path + Filename
                    processed: false,
                    snapshot: null
                });
                
                // Render antrian kosong dulu
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><div style="width:50px; height:30px; background:#eee; border-radius:4px;"></div></td>
                    <td>${file.name}</td>
                    <td id="status-${count}"><span class="status-badge s-wait">Pending</span></td>
                `;
                document.getElementById('queueList').appendChild(tr);
                count++;
            }
        }

        if(count > 0) {
            document.getElementById('fileSummary').innerText = `${count} Video Ditemukan!`;
            document.getElementById('btnNext').style.display = 'block';
        } else {
            alert("Tidak ada file video di folder tersebut.");
        }
    }

    // --- VIDEO SNAPSHOT LOGIC ---
    // Mengambil frame di detik ke-1 atau 10% durasi
    async function captureFrame(file) {
        return new Promise((resolve, reject) => {
            const video = document.getElementById('videoProcessor');
            const canvas = document.getElementById('canvasProcessor');
            const ctx = canvas.getContext('2d');
            const url = URL.createObjectURL(file);

            video.src = url;
            
            video.onloadeddata = () => {
                video.currentTime = 1.5; // Ambil frame di detik 1.5
            };

            video.onseeked = () => {
                // Resize agar tidak terlalu berat buat upload
                const scale = 500 / Math.max(video.videoWidth, video.videoHeight);
                canvas.width = video.videoWidth * scale;
                canvas.height = video.videoHeight * scale;
                
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const base64 = canvas.toDataURL('image/jpeg', 0.6).split(',')[1];
                const previewUrl = canvas.toDataURL('image/jpeg', 0.6);
                
                URL.revokeObjectURL(url); // Bersihkan memori
                resolve({ base64, previewUrl });
            };

            video.onerror = (e) => {
                URL.revokeObjectURL(url);
                reject("Gagal load video");
            };
        });
    }

    // --- PROCESSING LOOP ---
    async function startProcessing() {
        const k = localStorage.getItem('GROQ_V8_KEY');
        const btn = document.getElementById('btnStart');
        btn.disabled = true; btn.innerText = "Sedang Memproses...";

        for (let item of queue) {
            if (item.processed) continue;

            const statusEl = document.getElementById(`status-${item.id}`);
            statusEl.innerHTML = `<span class="status-badge s-run">Snapshot...</span>`;

            try {
                // 1. Ambil Snapshot
                const snap = await captureFrame(item.file);
                item.snapshot = snap.previewUrl;
                
                // Update table preview
                const row = statusEl.parentElement;
                row.cells[0].innerHTML = `<img src="${snap.previewUrl}" class="img-mini" style="width:50px; height:30px; object-fit:cover;">`;

                statusEl.innerHTML = `<span class="status-badge s-run">AI Generating...</span>`;

                // 2. Kirim ke Groq
                const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST", headers: { "Authorization": `Bearer ${k}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "meta-llama/llama-4-scout-17b-16e-instruct", 
                        messages: [
                            { role: "system", content: SYSTEM_PROMPT },
                            { role: "user", content: [{ type: "text", text: "Metadata:" }, { type: "image_url", image_url: { url: `data:image/jpeg;base64,${snap.base64}` } }] }
                        ], temperature: 0.1, response_format: { type: "json_object" }
                    })
                });

                const json = await res.json();
                if (json.error) throw new Error(json.error.message);

                // 3. Bersihkan Data
                const rawData = JSON.parse(json.choices[0].message.content);
                const cleanData = cleanSEO(rawData);

                // 4. Simpan Hasil
                results.push({ ...item, ...cleanData }); // Merge file info + metadata
                renderResultCard(item, cleanData);

                statusEl.innerHTML = `<span class="status-badge s-done">DONE</span>`;
                item.processed = true;

            } catch (e) {
                console.error(e);
                statusEl.innerHTML = `<span style="color:red; font-size:9px;">Error</span>`;
            }

            await new Promise(r => setTimeout(r, 1500)); // Jeda agar tidak limit
        }

        btn.disabled = false; btn.innerText = "Selesai!";
        goToTab(3);
    }

    // --- FILTER KEYWORDS (Sama seperti sebelumnya) ---
    function cleanSEO(data) {
        const junk = ['and', 'the', 'with', 'for', 'from', 'video', 'clip', 'footage', 'background', 'view', 'shot']; // Junk dasar
        const banned = ['4k', '8k', 'hd', 'uhd', 'fps'];
        
        let kwSource = Array.isArray(data.keywords) ? data.keywords.join(', ') : String(data.keywords || "");
        let processed = [];

        kwSource.toLowerCase().split(',').forEach(word => {
            word = word.trim().replace(/[^a-z0-9]/g, ' ');
            word.split(/\s+/).forEach(sw => { if (sw.length > 2) processed.push(sw); });
        });

        let clean = processed.filter(w => !junk.includes(w) && !banned.includes(w) && !/\d/.test(w));
        clean = [...new Set(clean)];

        // Target 45-47
        if (clean.length > 47) clean = clean.slice(0, 47);
        
        const fillers = ['motion', 'dynamic', 'scene', 'visual', 'cinematic', 'stock', 'art', 'style', 'concept', 'modern', 'color', 'light'];
        let i = 0;
        while (clean.length < 45 && i < fillers.length) {
            if (!clean.includes(fillers[i])) clean.push(fillers[i]);
            i++;
        }

        return { 
            title: (data.title || "").substring(0, 70), 
            description: (data.description || ""), 
            keywords: clean.join(', ') 
        };
    }

    // --- RENDER CARD ---
    function renderResultCard(item, data) {
        const div = document.createElement('div');
        div.className = 'result-card';
        div.innerHTML = `
            <div class="thumb-box">
                <img src="${item.snapshot}" class="thumb-img">
                <div style="font-size:10px; word-break:break-all; margin-top:5px; font-weight:bold;">${item.name}</div>
            </div>
            <div class="meta-box">
                <span class="field-label">TITLE</span>
                <div class="field-val">${data.title}</div>
                
                <span class="field-label">DESCRIPTION</span>
                <div class="field-val">${data.description}</div>
                
                <span class="field-label">KEYWORDS (${data.keywords.split(',').length})</span>
                <div class="field-val">${data.keywords}</div>
            </div>
        `;
        document.getElementById('resultContainer').appendChild(div);
    }

    // --- EXPORT CSV ---
    function exportCSV() {
        if(results.length === 0) { alert("Belum ada data!"); return; }

        // Header CSV Standard
        let csv = "Filename,Title,Description,Keywords,Category\n";
        
        results.forEach(r => {
            // Kita pakai "fullPath" di kolom Filename agar saat upload CSV + Video, platform tahu pasangannya
            // Escape quote dalam teks jika ada
            const t = r.title.replace(/"/g, '""');
            const d = r.description.replace(/"/g, '""');
            const k = r.keywords.replace(/"/g, '""');
            
            // Format: "FullPath","Title","Desc","Keywords"
            csv += `"${r.fullPath}","${t}","${d}","${k}","21"\n`; // Category 21 = People/General (Default)
        });

        const blob = new Blob([csv], {type: "text/csv;charset=utf-8;"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Metadata_Video_${Date.now()}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>

</body>
</html>
