<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>AI Video Metadata Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Segoe UI,sans-serif;background:#fdf2f8;margin:0;padding:20px}
.container{max-width:1000px;margin:auto;background:#fff;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.08)}
.tabs{display:flex;background:#0f172a}
.tab-btn{flex:1;padding:16px;border:none;background:none;color:#94a3b8;font-weight:700;cursor:pointer}
.tab-btn.active{background:#db2777;color:#fff}
.content{display:none;padding:30px}
.content.active{display:block}
input,button{width:100%;padding:12px;border-radius:8px;border:1px solid #cbd5e1}
button{background:#db2777;color:#fff;font-weight:700;border:none;cursor:pointer}
button:disabled{opacity:.6}
table{width:100%;border-collapse:collapse;margin-top:15px}
th,td{padding:10px;border-bottom:1px solid #eee;font-size:12px}
.thumb{width:80px;height:50px;object-fit:cover;border-radius:6px}
.result{border-left:5px solid #db2777;padding:15px;margin-bottom:12px}
small{color:#64748b}
</style>
</head>
<body>

<div class="container">
<div class="tabs">
<button class="tab-btn active" onclick="goTab(0)">1. API</button>
<button class="tab-btn" onclick="goTab(1)">2. Folder</button>
<button class="tab-btn" onclick="goTab(2)">3. Proses</button>
<button class="tab-btn" onclick="goTab(3)">4. Hasil</button>
</div>

<div id="tab0" class="content active">
<h3>üîë Groq API Key</h3>
<input id="apiKey" placeholder="gsk_xxxxx">
<br><br>
<button onclick="saveKey()">Simpan & Lanjut</button>
</div>

<div id="tab1" class="content">
<h3>üìÅ Pilih Folder Video</h3>
<input type="file" id="folder" webkitdirectory multiple>
<br><br>
<button onclick="prepareFiles()">Lanjut</button>
<p id="info"></p>
</div>

<div id="tab2" class="content">
<h3>‚öôÔ∏è Proses Video</h3>
<button id="startBtn" onclick="processAll()">Mulai Proses</button>
<table>
<thead><tr><th>Preview</th><th>Filename</th><th>Status</th></tr></thead>
<tbody id="queue"></tbody>
</table>
</div>

<div id="tab3" class="content">
<button onclick="downloadCSV()">‚¨á Download CSV</button>
<div id="results"></div>
</div>
</div>

<video id="video" muted playsinline style="display:none"></video>
<canvas id="canvas" style="display:none"></canvas>

<script>
let files=[], results=[];

const PROMPT = `
You are a PROFESSIONAL MICROSTOCK VIDEO METADATA EXPERT.

RULES:
TITLE:
- Natural sentence
- Max 70 characters

DESCRIPTION:
- Around 150 characters
- Clear visual explanation

KEYWORDS:
- EXACTLY 45 keywords
- SINGLE WORD only
- MUST include: film, burn
- SEO microstock friendly
- No video, footage, clip, hd, 4k

Analyze ALL images as ONE video.
Return ONLY JSON:
{"title":"","description":"","keywords":""}
`;

function goTab(i){
document.querySelectorAll('.content').forEach((c,n)=>c.classList.toggle('active',n===i));
document.querySelectorAll('.tab-btn').forEach((b,n)=>b.classList.toggle('active',n===i));
}

function saveKey(){
localStorage.setItem("GROQ_KEY", apiKey.value.trim());
goTab(1);
}

function prepareFiles(){
const input=document.getElementById("folder");
files=[...input.files].filter(f=>/\.(mp4|mov|avi|m4v)$/i.test(f.name));
info.innerText=files.length+" video ditemukan";
queue.innerHTML="";
files.forEach((f,i)=>{
queue.innerHTML+=`
<tr id="row${i}">
<td>-</td>
<td>${f.name}</td>
<td>Pending</td>
</tr>`;
});
goTab(2);
}

async function grabFrames(file){
return new Promise((resolve,reject)=>{
const v=document.getElementById("video");
const c=document.getElementById("canvas");
const ctx=c.getContext("2d");
const url=URL.createObjectURL(file);

v.src=url;
v.load();

v.onloadedmetadata=async()=>{
const times=[0.05,0.5,0.95];
let imgs=[];
for(let t of times){
v.currentTime=Math.max(0.1,v.duration*t);
await new Promise(r=>v.onseeked=r);
c.width=640;c.height=360;
ctx.drawImage(v,0,0,640,360);
imgs.push(c.toDataURL("image/jpeg",0.7).split(",")[1]);
}
URL.revokeObjectURL(url);
resolve(imgs);
};
v.onerror=()=>reject("Video error");
});
}

async function processAll(){
document.getElementById("startBtn").disabled=true;
for(let i=0;i<files.length;i++){
const row=document.getElementById(`row${i}`);
row.cells[2].innerText="Snapshot...";
const imgs=await grabFrames(files[i]);

row.cells[0].innerHTML=`<img class="thumb" src="data:image/jpeg;base64,${imgs[1]}">`;
row.cells[2].innerText="AI...";

const res=await fetch("https://api.groq.com/openai/v1/chat/completions",{
method:"POST",
headers:{
"Authorization":"Bearer "+localStorage.getItem("GROQ_KEY"),
"Content-Type":"application/json"
},
body:JSON.stringify({
model:"meta-llama/llama-4-scout-17b-16e-instruct",
messages:[
{role:"system",content:PROMPT},
{role:"user",content:imgs.map(i=>({type:"image_url",image_url:{url:"data:image/jpeg;base64,"+i}}))}
],
temperature:0.2,
response_format:{type:"json_object"}
})
});

const j=await res.json();
const d=JSON.parse(j.choices[0].message.content);

results.push({
filename:files[i].name,
title:d.title.slice(0,70),
description:d.description.slice(0,160),
keywords:d.keywords.split(",").slice(0,45).join(",")
});

row.cells[2].innerText="Done";
}
renderResults();
goTab(3);
}

function renderResults(){
const box=document.getElementById("results");
box.innerHTML="";
results.forEach(r=>{
box.innerHTML+=`
<div class="result">
<b>${r.filename}</b><br>
<strong>${r.title}</strong><br>
<small>${r.description}</small><br>
<small>${r.keywords}</small>
</div>`;
});
}

function downloadCSV(){
let csv="filename,title,description,keywords\n";
results.forEach(r=>{
csv+=`"${r.filename}","${r.title}","${r.description}","${r.keywords}"\n`;
});
const blob=new Blob([csv],{type:"text/csv"});
const a=document.createElement("a");
a.href=URL.createObjectURL(blob);
a.download="video_metadata.csv";
a.click();
}
</script>

</body>
</html>
