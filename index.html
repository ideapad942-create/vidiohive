<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microstock Metadata Pro - Final Stable</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --bg: #f9fafb;
            --card: #ffffff;
            --text: #111827;
            --border: #e5e7eb;
            --success: #10b981;
            --error: #ef4444;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR */
        aside { width: 320px; background: #1e293b; color: white; padding: 25px; display: flex; flex-direction: column; flex-shrink: 0; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .logo { font-size: 20px; font-weight: 800; color: #818cf8; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .logo span { color: white; }

        .control-group { margin-bottom: 20px; }
        .label { font-size: 11px; font-weight: 700; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; display: block; }
        .input-dark { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px; font-size: 13px; outline: none; box-sizing: border-box; }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 10px; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #4338ca; }
        .btn-success { background: var(--success); color: white; margin-top: 15px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* MAIN CONTENT */
        main { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; display: flex; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); min-height: 280px; }

        .card-left { width: 280px; background: #f8fafc; border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .filmstrip { width: 100%; border-radius: 8px; border: 1px solid #cbd5e1; background: #e2e8f0; aspect-ratio: 16/9; object-fit: cover; }
        .filename { font-size: 12px; font-weight: 700; word-break: break-all; color: #374151; }
        .badge-cat { background: #e0e7ff; color: #4338ca; font-size: 10px; padding: 5px 10px; border-radius: 6px; font-weight: 800; text-transform: uppercase; text-align: center; border: 1px solid #c7d2fe; }

        .card-right { flex: 1; padding: 25px; display: flex; flex-direction: column; gap: 18px; }
        .field-box { display: flex; flex-direction: column; gap: 6px; }
        .field-head { display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; color: #6b7280; text-transform: uppercase; }
        
        .input-text { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 14px; box-sizing: border-box; background: #fff; }
        .input-text:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        textarea.input-text { min-height: 80px; resize: vertical; }

        .status-ok { color: var(--success); }
        .status-bad { color: var(--error); }
        .border-bad { border-color: var(--error) !important; background: #fff1f2 !important; }

        /* UTILS */
        .spinner { width: 16px; height: 16px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<aside>
    <div class="logo">‚ö° Microstock <span>Pro</span></div>
    
    <div class="control-group">
        <label class="label">1. Groq API Key</label>
        <input type="password" id="apiKey" class="input-dark" placeholder="gsk_...">
    </div>

    <div class="control-group">
        <label class="label">2. Pilih Folder Video</label>
        <input type="file" id="fileInput" class="input-dark" webkitdirectory directory multiple>
    </div>

    <button id="btnProcess" class="btn btn-primary" onclick="startQueue()">
        <span class="spinner" id="loader"></span>
        <span>Mulai Analisis AI</span>
    </button>

    <button id="btnExport" class="btn btn-success" onclick="exportCSV()" style="display:none;">
        <span>Download CSV</span>
    </button>

    <div style="margin-top: auto; font-size: 11px; color: #94a3b8; line-height: 1.6; background: #0f172a; padding: 15px; border-radius: 8px;">
        <strong>Sistem Verifikasi Otomatis:</strong><br>
        ‚Ä¢ Judul: 50-70 Karakter<br>
        ‚Ä¢ Deskripsi: 100-150 Karakter<br>
        ‚Ä¢ Keyword: <strong>TERKUNCI 45-48 Kata</strong><br>
        ‚Ä¢ Analisis 3-Frame Diaktifkan
    </div>
</aside>

<main id="mainContent">
    <div style="text-align:center; margin-top:150px; color:#94a3b8;">
        <h3 style="margin:0;">üìÅ Belum ada file yang dipilih</h3>
        <p style="font-size:14px;">Silakan pilih folder video di sidebar untuk memulai.</p>
    </div>
</main>

<video id="vCore" style="display:none;" muted playsinline></video>
<canvas id="cCore" style="display:none;"></canvas>

<script>
    const CATEGORIES_LIST = `backgrounds, backgrounds/3d-object, backgrounds/abstract, backgrounds/cartoons, backgrounds/corporate, backgrounds/electric, backgrounds/events, backgrounds/fire, backgrounds/grunge, backgrounds/industrial, backgrounds/kids, backgrounds/light, backgrounds/medical, backgrounds/nature, backgrounds/retro, backgrounds/sky-clouds, backgrounds/space, backgrounds/sports, backgrounds/technology, backgrounds/water, backgrounds/miscellaneous, bugs, bugs/3d-object, bugs/abstract, bugs/cartoons, bugs/corporate, bugs/electric, bugs/events, bugs/fire, bugs/grunge, bugs/industrial, bugs/kids, bugs/light, bugs/medical, bugs/nature, bugs/retro, bugs/sky-clouds, bugs/space, bugs/sports, bugs/technology, bugs/water, bugs/miscellaneous, distortions, elements, elements/3d-object, elements/abstract, elements/cartoons, elements/corporate, elements/electric, elements/events, elements/fire, elements/grunge, elements/industrial, elements/kids, elements/light, elements/medical, elements/nature, elements/retro, elements/sky-clouds, elements/space, elements/sports, elements/technology, elements/water, elements/miscellaneous, interface-effects, interface-effects/3d-object, interface-effects/abstract, interface-effects/cartoons, interface-effects/corporate, interface-effects/electric, interface-effects/events, interface-effects/fire, interface-effects/grunge, interface-effects/industrial, interface-effects/kids, interface-effects/light, interface-effects/medical, interface-effects/nature, interface-effects/retro, interface-effects/sky-clouds, interface-effects/space, interface-effects/sports, interface-effects/technology, interface-effects/water, interface-effects/miscellaneous, lower-thirds, lower-thirds/3d-object, lower-thirds/abstract, lower-thirds/cartoons, lower-thirds/corporate, lower-thirds/electric, lower-thirds/events, lower-thirds/fire, lower-thirds/grunge, lower-thirds/industrial, lower-thirds/kids, lower-thirds/light, lower-thirds/medical, lower-thirds/nature, lower-thirds/retro, lower-thirds/sky-clouds, lower-thirds/space, lower-thirds/sports, lower-thirds/technology, lower-thirds/water, lower-thirds/miscellaneous, overlays, overlays/3d-object, overlays/abstract, overlays/cartoons, overlays/corporate, overlays/electric, overlays/events, overlays/fire, overlays/grunge, overlays/industrial, overlays/kids, overlays/light, overlays/medical, overlays/nature, overlays/retro, overlays/sky-clouds, overlays/space, overlays/sports, overlays/technology, overlays/water, overlays/miscellaneous, particles, revealer, revealer/3d-object, revealer/abstract, revealer/cartoons, revealer/corporate, revealer/electric, revealer/events, revealer/fire, revealer/grunge, revealer/industrial, revealer/kids, revealer/light, revealer/medical, revealer/nature, revealer/retro, revealer/sky-clouds, revealer/space, revealer/sports, revealer/technology, revealer/water, revealer/miscellaneous, transitions, transitions/3d-object, transitions/abstract, transitions/cartoons, transitions/corporate, transitions/electric, transitions/events, transitions/fire, transitions/grunge, transitions/industrial, transitions/kids, transitions/light, transitions/medical, transitions/nature, transitions/retro, transitions/sky-clouds, transitions/space, transitions/sports, transitions/technology, transitions/water, transitions/miscellaneous, water-and-fluid, miscellaneous, miscellaneous/3d-object, miscellaneous/abstract, miscellaneous/cartoons, miscellaneous/corporate, miscellaneous/electric, miscellaneous/events, miscellaneous/fire, miscellaneous/grunge, miscellaneous/industrial, miscellaneous/kids, miscellaneous/light, miscellaneous/medical, miscellaneous/nature, miscellaneous/retro, miscellaneous/sky-clouds, miscellaneous/space, miscellaneous/sports, miscellaneous/technology, miscellaneous/water, miscellaneous/miscellaneous, infographics`;

    const BACKUP_KEYWORDS = ["video", "footage", "clip", "stock", "background", "motion", "4k", "hd", "graphic", "abstract", "digital", "creative", "media", "presentation", "concept", "style", "modern", "design", "element", "high resolution"];

    const RULES = { minT: 50, maxT: 70, minD: 100, maxD: 150, minK: 45, maxK: 48 };
    let filesArr = [];

    if(localStorage.getItem('GROQ_KEY')) document.getElementById('apiKey').value = localStorage.getItem('GROQ_KEY');

    document.getElementById('fileInput').addEventListener('change', (e) => {
        const files = Array.from(e.target.files).filter(f => f.type.startsWith('video/'));
        const main = document.getElementById('mainContent');
        main.innerHTML = '';
        filesArr = files.map((file, idx) => ({ file, id: idx }));

        filesArr.forEach(item => {
            const html = `
            <div class="card" id="card-${item.id}">
                <div class="card-left">
                    <div class="filename">${item.file.name}</div>
                    <div id="thumb-${item.id}" style="width:100%;"><div class="filmstrip" style="display:flex;align-items:center;justify-content:center;font-size:10px;">Menunggu...</div></div>
                    <div class="badge-cat" id="cat-badge-${item.id}">Analisis...</div>
                    <input type="hidden" id="cat-${item.id}">
                </div>
                <div class="card-right">
                    <div class="field-box">
                        <div class="field-head"><span>Judul (${RULES.minT}-${RULES.maxT})</span><span id="cnt-t-${item.id}">0</span></div>
                        <input type="text" class="input-text" id="title-${item.id}" oninput="val(${item.id})">
                    </div>
                    <div class="field-box">
                        <div class="field-head"><span>Deskripsi (${RULES.minD}-${RULES.maxD})</span><span id="cnt-d-${item.id}">0</span></div>
                        <textarea class="input-text" id="desc-${item.id}" oninput="val(${item.id})"></textarea>
                    </div>
                    <div class="field-box">
                        <div class="field-head"><span>Keyword (${RULES.minK}-${RULES.maxK})</span><span id="cnt-k-${item.id}">0</span></div>
                        <textarea class="input-text" id="kw-${item.id}" oninput="val(${item.id})"></textarea>
                    </div>
                </div>
            </div>`;
            main.insertAdjacentHTML('beforeend', html);
        });
    });

    async function startQueue() {
        const key = document.getElementById('apiKey').value.trim();
        if(!key) return alert("Masukkan API Key!");
        localStorage.setItem('GROQ_KEY', key);

        document.getElementById('btnProcess').disabled = true;
        document.getElementById('loader').style.display = 'block';

        for(const item of filesArr) {
            const id = item.id;
            try {
                const base64 = await captureFrames(item.file);
                document.getElementById(`thumb-${id}`).innerHTML = `<img src="${base64}" class="filmstrip">`;

                const ai = await callAI(key, base64);
                
                // --- CATEGORY ---
                const rawCat = ai.category || "miscellaneous";
                const matchedCat = CATEGORIES_LIST.split(',').map(c => c.trim()).find(c => rawCat.toLowerCase().includes(c.toLowerCase())) || "miscellaneous";
                document.getElementById(`cat-${id}`).value = matchedCat;
                document.getElementById(`cat-badge-${id}`).innerText = matchedCat;

                // --- TITLE ---
                let t = ai.title || "";
                if(t.length < RULES.minT) t += " - High Quality 4K Stock Footage Clip";
                if(t.length > RULES.maxT) t = t.substring(0, RULES.maxT).substring(0, t.substring(0, RULES.maxT).lastIndexOf(" ")) || t.substring(0, RULES.maxT);
                document.getElementById(`title-${id}`).value = t;

                // --- DESCRIPTION ---
                let d = ai.description || "";
                if(d.length < RULES.minD) d += " This professional clip is ideal for creative projects, presentations, and digital media background visuals.";
                if(d.length > RULES.maxD) d = d.substring(0, RULES.maxD).substring(0, d.substring(0, RULES.maxD).lastIndexOf(" ")) + "." || d.substring(0, RULES.maxD);
                document.getElementById(`desc-${id}`).value = d;

                // --- KEYWORD ENGINE ---
                let kws = (ai.keywords || "").replace(/\./g, '').split(',').map(k => k.trim().toLowerCase()).filter(k => k.length > 2);
                let kFinal = [];
                kws.forEach(k => { if(k.includes(' ')) kFinal.push(...k.split(' ')); else kFinal.push(k); });
                kFinal = [...new Set(kFinal)];

                if(kFinal.length < RULES.minK) {
                    BACKUP_KEYWORDS.forEach(bk => { if(kFinal.length < RULES.minK && !kFinal.includes(bk)) kFinal.push(bk); });
                }
                if(kFinal.length > RULES.maxK) kFinal = kFinal.slice(0, RULES.maxK);
                document.getElementById(`kw-${id}`).value = kFinal.join(', ');

                val(id);
                document.getElementById(`card-${id}`).style.borderColor = "#10b981";
            } catch(e) {
                console.error(id, e);
                document.getElementById(`cat-badge-${id}`).innerText = "Gagal";
                document.getElementById(`cat-badge-${id}`).style.background = "#fee2e2";
            }
            await new Promise(r => setTimeout(r, 1000));
        }

        document.getElementById('btnProcess').disabled = false;
        document.getElementById('loader').style.display = 'none';
        document.getElementById('btnExport').style.display = 'flex';
        alert("Proses Selesai!");
    }

    function val(id) {
        const t = document.getElementById(`title-${id}`).value;
        const tC = document.getElementById(`cnt-t-${id}`);
        tC.innerText = t.length;
        tC.className = (t.length >= RULES.minT && t.length <= RULES.maxT) ? "status-ok" : "status-bad";

        const d = document.getElementById(`desc-${id}`).value;
        const dC = document.getElementById(`cnt-d-${id}`);
        dC.innerText = d.length;
        dC.className = (d.length >= RULES.minD && d.length <= RULES.maxD) ? "status-ok" : "status-bad";

        const k = document.getElementById(`kw-${id}`).value.split(',').filter(x => x.trim().length > 0);
        const kC = document.getElementById(`cnt-k-${id}`);
        kC.innerText = k.length;
        kC.className = (k.length >= RULES.minK && k.length <= RULES.maxK) ? "status-ok" : "status-bad";
    }

    function captureFrames(file) {
        return new Promise((resolve) => {
            const v = document.getElementById('vCore');
            const c = document.getElementById('cCore');
            const ctx = c.getContext('2d');
            const url = URL.createObjectURL(file);
            v.src = url;
            v.onloadedmetadata = async () => {
                const w=320, h=180;
                c.width = w*3; c.height = h;
                const snap = (time) => new Promise(res => { v.currentTime = time; v.onseeked = () => res(); });
                await snap(v.duration * 0.1); ctx.drawImage(v,0,0,v.videoWidth,v.videoHeight,0,0,w,h);
                await snap(v.duration * 0.5); ctx.drawImage(v,0,0,v.videoWidth,v.videoHeight,w,0,w,h);
                await snap(v.duration * 0.9); ctx.drawImage(v,0,0,v.videoWidth,v.videoHeight,w*2,0,w,h);
                resolve(c.toDataURL('image/jpeg', 0.8));
                URL.revokeObjectURL(url);
            };
        });
    }

    async function callAI(key, base64) {
        const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
            body: JSON.stringify({
                model: "meta-llama/llama-4-scout-17b-16e-instruct",
                messages: [{ role: "system", content: `Role: Microstock Pro. Analyze 3 frames. JSON ONLY. Category from: [${CATEGORIES_LIST}]. Title: 50-70 chars. Desc: 100-150 chars. Keywords: 60 single words.` }, { role: "user", content: [{ type: "image_url", image_url: { url: base64 } }] }],
                temperature: 0.1, response_format: { type: "json_object" }
            })
        });
        const json = await resp.json();
        return JSON.parse(json.choices[0].message.content);
    }

    function exportCSV() {
        let csv = "Filename,Title,Description,Keywords,Category\n";
        filesArr.forEach(item => {
            const id = item.id;
            const t = document.getElementById(`title-${id}`).value.replace(/"/g, '""');
            const d = document.getElementById(`desc-${id}`).value.replace(/"/g, '""');
            const k = document.getElementById(`kw-${id}`).value.replace(/"/g, '""');
            const c = document.getElementById(`cat-${id}`).value.replace(/"/g, '""');
            if(t) csv += `"${item.file.name}","${t}","${d}","${k}","${c}"\n`;
        });
        const blob = new Blob([csv], {type:'text/csv'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `microstock_final_${Date.now()}.csv`;
        a.click();
    }
</script>
</body>
</html>
