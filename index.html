<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microstock Metadata Pro - Smart Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #0f172a;
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
        }
        
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; background: var(--surface); border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); overflow: hidden; }
        
        /* HEADER */
        .header { background: #1e293b; color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; font-size: 18px; font-weight: 700; letter-spacing: 0.5px; }
        
        /* CONTROLS */
        .controls { padding: 20px; border-bottom: 1px solid var(--border); display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end; background: #f1f5f9; }
        .input-group label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; color: #475569; text-transform: uppercase; }
        .input-field { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; transition: 0.2s; height: 42px; }
        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: var(--success); }
        .btn-success:hover { background: #16a34a; }

        /* TABLE */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { background: #f8fafc; padding: 12px 15px; text-align: left; font-weight: 600; color: #64748b; border-bottom: 1px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid var(--border); vertical-align: top; }
        tr:hover { background: #f8fafc; }

        /* INPUTS IN TABLE */
        .meta-wrapper { position: relative; margin-bottom: 10px; }
        .meta-label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; font-weight: 600; color: #64748b; }
        
        .meta-input { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 13px; transition: 0.2s; background: #fff; }
        .meta-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        textarea.meta-input { min-height: 60px; resize: vertical; line-height: 1.4; }

        /* VALIDATION STYLES */
        .count-ok { color: var(--success); }
        .count-warn { color: var(--warning); }
        .count-err { color: var(--error); font-weight: bold; }
        .border-err { border-color: var(--error) !important; background: #fef2f2; }
        
        .preview-box { width: 220px; border-radius: 6px; overflow: hidden; border: 1px solid var(--border); }
        .preview-box img { width: 100%; display: block; }
        .cat-badge { display: inline-block; background: #e0f2fe; color: #0369a1; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-top: 5px; border: 1px solid #bae6fd; }

        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .dot-grey { background: #cbd5e1; }
        .dot-blue { background: #3b82f6; animation: pulse 1s infinite; }
        .dot-green { background: #22c55e; }
        .dot-red { background: #ef4444; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üéûÔ∏è Metadata Generator (Smart Context Fix)</h1>
        <div style="font-size: 12px; opacity: 0.8;">Format: Filename,Title,Desc,Kw,Category</div>
    </div>

    <div class="controls">
        <div class="input-group">
            <label>1. Groq API Key (Llama 4 Vision)</label>
            <input type="password" id="apiKey" class="input-field" placeholder="gsk_xxxxxxxx...">
        </div>
        <div class="input-group">
            <label>2. Pilih Folder Video</label>
            <input type="file" id="fileInput" class="input-field" webkitdirectory directory multiple>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-primary" id="btnProcess" onclick="startProcessing()">üöÄ Mulai Proses</button>
            <button class="btn btn-success" id="btnExport" onclick="exportCSV()" style="display:none;">üì• Download CSV</button>
        </div>
    </div>
    
    <div id="statusMsg" style="padding: 10px 20px; font-size: 13px; font-weight: 600; color: var(--primary);"></div>

    <div class="table-container">
        <table id="resultTable">
            <thead>
                <tr>
                    <th style="width: 240px;">Media Info</th>
                    <th>Metadata Editor (Auto-Corrected)</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>
</div>

<video id="hiddenVideo" style="display:none;" muted playsinline></video>
<canvas id="hiddenCanvas" style="display:none;"></canvas>

<script>
    // --- DATABASE KATEGORI (UPDATED FULL LIST) ---
    const CATEGORIES_LIST = `
backgrounds, backgrounds/3d-object, backgrounds/abstract, backgrounds/cartoons, backgrounds/corporate, backgrounds/electric, backgrounds/events, backgrounds/fire, backgrounds/grunge, backgrounds/industrial, backgrounds/kids, backgrounds/light, backgrounds/medical, backgrounds/nature, backgrounds/retro, backgrounds/sky-clouds, backgrounds/space, backgrounds/sports, backgrounds/technology, backgrounds/water, backgrounds/miscellaneous,
bugs, bugs/3d-object, bugs/abstract, bugs/cartoons, bugs/corporate, bugs/electric, bugs/events, bugs/fire, bugs/grunge, bugs/industrial, bugs/kids, bugs/light, bugs/medical, bugs/nature, bugs/retro, bugs/sky-clouds, bugs/space, bugs/sports, bugs/technology, bugs/water, bugs/miscellaneous,
distortions,
elements, elements/3d-object, elements/abstract, elements/cartoons, elements/corporate, elements/electric, elements/events, elements/fire, elements/grunge, elements/industrial, elements/kids, elements/light, elements/medical, elements/nature, elements/retro, elements/sky-clouds, elements/space, elements/sports, elements/technology, elements/water, elements/miscellaneous,
interface-effects, interface-effects/3d-object, interface-effects/abstract, interface-effects/cartoons, interface-effects/corporate, interface-effects/electric, interface-effects/events, interface-effects/fire, interface-effects/grunge, interface-effects/industrial, interface-effects/kids, interface-effects/light, interface-effects/medical, interface-effects/nature, interface-effects/retro, interface-effects/sky-clouds, interface-effects/space, interface-effects/sports, interface-effects/technology, interface-effects/water, interface-effects/miscellaneous,
lower-thirds, lower-thirds/3d-object, lower-thirds/abstract, lower-thirds/cartoons, lower-thirds/corporate, lower-thirds/electric, lower-thirds/events, lower-thirds/fire, lower-thirds/grunge, lower-thirds/industrial, lower-thirds/kids, lower-thirds/light, lower-thirds/medical, lower-thirds/nature, lower-thirds/retro, lower-thirds/sky-clouds, lower-thirds/space, lower-thirds/sports, lower-thirds/technology, lower-thirds/water, lower-thirds/miscellaneous,
overlays, overlays/3d-object, overlays/abstract, overlays/cartoons, overlays/corporate, overlays/electric, overlays/events, overlays/fire, overlays/grunge, overlays/industrial, overlays/kids, overlays/light, overlays/medical, overlays/nature, overlays/retro, overlays/sky-clouds, overlays/space, overlays/sports, overlays/technology, overlays/water, overlays/miscellaneous,
particles,
revealer, revealer/3d-object, revealer/abstract, revealer/cartoons, revealer/corporate, revealer/electric, revealer/events, revealer/fire, revealer/grunge, revealer/industrial, revealer/kids, revealer/light, revealer/medical, revealer/nature, revealer/retro, revealer/sky-clouds, revealer/space, revealer/sports, revealer/technology, revealer/water, revealer/miscellaneous,
transitions, transitions/3d-object, transitions/abstract, transitions/cartoons, transitions/corporate, transitions/electric, transitions/events, transitions/fire, transitions/grunge, transitions/industrial, transitions/kids, transitions/light, transitions/medical, transitions/nature, transitions/retro, transitions/sky-clouds, transitions/space, transitions/sports, transitions/technology, transitions/water, transitions/miscellaneous,
water-and-fluid,
miscellaneous, miscellaneous/3d-object, miscellaneous/abstract, miscellaneous/cartoons, miscellaneous/corporate, miscellaneous/electric, miscellaneous/events, miscellaneous/fire, miscellaneous/grunge, miscellaneous/industrial, miscellaneous/kids, miscellaneous/light, miscellaneous/medical, miscellaneous/nature, miscellaneous/retro, miscellaneous/sky-clouds, miscellaneous/space, miscellaneous/sports, miscellaneous/technology, miscellaneous/water, miscellaneous/miscellaneous,
infographics
    `;

    // --- CONFIG ---
    const MIN_TITLE = 50, MAX_TITLE = 70;
    const MIN_DESC = 100, MAX_DESC = 150;
    const MIN_KW = 45, MAX_KW = 48; 
    const GROQ_MODEL = "meta-llama/llama-4-scout-17b-16e-instruct";

    let fileQueue = [];
    let isProcessing = false;

    if(localStorage.getItem('GROQ_KEY')) document.getElementById('apiKey').value = localStorage.getItem('GROQ_KEY');

    // --- FILE HANDLING ---
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const files = Array.from(e.target.files).filter(f => f.type.startsWith('video/'));
        const tbody = document.querySelector('#resultTable tbody');
        tbody.innerHTML = '';
        fileQueue = [];

        if(files.length === 0) return;

        files.forEach((file, index) => {
            fileQueue.push({ file, id: index });
            
            const tr = document.createElement('tr');
            tr.id = `row-${index}`;
            tr.innerHTML = `
                <td>
                    <div class="preview-box" id="preview-${index}">
                        <div style="height:120px; background:#f1f5f9; display:flex; align-items:center; justify-content:center; color:#94a3b8; font-size:11px;">Waiting...</div>
                    </div>
                    <div style="font-weight:600; font-size:12px; margin-top:8px; word-break:break-all;">${file.name}</div>
                    <div class="cat-badge" id="cat-disp-${index}">Category: -</div>
                    <div style="margin-top:5px; font-size:11px; display:flex; align-items:center;">
                        <span class="status-dot dot-grey" id="dot-${index}"></span>
                        <span id="status-${index}">Pending</span>
                    </div>
                    <input type="hidden" id="cat-${index}">
                </td>
                <td>
                    <div class="meta-wrapper">
                        <div class="meta-label">
                            <span>TITLE (50-70 Chars)</span>
                            <span id="cnt-title-${index}">0/70</span>
                        </div>
                        <input type="text" class="meta-input" id="title-${index}" oninput="validate(${index})">
                    </div>

                    <div class="meta-wrapper">
                        <div class="meta-label">
                            <span>DESCRIPTION (100-150 Chars)</span>
                            <span id="cnt-desc-${index}">0/150</span>
                        </div>
                        <textarea class="meta-input" id="desc-${index}" oninput="validate(${index})"></textarea>
                    </div>

                    <div class="meta-wrapper">
                        <div class="meta-label">
                            <span>KEYWORDS (45-48 Words)</span>
                            <span id="cnt-kw-${index}">0 words</span>
                        </div>
                        <textarea class="meta-input" id="kw-${index}" style="min-height:80px;" oninput="validate(${index})"></textarea>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById('statusMsg').innerText = `Siap memproses ${files.length} video.`;
    });

    // --- SMART VALIDATION ---
    function validate(idx) {
        // Title Check
        const tEl = document.getElementById(`title-${idx}`);
        const tCnt = document.getElementById(`cnt-title-${idx}`);
        const tLen = tEl.value.length;
        tCnt.innerText = `${tLen}/70`;
        if(tLen < MIN_TITLE || tLen > MAX_TITLE) {
            tCnt.className = 'count-err'; tEl.classList.add('border-err');
        } else {
            tCnt.className = 'count-ok'; tEl.classList.remove('border-err');
        }

        // Desc Check
        const dEl = document.getElementById(`desc-${idx}`);
        const dCnt = document.getElementById(`cnt-desc-${idx}`);
        const dLen = dEl.value.length;
        dCnt.innerText = `${dLen}/150`;
        if(dLen < MIN_DESC || dLen > MAX_DESC) {
            dCnt.className = 'count-err'; dEl.classList.add('border-err');
        } else {
            dCnt.className = 'count-ok'; dEl.classList.remove('border-err');
        }

        // KW Check
        const kEl = document.getElementById(`kw-${idx}`);
        const kCnt = document.getElementById(`cnt-kw-${idx}`);
        const kws = kEl.value.split(',').filter(x => x.trim().length > 0);
        kCnt.innerText = `${kws.length} words`;
        if(kws.length < MIN_KW || kws.length > MAX_KW) {
            kCnt.className = 'count-err'; kEl.classList.add('border-err');
        } else {
            kCnt.className = 'count-ok'; kEl.classList.remove('border-err');
        }
    }

    // --- AI LOGIC ---
    async function startProcessing() {
        const key = document.getElementById('apiKey').value;
        if(!key) return alert("API Key Required");
        localStorage.setItem('GROQ_KEY', key);

        isProcessing = true;
        document.getElementById('btnProcess').disabled = true;
        
        for(let item of fileQueue) {
            const idx = item.id;
            updateStatus(idx, 'processing', 'Processing...');
            
            try {
                // 1. Snapshot
                const base64 = await getFilmstrip(item.file);
                document.getElementById(`preview-${idx}`).innerHTML = `<img src="${base64}">`;
                
                // 2. AI Request
                const data = await callAI(key, base64);
                
                // 3. Populate & Smart Truncate
                
                // Category
                document.getElementById(`cat-${idx}`).value = data.category;
                document.getElementById(`cat-disp-${idx}`).innerText = data.category;
                
                // Title (Smart Truncate Logic)
                let title = data.title || "";
                if (title.length > MAX_TITLE) {
                    // Potong di spasi terakhir sebelum limit 70 agar kata tidak putus
                    let sub = title.substring(0, MAX_TITLE);
                    let lastSpace = sub.lastIndexOf(" ");
                    if (lastSpace > 50) title = sub.substring(0, lastSpace); // Hanya potong jika sisa > 50
                    else title = sub; // Terpaksa potong jika tidak ada spasi aman
                }
                document.getElementById(`title-${idx}`).value = title;

                // Description (Smart Truncate Logic)
                let desc = data.description || "";
                if (desc.length > MAX_DESC) {
                    let sub = desc.substring(0, MAX_DESC);
                    let lastSpace = sub.lastIndexOf(" ");
                    if (lastSpace > 100) desc = sub.substring(0, lastSpace);
                    else desc = sub;
                }
                document.getElementById(`desc-${idx}`).value = desc;

                // Keywords (Force 48)
                // AI diminta generate 60, kita ambil 48 pertama
                let kws = (data.keywords || "").replace(/\./g, '').split(',');
                let cleanKws = [];
                kws.forEach(k => {
                    let w = k.trim().toLowerCase();
                    if(w.length > 1) cleanKws.push(w);
                });
                cleanKws = [...new Set(cleanKws)]; // Unique
                if (cleanKws.length > MAX_KW) {
                    cleanKws = cleanKws.slice(0, MAX_KW);
                }
                document.getElementById(`kw-${idx}`).value = cleanKws.join(', ');

                updateStatus(idx, 'success', 'Done');
                validate(idx);

            } catch(e) {
                console.error(e);
                updateStatus(idx, 'error', 'Error');
                alert(`Error on file ${item.file.name}: ${e.message}`);
            }

            // Delay 
            await new Promise(r => setTimeout(r, 2000));
        }
        
        isProcessing = false;
        document.getElementById('btnProcess').disabled = false;
        document.getElementById('btnExport').style.display = 'inline-block';
        alert("Selesai!");
    }

    function updateStatus(idx, type, text) {
        const dot = document.getElementById(`dot-${idx}`);
        const lbl = document.getElementById(`status-${idx}`);
        lbl.innerText = text;
        
        dot.className = 'status-dot';
        if(type === 'processing') dot.classList.add('dot-blue');
        if(type === 'success') dot.classList.add('dot-green');
        if(type === 'error') dot.classList.add('dot-red');
    }

    // --- VIDEO SNAPSHOT ---
    function getFilmstrip(file) {
        return new Promise((resolve, reject) => {
            const video = document.getElementById('hiddenVideo');
            const canvas = document.getElementById('hiddenCanvas');
            const ctx = canvas.getContext('2d');
            const url = URL.createObjectURL(file);
            
            video.src = url;
            video.muted = true;
            const w = 320, h = 180;
            canvas.width = w*3; canvas.height = h;

            const snap = (t) => new Promise(r => { video.currentTime=t; video.onseeked=()=>r(); });

            video.onloadedmetadata = async () => {
                try {
                    await snap(video.duration * 0.1);
                    ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, 0, 0, w, h);
                    await snap(video.duration * 0.5);
                    ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, w, 0, w, h);
                    await snap(video.duration * 0.9);
                    ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, w*2, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                    URL.revokeObjectURL(url);
                } catch(e) { reject(e); }
            };
            video.onerror = () => reject(new Error("Video corrupt"));
        });
    }

    // --- AI PROMPT (ENHANCED FOR CONTEXT) ---
    async function callAI(key, base64) {
        const prompt = `
        Role: Senior Microstock Metadata Specialist.
        
        Input: 3 frames of a video (Start, Middle, End).
        
        Task: Analyze the frames to detect content type (Transition, Revealer, Background, etc.) and generate strict metadata.

        STRICT RULES (Do not violate):
        
        1. CATEGORY:
           - Analyze visual flow. 
           - If frames change from Black -> Image -> Black, it is likely 'revealer' or 'transition'.
           - If frames look like a loop, it is 'background'.
           - Pick EXACTLY ONE from this list:
           [${CATEGORIES_LIST}]

        2. TITLE (Length: 50 - 70 chars):
           - Must be a COMPLETE sentence describing the visual.
           - DO NOT truncate words. 
           - If your sentence is > 70 chars, REWRITE IT to be shorter.
           - Example: "Blue Circuit Board Background with Glowing Digital Lines" (54 chars)

        3. DESCRIPTION (Length: 100 - 150 chars):
           - Must be detailed but concise.
           - Describe movement, colors, lighting, and style (3D, Abstract).
           - Must end with a full stop.

        4. KEYWORDS (Quantity: 60 words):
           - Generate 60 single keywords. (I will filter them later).
           - Separate by comma. NO phrases.
           - Include: visual objects, colors, concepts, style (bokeh, 4k, loop).

        OUTPUT JSON ONLY:
        { "category": "string", "title": "string", "description": "string", "keywords": "string" }
        `;

        const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: { "Authorization": `Bearer ${key}`, "Content-Type": "application/json" },
            body: JSON.stringify({
                model: GROQ_MODEL,
                messages: [
                    { role: "system", content: prompt },
                    { role: "user", content: [
                        { type: "text", text: "Analyze frames and output strict JSON." },
                        { type: "image_url", image_url: { url: base64 } }
                    ]}
                ],
                temperature: 0.1,
                response_format: { type: "json_object" }
            })
        });

        const data = await resp.json();
        const content = data.choices[0].message.content;
        
        // JSON Extraction (Robust)
        const first = content.indexOf('{');
        const last = content.lastIndexOf('}');
        return JSON.parse(content.substring(first, last+1));
    }

    // --- EXPORT ---
    function exportCSV() {
        let csv = "Filename,Title,Description,Keywords,Category\n";
        fileQueue.forEach((item, idx) => {
            const row = document.getElementById(`row-${idx}`);
            if(!row.querySelector('.dot-green')) return; // Skip failed

            const fname = `"${item.file.name.replace(/"/g, '""')}"`;
            const tit = `"${document.getElementById(`title-${idx}`).value.replace(/"/g, '""')}"`;
            const desc = `"${document.getElementById(`desc-${idx}`).value.replace(/"/g, '""')}"`;
            const kw = `"${document.getElementById(`kw-${idx}`).value.replace(/"/g, '""')}"`;
            const cat = `"${document.getElementById(`cat-${idx}`).value.replace(/"/g, '""')}"`;
            
            csv += `${fname},${tit},${desc},${kw},${cat}\n`;
        });
        
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `metadata_final_${Date.now()}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>
</body>
</html>
