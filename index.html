<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MICROSTOCK VIDEO METADATA (PROMPT FIXED)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f8fafc; padding: 20px; color: #334155; }
        .container { max-width: 950px; margin: auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        h1 { text-align: center; color: #0f172a; margin-bottom: 30px; font-size: 22px; letter-spacing: 1px; }
        
        .box { border: 2px dashed #cbd5e1; padding: 40px; text-align: center; border-radius: 12px; cursor: pointer; background: #f1f5f9; transition: 0.3s; }
        .box:hover { background: #e2e8f0; border-color: #94a3b8; }
        
        .input-key { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 20px; box-sizing: border-box; }
        
        .btn { background: #0f172a; color: white; padding: 15px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; font-size: 14px; transition: 0.2s; }
        .btn:hover:not(:disabled) { background: #334155; transform: translateY(-1px); }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }

        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th { text-align: left; padding: 15px; background: #f8fafc; color: #64748b; font-size: 12px; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
        
        .thumb { width: 140px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .field-label { font-size: 10px; font-weight: 800; color: #db2777; margin-top: 8px; display: block; letter-spacing: 0.5px; }
        .res-input { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; background: #fdf2f8; font-size: 13px; color: #334155; margin-top: 4px; box-sizing: border-box; font-family: inherit; }
        textarea.res-input { resize: vertical; line-height: 1.4; }

        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; display: inline-block; }
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸŽ¬ MICROSTOCK METADATA GENERATOR</h1>
    
    <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">GROQ API KEY</label>
    <input type="password" id="apiKey" class="input-key" placeholder="Masukkan Key (gsk_...)" value="">

    <div class="box" onclick="document.getElementById('fileInput').click()">
        <div style="font-size: 40px; margin-bottom: 10px;">ðŸ“‚</div>
        <strong>Klik untuk Pilih Video</strong>
        <p style="font-size: 12px; color: #64748b; margin: 5px 0 0 0;">MP4, MOV, AVI (Multiple)</p>
        <input type="file" id="fileInput" multiple accept="video/*" style="display:none" onchange="handleFiles(this.files)">
    </div>

    <div id="actionArea" style="display:none; margin-top: 20px; gap: 10px;">
        <button id="btnProcess" class="btn" onclick="startQueue()">ðŸš€ MULAI PROSES AI</button>
        <button id="btnExport" class="btn" onclick="exportCSV()" style="background: #059669; margin-top: 10px; display:none;">ðŸ“¥ DOWNLOAD CSV FINAL</button>
    </div>

    <table id="resultTable">
        <thead>
            <tr>
                <th width="160">Preview (3 Frames)</th>
                <th>Metadata Result</th>
                <th width="80">Status</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<video id="videoElement" style="display:none" muted playsinline></video>
<canvas id="canvasElement" style="display:none"></canvas>

<script>
    let queue = [];
    // Model Llama 3.2 11B Vision (Gratis & Stabil)
    const MODEL_ID = "llama-3.2-11b-vision-preview"; 

    if(localStorage.getItem('GROQ_KEY_FIX')) document.getElementById('apiKey').value = localStorage.getItem('GROQ_KEY_FIX');

    function handleFiles(files) {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = ''; 
        queue = [];
        
        Array.from(files).forEach((file, index) => {
            if(!file.type.startsWith('video')) return;
            queue.push({ id: index, file: file, data: null });

            const tr = document.createElement('tr');
            tr.id = `row-${index}`;
            tr.innerHTML = `
                <td><div style="width:140px; height:80px; background:#f1f5f9; border-radius:6px;"></div></td>
                <td style="color:#94a3b8; font-style:italic;">Menunggu antrian...</td>
                <td><span class="status-badge" style="background:#f1f5f9; color:#64748b">WAIT</span></td>
            `;
            tbody.appendChild(tr);
        });

        if(queue.length > 0) document.getElementById('actionArea').style.display = 'block';
    }

    async function startQueue() {
        const key = document.getElementById('apiKey').value.trim();
        if(!key) return alert("API Key Kosong!");
        localStorage.setItem('GROQ_KEY_FIX', key);

        const btn = document.getElementById('btnProcess');
        btn.disabled = true;
        btn.innerText = "â³ Sedang Memproses...";

        for (let item of queue) {
            await processItem(item, key);
            // Jeda 2 detik (PENTING: Mencegah Rate Limit Groq)
            await new Promise(r => setTimeout(r, 2000)); 
        }

        btn.innerText = "Selesai!";
        btn.disabled = false;
        document.getElementById('btnExport').style.display = 'block';
    }

    async function processItem(item, key) {
        const row = document.getElementById(`row-${item.id}`);
        const statusSpan = row.cells[2].querySelector('.status-badge');
        
        try {
            statusSpan.innerText = "SNAP...";
            statusSpan.style.background = "#dbeafe";
            statusSpan.style.color = "#1e40af";

            // 1. Ambil 3 Frame (Awal, Tengah, Akhir)
            const base64 = await captureFilmstrip(item.file);
            row.cells[0].innerHTML = `<img src="${base64}" class="thumb"><div style="font-size:10px; margin-top:5px; font-weight:bold;">${item.file.name}</div>`;

            statusSpan.innerText = "AI...";
            
            // 2. Kirim ke Groq dengan Prompt Khusus
            const metadata = await callGroqAPI(key, base64);
            
            // 3. Tampilkan Hasil
            item.data = metadata; 
            
            row.cells[1].innerHTML = `
                <span class="field-label">TITLE (${metadata.title.length} chars)</span>
                <input class="res-input title" value="${metadata.title}">
                
                <span class="field-label">DESCRIPTION</span>
                <textarea class="res-input desc" rows="2">${metadata.description}</textarea>
                
                <span class="field-label">KEYWORDS</span>
                <textarea class="res-input keywords" rows="3">${metadata.keywords}</textarea>
            `;
            
            statusSpan.innerText = "DONE";
            statusSpan.style.background = "#dcfce7";
            statusSpan.style.color = "#166534";

        } catch (e) {
            console.error(e);
            statusSpan.innerText = "ERROR";
            statusSpan.style.background = "#fee2e2";
            statusSpan.style.color = "#991b1b";
            row.cells[1].innerText = `Gagal: ${e.message}`;
        }
    }

    function captureFilmstrip(file) {
        return new Promise((resolve, reject) => {
            const video = document.getElementById('videoElement');
            const canvas = document.getElementById('canvasElement');
            const ctx = canvas.getContext('2d');
            const url = URL.createObjectURL(file);
            
            video.src = url;
            const w = 300; const h = 169; // Low Res untuk API
            canvas.width = w * 3; canvas.height = h;

            video.onloadedmetadata = async () => {
                const d = video.duration;
                // Ambil 3 titik: 10%, 50%, 90%
                const times = [d*0.1, d*0.5, d*0.9];
                
                try {
                    for(let i=0; i<3; i++) {
                        video.currentTime = times[i];
                        await new Promise(r => video.onseeked = r);
                        ctx.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, i*w, 0, w, h);
                    }
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                    URL.revokeObjectURL(url);
                } catch(err) { reject(err); }
            };
            video.onerror = () => reject("Video corrupt");
        });
    }

    async function callGroqAPI(apiKey, base64Image) {
        const cleanBase64 = base64Image.split(',')[1];

        // --- INI BAGIAN PROMPT ENGINEERING YANG DIPERBAIKI ---
        const systemPrompt = `
        You are an expert Microstock Video Contributor. You analyze a filmstrip of 3 frames (Start, Mid, End) to understand the full video motion.
        
        STRICT OUTPUT RULES:
        1. TITLE:
           - MUST be a descriptive sentence between 50 and 80 characters.
           - STRUCTURE: [Subject/Object] [Action/Movement] [Context/Background].
           - FORBIDDEN CHARACTERS: Do NOT use hyphens ("-") or pipes ("|"). Use natural grammar.
           - FORBIDDEN WORDS: "High Quality", "4K", "HD", "Resolution", "Cinematic", "Stock Footage".
           - EXAMPLE GOOD: "Futuristic neon lower thirds animation with glowing lines on dark background"
           - EXAMPLE BAD: "Neon Light - 4k" (Too short, has hyphen)

        2. DESCRIPTION:
           - Write exactly ONE complete, grammatically perfect sentence.
           - Describe what happens in the video from start to finish based on the frames.
           - DO NOT cut off the sentence. End with a period.
           - Mention "animation", "video", or "clip" to define the medium.

        3. KEYWORDS:
           - List 40-50 keywords separated by commas.
           - FORBIDDEN KEYWORDS (Negative Prompt): image, vector, photo, illustration, picture, 4k, 8k, hd, resolution, hq, high quality, royalty free.
           - REQUIRED: Focus on the visual objects, colors, motion type (zoom, pan, loop), and conceptual meaning (e.g., technology, business).

        RETURN ONLY RAW JSON:
        { "title": "...", "description": "...", "keywords": "..." }
        `;

        try {
            const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: MODEL_ID,
                    messages: [
                        { role: "user", content: [
                            { type: "text", text: systemPrompt },
                            { type: "image_url", image_url: { url: `data:image/jpeg;base64,${cleanBase64}` } }
                        ]}
                    ],
                    temperature: 0.1, // Kreativitas rendah agar patuh aturan
                    max_tokens: 500,  // Cukup panjang agar deskripsi tidak kepotong
                    response_format: { type: "json_object" }
                })
            });

            if (!response.ok) throw new Error("API Limit / Error");
            const json = await response.json();
            
            // Pembersih JSON
            let raw = json.choices[0].message.content;
            raw = raw.replace(/```json/g, "").replace(/```/g, "").trim();
            return JSON.parse(raw);

        } catch (e) {
            throw new Error(e.message);
        }
    }

    function exportCSV() {
        let csv = "Filename,Title,Description,Keywords\n";
        queue.forEach((item, index) => {
            const row = document.getElementById(`row-${index}`);
            if(!item.data) return;

            const t = row.querySelector('.title').value;
            const d = row.querySelector('.desc').value;
            const k = row.querySelector('.keywords').value;
            
            // Format CSV Standard
            const rowStr = `"${item.file.name}","${t.replace(/"/g, '""')}","${d.replace(/"/g, '""')}","${k.replace(/"/g, '""')}"`;
            csv += rowStr + "\n";
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "Metadata_Microstock.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>

</body>
</html>
